<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PowerUp — Level Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Your existing assets -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="style.css" rel="stylesheet" />
</head>

<body>
  <!-- PAGE-SPECIFIC CONTENT ONLY -->
  <div class="page-block">
    <div class="header-row">
      <div>
        <div class="title">Level Tracker</div>
        <div class="muted">Filtered to the signed-in user. Boolean/checkbox fields render as ✓ or ✕.</div>
      </div>
    </div>

    <div class="card">
      <div id="level-table-wrap" class="table-wrap">
        <table class="data-table">
          <thead><tr id="level-thead"></tr></thead>
          <tbody id="level-tbody"><tr><td>Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Your existing scripts -->
  <script src="scripts/api.js?v=2025-08-25-a"></script>
  <script src="scripts/session.js?v=2025-08-25-a"></script>
  <script src="scripts/layout.js"></script>

  <script>
    // --- utilities (mirror your existing table rendering style) ---
    function isTrueish(v){
      const t = String(v ?? "").trim().toLowerCase();
      return v === true || t === "true" || t === "yes" || t === "y" || t === "1";
    }
    function boolPill(v){
      // Use the same pill classes already defined in style.css
      return isTrueish(v)
        ? '<span class="pill pill--green">✓</span>'
        : '<span class="pill pill--red">✕</span>';
    }
    function fmtCell(v){
      const t = String(v ?? "").trim().toLowerCase();
      if (v === true || v === false || t === "true" || t === "false" || t === "yes" || t === "no" || t === "1" || t === "0") {
        return boolPill(v);
      }
      return String(v ?? "");
    }
    function eq(a,b){ return String(a||"").trim().toLowerCase() === String(b||"").trim().toLowerCase(); }

    // Choose which columns to show (adjust this list to your liking).
    // If a column doesn't exist, it will be ignored gracefully.
    const DISPLAY_COLUMNS = [
      "Display Name",
      "PowerUp Level (Select)",   // or "PowerUp Level"
      "Mentor",
      "Enrolled PowerUp",
      "Tier 1 Complete",
      "Tier 2 Complete",
      "Tier 3 Complete"
    ];

    async function loadLevelTracker(){
      const raw = await PowerUp.api.fetchSheet(PowerUp.api.SHEETS.LEVEL_TRACKER);
      const rows = PowerUp.api.rowsByTitle(raw); // [{colTitle: value,...}]
      const session = PowerUp.session.get();

      // Filter to signed-in user (by Display Name). If no name, show nothing.
      const userName = session?.displayName || "";
      const filtered = rows.filter(r => eq(r["Display Name"], userName));

      // Build column order: only columns that exist in the sheet
      const sheetCols = (raw.columns || []).map(c => c.title);
      const columns = DISPLAY_COLUMNS.filter(c => sheetCols.includes(c) || sheetCols.includes("PowerUp Level") && c==="PowerUp Level (Select)")
                                     .map(c => (c==="PowerUp Level (Select)" && sheetCols.includes("PowerUp Level")) ? "PowerUp Level" : c);

      // Header
      const thead = document.getElementById("level-thead");
      thead.innerHTML = columns.map(c => `<th>${c}</th>`).join("");

      // Body
      const tbody = document.getElementById("level-tbody");
      if (!filtered.length){
        tbody.innerHTML = `<tr><td colspan="${columns.length}" style="text-align:center;opacity:.7;">No rows</td></tr>`;
        return;
      }

      const html = filtered.map(r => {
        return `<tr>${columns.map(c => `<td>${fmtCell(r[c])}</td>`).join("")}</tr>`;
      }).join("");
      tbody.innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      PowerUp.session.requireLogin();
      PowerUp.layout.injectLayout();          // same header + sidebar as dashboard
      await PowerUp.session.initHeader();     // fill Welcome/Level in header
      await loadLevelTracker();
    });
  </script>
</body>
</html>
