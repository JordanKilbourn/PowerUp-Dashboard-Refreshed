<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PowerUp — Level Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="page-wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div>
        <div class="title">Level Tracker</div>
        <div class="muted">Signed in as <span data-hook="userName">—</span> · <span data-hook="userLevel">—</span></div>
      </div>
    </div>

    <div class="card">
      <div class="table-scroll">
        <table id="ltbl">
          <thead><tr id="lhead"></tr></thead>
          <tbody id="lrows">
            <tr><td class="muted" style="text-align:center;padding:20px;">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== JS ===== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" defer></script>
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/layout.js"></script>
  <script>
    function buildHeader(columns) {
      const tr = document.getElementById('lhead');
      tr.innerHTML = columns.map(c => `<th data-k="${c.title}">${c.title}</th>`).join('');
    }
    function renderRows(columns, rows) {
      const tb = document.getElementById('lrows');
      if (!rows.length) {
        tb.innerHTML = `<tr><td class="muted" style="text-align:center;padding:20px;">No rows</td></tr>`;
        return;
      }
      const html = rows.map(r => {
        const tds = columns.map(c => `<td>${r[c.title] ?? ''}</td>`).join('');
        return `<tr>${tds}</tr>`;
      }).join('');
      tb.innerHTML = html;
    }
    function attachSort(columns) {
      const ths = document.querySelectorAll('#lhead th[data-k]');
      ths.forEach((th, idx) => {
        th.addEventListener('click', () => {
          const key = th.dataset.k;
          const asc = th.dataset.sort !== 'asc';
          ths.forEach(h => h.dataset.sort = '');
          th.dataset.sort = asc ? 'asc' : 'desc';
          const tb = document.getElementById('lrows');
          const rows = Array.from(tb.querySelectorAll('tr'));
          const sorted = rows.sort((a,b) => {
            const av = (a.children[idx]?.textContent || '').trim();
            const bv = (b.children[idx]?.textContent || '').trim();
            const an = parseFloat(av.replace(/[^0-9.\-]/g,'')), bn = parseFloat(bv.replace(/[^0-9.\-]/g,''));
            const numMode = !Number.isNaN(an) && !Number.isNaN(bn) && (/\d/.test(av)||/\d/.test(bv));
            return asc ? (numMode ? an - bn : av.localeCompare(bv))
                       : (numMode ? bn - an : bv.localeCompare(av));
          });
          const frag = document.createDocumentFragment();
          sorted.forEach(tr => frag.appendChild(tr));
          tb.innerHTML = '';
          tb.appendChild(frag);
        });
      });
    }
    async function load() {
      const raw = await PowerUp.api.fetchSheet(PowerUp.api.SHEETS.LEVEL_TRACKER);
      const columns = raw.columns; // Smartsheet column order
      const rows = PowerUp.api.rowsByTitle(raw);
      buildHeader(columns);
      renderRows(columns, rows);
      attachSort(columns);
    }
    document.addEventListener('DOMContentLoaded', async () => {
      PowerUp.session.requireLogin();
      PowerUp.layout.injectLayout();
      await PowerUp.session.initHeader();
      await load();
    });
  </script>
</body>
</html>
