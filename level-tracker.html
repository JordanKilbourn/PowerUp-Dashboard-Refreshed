<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

<!-- EARLY AUTH GUARD — must be the first thing in <head> -->
<script>
!function () {
  try {
    const s = JSON.parse(sessionStorage.getItem('pu.session') || 'null')
           || JSON.parse(localStorage.getItem('powerup_session') || 'null');
    if (!s || !s.employeeId) {
      document.documentElement.style.visibility = 'hidden';
      location.replace('login.html');
    }
  } catch {
    document.documentElement.style.visibility = 'hidden';
    location.replace('login.html');
  }
}();
</script>
  
  <title>PowerUp — Level Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="style.css" rel="stylesheet" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="alternate icon" type="image/png" href="assets/favicon.png">
</head>
<body>
  <div class="page-block">
    <div class="card">
      <div class="table-scroll">
        <table id="lt-table" class="dashboard-table">
          <thead><tr id="lt-thead"></tr></thead>
          <tbody id="lt-tbody"><tr><td>Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

<script src="scripts/api.js"></script>
<script src="scripts/session.js"></script>
<script src="scripts/roles.js"></script>
<script src="scripts/layout.js"></script>

<script>
  const IS_ADMIN = !!(window.PowerUp?.auth?.isAdmin && PowerUp.auth.isAdmin());

  // ---- Desired columns (display header -> sheet column) ----
  const COLS = [
    { label: "Month",   sources: ["Month Key","Month"] },
    ...(IS_ADMIN ? [{ label: "Employee", sources: ["Display Name","Employee Name","Name"] }] : []),
    { label: "CI Submissions",            sources: ["CI Submissions"] },
    { label: "Safety Submissions",        sources: ["Safety Submissions"] },
    { label: "Quality Submissions",       sources: ["Quality Submissions"] },
    { label: "Total Submissions",         sources: ["Total Submissions"] },
    { label: "Tuesday Tutorial Attended", sources: ["Tuesday Tutorial Attended"] },
    { label: "Power Hours Logged",        sources: ["Power Hours Logged"] },
    { label: "On Team",                   sources: ["On Team"] },
    { label: "Leads Team",                sources: ["Leads Team"] },
    { label: "Job Relations Follow-up",   sources: ["Job Relations Follow-up"] }
  ];

  // ==== helpers ====
  const esc = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const isTrueish = (v) => { const t = String(v ?? "").trim().toLowerCase(); return v === true || t === "true" || t === "yes"; };
  const boolPill = (v) => isTrueish(v) ? '<span class="pill pill--green">✓</span>' : '<span class="pill pill--red">✗</span>';

  // sortable header binding (same feel as dashboard)
  function bindHeaderSort(thead, tbody){
    let state = { col: 0, asc: true };
    const applyIndicators = () => {
      thead.querySelectorAll("th").forEach((h,i)=>{
        h.setAttribute("data-sort","none");
        h.removeAttribute("aria-sort");
        if (i===state.col){
          h.setAttribute("data-sort", state.asc ? "asc":"desc");
          h.setAttribute("aria-sort", state.asc ? "ascending":"descending");
        }
      });
    };
    thead.querySelectorAll("th").forEach((th, idx)=>{
      th.style.cursor = "pointer";
      th.onclick = () => {
        state.asc = state.col === idx ? !state.asc : true;
        state.col = idx;
        const rows = Array.from(tbody.querySelectorAll("tr"));
        rows.sort((ra, rb)=>{
          const a = ra.children[idx]?.getAttribute("data-sort") ?? "";
          const b = rb.children[idx]?.getAttribute("data-sort") ?? "";
          const na = Number(a), nb = Number(b);
          const bothNum = !isNaN(na) && !isNaN(nb);
          const cmp = bothNum ? (na - nb) : a.localeCompare(b);
          return state.asc ? cmp : -cmp;
        });
        rows.forEach(r => tbody.appendChild(r));
        applyIndicators();
      };
    });
    applyIndicators();
  }

  function fmtCell(v){
    const t = String(v ?? "").trim().toLowerCase();
    if (v === true || v === false || t === "true" || t === "false" || t === "yes" || t === "no") return boolPill(v);
    return (v == null || String(v).trim() === "") ? "-" : esc(v);
  }

  function fmtMonth(v){
    if (v == null || String(v).trim() === "") return "-";
    const s = String(v).trim();

    let m = s.match(/^(\d{4})-(\d{1,2})(?:-(\d{1,2}))?$/);
    if (m) {
      const y = +m[1], mo = +m[2], d = +(m[3] || 1);
      const dt = new Date(y, mo - 1, d);
      return dt.toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
    }

    m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
    if (m) {
      let y = +m[3]; if (y < 100) y += 2000;
      const mo = +m[1], d = +m[2];
      const dt = new Date(y, mo - 1, d);
      return dt.toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
    }

    const parsed = new Date(s);
    if (!isNaN(parsed)) {
      const dt = new Date(parsed.getUTCFullYear(), parsed.getUTCMonth(), 1);
      return dt.toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
    }
    return esc(v);
  }

  const normalize = (s) => String(s||"").toLowerCase().replace(/[^a-z0-9]/g,"");
  function chooseIdColumn(cols){ if (cols.includes("Employee ID")) return "Employee ID"; if (cols.includes("Position ID")) return "Position ID"; return null; }
  function resolveSheetColumn(sources, sheetCols){
    for (const s of sources) if (sheetCols.includes(s)) return s;
    const byNorm = new Map(sheetCols.map(c => [normalize(c), c]));
    for (const s of sources){ const hit = byNorm.get(normalize(s)); if (hit) return hit; }
    return null;
  }

  function getAdminSelectedName(){
    return sessionStorage.getItem('pu.adminEmployeeFilter') || '__ALL__';
  }

  async function loadLevelTracker(){
    PowerUp.session.requireLogin();
    const me = PowerUp.session.get() || {};
    const myId = String(me.employeeId || '').trim();

    const raw  = await PowerUp.api.fetchSheet(PowerUp.api.SHEETS.LEVEL_TRACKER);
    const rows = PowerUp.api.rowsByTitle(raw);
    const sheetCols = (raw.columns || []).map(c => c.title);
    const idCol = chooseIdColumn(sheetCols);
    if (!rows.length || !idCol){
      document.getElementById("lt-tbody").innerHTML = `<tr><td>-</td></tr>`;
      return;
    }

    let view = rows;
    if (IS_ADMIN) {
      const sel = getAdminSelectedName();
      if (sel && sel !== '__ALL__') {
        const nameCols = ['Display Name','Employee Name','Name','Submitted By'].filter(c => sheetCols.includes(c));
        view = rows.filter(r => {
          const nameHit = nameCols.some(c => String(r[c] || '').trim() === sel);
          const idHit = String(r[idCol] || '').trim() === sel;
          return nameHit || idHit;
        });
      }
    } else {
      view = rows.filter(r => String(r[idCol]||"").trim() === myId);
    }

    const thead = document.getElementById("lt-thead");
    const tbody = document.getElementById("lt-tbody");

    if (!view.length){
      thead.innerHTML = COLS.map(c => `<th>${c.label}</th>`).join("");
      tbody.innerHTML = `<tr><td class="muted" style="text-align:center;padding:20px;">No rows match the current filter.</td></tr>`;
      return;
    }

    const resolved = COLS.map(c => ({ label: c.label, sheet: resolveSheetColumn(c.sources, (raw.columns||[]).map(c=>c.title)) }));
    thead.innerHTML = resolved.map(c => `<th>${c.label}</th>`).join("");

    // Build id->name map for admin Employee column fallback
    let nameById = {};
    if (IS_ADMIN) {
      try {
        const emRaw = await PowerUp.api.fetchSheet(PowerUp.api.SHEETS.EMPLOYEE_MASTER);
        const em = PowerUp.api.rowsByTitle(emRaw);
        em.forEach(r => {
          const id = String(r["Position ID"] || r["Employee ID"] || "").trim();
          const nm = String(r["Display Name"] || r["Employee Name"] || r["Name"] || "").trim();
          if (id) nameById[id] = nm;
        });
      } catch {}
    }

    tbody.innerHTML = view.map(r => {
      return `<tr>${
        resolved.map(c => {
          let v = c.sheet ? r[c.sheet] : "";
          let sortVal = String(v ?? "").toLowerCase();

          if (c.label === "Month") {
            const s = String(v||"").trim();
            let key = s;
            const d = new Date(s);
            if (!isNaN(d)) key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            sortVal = key;
            return `<td data-sort="${sortVal}">${fmtMonth(v)}</td>`;
          }
          if (c.label === "Employee") {
            const id = String(r["Employee ID"] || r["Position ID"] || "").trim();
            const nm = v || nameById[id] || id || "-";
            sortVal = String(nm).toLowerCase();
            return `<td data-sort="${sortVal}">${fmtCell(nm)}</td>`;
          }

          const num = Number(String(v).replace(/[^0-9.\-]/g,''));
          if (!Number.isNaN(num) && String(v).trim() !== "") sortVal = String(num);
          return `<td data-sort="${sortVal}">${fmtCell(v)}</td>`;
        }).join("")
      }</tr>`;
    }).join("");

    bindHeaderSort(thead.parentElement.querySelector('tr'), tbody);
  }

  // --- make sure we react immediately to Admin filter changes, regardless of emitter ---
  let _lastAdminSel = sessionStorage.getItem('pu.adminEmployeeFilter') || '__ALL__';
  function watchAdminFilter(){
    const now = sessionStorage.getItem('pu.adminEmployeeFilter') || '__ALL__';
    if (now !== _lastAdminSel) {
      _lastAdminSel = now;
      loadLevelTracker();
    }
    // run cheap check ~3 times per second; stops if page is hidden to avoid work
    if (!document.hidden) window.setTimeout(watchAdminFilter, 350);
    else window.setTimeout(watchAdminFilter, 800);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    PowerUp.layout.injectLayout();
    await PowerUp.session.initHeader();

    // compatible with either event name; some older headers may use a different one
    window.addEventListener('powerup-admin-filter-change', () => loadLevelTracker());
    window.addEventListener('pu-admin-filter-change', () => loadLevelTracker());

    watchAdminFilter(); // fallback watcher (cheap) so UI always updates
    await loadLevelTracker();
  });
</script>

</body>
</html>
