<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PowerUp — Level Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Your existing assets -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="style.css" rel="stylesheet" />
</head>

<body>
  <!-- Page content only (header/sidebar are injected by scripts/layout.js) -->
  <div class="page-block">
    <div class="header-row">
      <div>
        <div class="title">Level Tracker</div>
        <div class="muted" id="lt-status">Filtering by Employee ID…</div>
      </div>
    </div>

    <div class="card">
      <div id="level-table-wrap" class="table-wrap">
        <table class="data-table">
          <thead><tr id="level-thead"></tr></thead>
          <tbody id="level-tbody"><tr><td>Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Your existing scripts -->
  <script src="scripts/api.js?v=2025-08-26"></script>
  <script src="scripts/session.js?v=2025-08-26"></script>
  <script src="scripts/layout.js"></script>

  <script>
    // Columns to show (only rendered if they exist on the sheet)
    const DISPLAY_COLUMNS = [
      "Employee ID",
      "Display Name",
      "PowerUp Level",
      "Mentor",
      "Enrolled PowerUp",
      "Tier 1 Complete",
      "Tier 2 Complete",
      "Tier 3 Complete"
    ];

    // Reuse your pill visual for booleans
    function isTrueish(v){
      const t = String(v ?? "").trim().toLowerCase();
      return v === true || t === "true" || t === "yes" || t === "y" || t === "1";
    }
    function boolPill(v){
      return isTrueish(v)
        ? '<span class="pill pill--green">✓</span>'
        : '<span class="pill pill--red">✕</span>';
    }
    function fmtCell(v){
      const t = String(v ?? "").trim().toLowerCase();
      if (v === true || v === false || ["true","false","yes","no","1","0"].includes(t)) return boolPill(v);
      return String(v ?? "");
    }

    function chooseIdColumn(sheetCols){
      // Exactly how your dashboard does it
      if (sheetCols.includes("Employee ID")) return "Employee ID";
      if (sheetCols.includes("Position ID")) return "Position ID";
      return null;
    }

    async function loadLevelTracker(){
      try{
        // 1) Require session and get the employeeId just like your dashboard code
        const { employeeId } = PowerUp.session.get() || {};
        if (!employeeId){
          document.getElementById("lt-status").textContent = "No employeeId in session. Please sign in.";
          document.getElementById("level-tbody").innerHTML =
            `<tr><td style="opacity:.7;">No rows</td></tr>`;
          return;
        }

        // 2) Fetch sheet + rows (your api.js helpers)
        const raw   = await PowerUp.api.fetchSheet(PowerUp.api.SHEETS.LEVEL_TRACKER);
        const rows  = PowerUp.api.rowsByTitle(raw);
        const sheetCols = (raw.columns || []).map(c => c.title);

        // 3) Pick ID column and filter (same rule as dashboard: Employee ID OR Position ID)
        const idCol = chooseIdColumn(sheetCols);
        if (!idCol){
          document.getElementById("lt-status").textContent =
            "This sheet has neither 'Employee ID' nor 'Position ID'.";
          document.getElementById("level-tbody").innerHTML =
            `<tr><td style="opacity:.7;">No rows</td></tr>`;
          return;
        }
        const mine = rows.filter(r => String(r[idCol] || "").trim() === String(employeeId).trim());

        // 4) Decide visible columns (only those present)
        let cols = DISPLAY_COLUMNS.filter(c => sheetCols.includes(c));
        if (!cols.length && rows.length) cols = Object.keys(rows[0]).slice(0, 8);
        document.getElementById("level-thead").innerHTML = cols.map(c => `<th>${c}</th>`).join("");

        // 5) Render
        if (!mine.length){
          document.getElementById("lt-status").textContent =
            `No rows for Employee ID ${employeeId} (column “${idCol}”).`;
          document.getElementById("level-tbody").innerHTML =
            `<tr><td colspan="${cols.length}" style="text-align:center;opacity:.7;">No rows</td></tr>`;
          return;
        }

        document.getElementById("lt-status").textContent = `Filtered by ${idCol}: ${employeeId}`;
        const html = mine.map(r => `<tr>${cols.map(c => `<td>${fmtCell(r[c])}</td>`).join('')}</tr>`).join('');
        document.getElementById("level-tbody").innerHTML = html;

      }catch(err){
        console.error("[LevelTracker] error", err);
        document.getElementById("lt-status").textContent = "Error loading Level Tracker.";
        document.getElementById("level-tbody").innerHTML =
          `<tr><td style="color:#f88;">${(err && err.message) || String(err)}</td></tr>`;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      PowerUp.session.requireLogin();
      PowerUp.layout.injectLayout();      // identical header + sidebar as dashboard
      await PowerUp.session.initHeader();
      await loadLevelTracker();
    });
  </script>
</body>
</html>
