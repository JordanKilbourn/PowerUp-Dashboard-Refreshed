<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

<!-- Early auth guard (tolerant) -->
<script>
!function () {
  try {
    // Try canonical key first; fall back to a couple older patterns
    const raw =
      localStorage.getItem('powerup_session') ||
      localStorage.getItem('PowerUp.session') ||
      null;

    const s = raw && JSON.parse(raw);

    // Accept employeeId or common legacy shapes
    const id = s && (s.employeeId || s.empId || s.id);
    if (id) return; // let the page render normally

    // No usable session → prevent paint and bounce
    document.documentElement.style.visibility = 'hidden';
    location.replace('login.html');
  } catch {
    document.documentElement.style.visibility = 'hidden';
    location.replace('login.html');
  }
}();
</script>


  
  <title>PowerUp — Level Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="style.css" rel="stylesheet" />
</head>
<body>
  <div class="page-block">
    <div class="card">
      <div class="table-scroll">
        <table id="lt-table" class="dashboard-table">
          <thead><tr id="lt-thead"></tr></thead>
          <tbody id="lt-tbody"><tr><td>Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="scripts/api.js?v=2025-08-26"></script>
  <script src="scripts/session.js?v=2025-08-26"></script>
  <script src="scripts/roles.js"></script> 
  <script src="scripts/layout.js"></script>

 <script>
  // ---- Desired columns (display header -> sheet column) ----
  const COLS = [
    { label: "Month",   sources: ["Month Key","Month"] },
    { label: "CI Submissions",            sources: ["CI Submissions"] },
    { label: "Safety Submissions",        sources: ["Safety Submissions"] },
    { label: "Quality Submissions",       sources: ["Quality Submissions"] },
    { label: "Total Submissions",         sources: ["Total Submissions"] },
    { label: "Tuesday Tutorial Attended", sources: ["Tuesday Tutorial Attended"] },
    { label: "Power Hours Logged",        sources: ["Power Hours Logged"] },
    { label: "On Team",                   sources: ["On Team"] },
    { label: "Leads Team",                sources: ["Leads Team"] },
    { label: "Job Relations Follow-up",   sources: ["Job Relations Follow-up"] }
  ];

  // ==== helpers ====
  const esc = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const isTrueish = (v) => { const t = String(v ?? "").trim().toLowerCase(); return v === true || t === "true" || t === "yes"; };
  const boolPill = (v) => isTrueish(v) ? '<span class="pill pill--green">✓</span>' : '<span class="pill pill--red">✗</span>';

  // Only treat explicit boolean words as boolean; numbers like 1/0 stay numbers
  function fmtCell(v){
    const t = String(v ?? "").trim().toLowerCase();
    if (v === true || v === false || t === "true" || t === "false" || t === "yes" || t === "no") return boolPill(v);
    return (v == null || String(v).trim() === "") ? "-" : esc(v);
  }

 // Month formatter: "Aug 2025" without timezone drift
function fmtMonth(v){
  if (v == null || String(v).trim() === "") return "-";
  const s = String(v).trim();

  // ISO "YYYY-MM" or "YYYY-MM-DD" -> build local date (no UTC shift)
  let m = s.match(/^(\d{4})-(\d{1,2})(?:-(\d{1,2}))?$/);
  if (m) {
    const y = +m[1], mo = +m[2], d = +(m[3] || 1);
    const dt = new Date(y, mo - 1, d);          // local time
    return dt.toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
  }

  // Slash "MM/DD/YY" or "MM/DD/YYYY" -> build local date
  m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
  if (m) {
    let y = +m[3]; if (y < 100) y += 2000;
    const mo = +m[1], d = +m[2];
    const dt = new Date(y, mo - 1, d);          // local time
    return dt.toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
  }

  // Fallback: if Date() parses it, use UTC parts to avoid month underflow
  const parsed = new Date(s);
  if (!isNaN(parsed)) {
    const dt = new Date(parsed.getUTCFullYear(), parsed.getUTCMonth(), 1);
    return dt.toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
  }

  // Unknown format -> show raw
  return esc(v);
}

  const normalize = (s) => String(s||"").toLowerCase().replace(/[^a-z0-9]/g,"");
  function chooseIdColumn(cols){ if (cols.includes("Employee ID")) return "Employee ID"; if (cols.includes("Position ID")) return "Position ID"; return null; }
  function resolveSheetColumn(sources, sheetCols){
    for (const s of sources) if (sheetCols.includes(s)) return s;
    const byNorm = new Map(sheetCols.map(c => [normalize(c), c]));
    for (const s of sources){ const hit = byNorm.get(normalize(s)); if (hit) return hit; }
    return null;
  }

  async function loadLevelTracker(){
    PowerUp.session.requireLogin();
    const { employeeId } = PowerUp.session.get() || {};
    if (!employeeId){ document.getElementById("lt-tbody").innerHTML = `<tr><td>-</td></tr>`; return; }

    const raw  = await PowerUp.api.fetchSheet(PowerUp.api.SHEETS.LEVEL_TRACKER);
    const rows = PowerUp.api.rowsByTitle(raw);
    const sheetCols = (raw.columns || []).map(c => c.title);
    const idCol = chooseIdColumn(sheetCols);
    if (!rows.length || !idCol){ document.getElementById("lt-tbody").innerHTML = `<tr><td>-</td></tr>`; return; }

    const mine = rows.filter(r => String(r[idCol]||"").trim() === String(employeeId).trim());
    if (!mine.length){ document.getElementById("lt-tbody").innerHTML = `<tr><td>-</td></tr>`; return; }

    const resolved = COLS.map(c => ({ label: c.label, sheet: resolveSheetColumn(c.sources, sheetCols) }));
    document.getElementById("lt-thead").innerHTML = resolved.map(c => `<th>${c.label}</th>`).join("");

    document.getElementById("lt-tbody").innerHTML = mine.map(r => {
      return `<tr>${
        resolved.map(c => {
          const v = c.sheet ? r[c.sheet] : "";
          if (c.label === "Month") return `<td>${fmtMonth(v)}</td>`;
          return `<td>${fmtCell(v)}</td>`;
        }).join("")
      }</tr>`;
    }).join("");
  }

  document.addEventListener('DOMContentLoaded', async () => {
    PowerUp.layout.injectLayout();
    await PowerUp.session.initHeader();
    await loadLevelTracker();
  });
</script>

</body>
</html>






