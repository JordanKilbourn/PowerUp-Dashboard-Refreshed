<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PowerUp — Level Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Your existing assets -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="style.css" rel="stylesheet" />
</head>

<body>
  <!-- Content only; header/sidebar injected by scripts/layout.js -->
  <div class="page-block">
    <div class="header-row">
      <div>
        <div class="title">Level Tracker</div>
        <div class="muted" id="lt-status">Filtering…</div>
      </div>
    </div>

    <div class="card">
      <div id="level-table-wrap" class="table-wrap">
        <table class="data-table">
          <thead><tr id="level-thead"></tr></thead>
          <tbody id="level-tbody"><tr><td>Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Your existing scripts -->
  <script src="scripts/api.js?v=2025-08-26"></script>
  <script src="scripts/session.js?v=2025-08-26"></script>
  <script src="scripts/layout.js"></script>

  <script>
    /************ DESIRED COLUMNS IN FINAL ORDER (display names) ************/
    const DESIRED_COLS = [
      "CI Submissions",
      "Safety Submissions",
      "Quality Submissions",
      "Total Submissions",
      "Tuesday Tutorial Attended",
      "Power Hours Logged",
      "On Team",
      "Leads Team",
      "Job Relations Follow-up"
    ];
    /************************************************************************/

    // === helpers (match your dashboard behavior) ===
    function isTrueish(v){
      const t = String(v ?? "").trim().toLowerCase();
      return v === true || t === "true" || t === "yes" || t === "y" || t === "1";
    }
    function boolPill(v){
      return isTrueish(v)
        ? '<span class="pill pill--green">✓</span>'
        : '<span class="pill pill--red">✕</span>';
    }
    function fmtCell(v){
      const t = String(v ?? "").trim().toLowerCase();
      if (v === true || v === false || ["true","false","yes","no","1","0"].includes(t)) return boolPill(v);
      return String(v ?? "");
    }
    function normalize(s){ return String(s||"").toLowerCase().replace(/[^a-z0-9]/g, ""); }

    function chooseIdColumn(sheetCols){
      if (sheetCols.includes("Employee ID")) return "Employee ID";
      if (sheetCols.includes("Position ID")) return "Position ID";
      return null;
    }

    // map desired display headers -> actual sheet column titles
    function resolveColumns(desiredList, sheetCols){
      const byNorm = new Map(sheetCols.map(c => [normalize(c), c]));
      const resolved = [];
      const missing = [];
      for (const want of desiredList){
        const direct = sheetCols.includes(want) ? want : null;
        if (direct){ resolved.push({ display: want, sheet: want }); continue; }
        const alt = byNorm.get(normalize(want));
        if (alt){ resolved.push({ display: want, sheet: alt }); continue; }
        resolved.push({ display: want, sheet: null });
        missing.push(want);
      }
      return { resolved, missing };
    }

    async function loadLevelTracker(){
      try{
        // session has employeeId (your session.js)
        const { employeeId } = PowerUp.session.get() || {};
        if (!employeeId){
          document.getElementById("lt-status").textContent = "No employeeId in session. Please sign in.";
          document.getElementById("level-tbody").innerHTML = `<tr><td style="opacity:.7;">No rows</td></tr>`;
          return;
        }

        const raw  = await PowerUp.api.fetchSheet(PowerUp.api.SHEETS.LEVEL_TRACKER);
        const rows = PowerUp.api.rowsByTitle(raw);
        const sheetCols = (raw.columns || []).map(c => c.title);
        const idCol = chooseIdColumn(sheetCols);

        if (!rows.length){
          document.getElementById("lt-status").textContent = "No data returned from Level Tracker sheet.";
          document.getElementById("level-tbody").innerHTML = `<tr><td style="opacity:.7;">No rows</td></tr>`;
          return;
        }
        if (!idCol){
          document.getElementById("lt-status").textContent = "Sheet missing 'Employee ID'/'Position ID' column.";
          document.getElementById("level-tbody").innerHTML = `<tr><td style="opacity:.7;">No rows</td></tr>`;
          return;
        }

        // Filter to signed-in employee (exact match, same as dashboard tables)
        const mine = rows.filter(r => String(r[idCol] || "").trim() === String(employeeId).trim());

        // Resolve desired column headers to actual sheet titles
        const { resolved, missing } = resolveColumns(DESIRED_COLS, sheetCols);
        // Build the table header using the display names (even if mapped to a slightly different sheet title)
        document.getElementById("level-thead").innerHTML =
          resolved.map(({display}) => `<th>${display}</th>`).join("");

        // Status line
        document.getElementById("lt-status").textContent =
          `Filtered by ${idCol}: ${employeeId}` + (missing.length ? ` — Missing columns: ${missing.join(", ")}` : "");

        if (!mine.length){
          document.getElementById("level-tbody").innerHTML =
            `<tr><td colspan="${resolved.length}" style="text-align:center;opacity:.7;">No rows</td></tr>`;
          return;
        }

        // Render rows in requested order; blanks for any unresolved columns
        const html = mine.map(r => {
          return `<tr>${
            resolved.map(({sheet}) => {
              const v = sheet ? r[sheet] : "";
              return `<td>${fmtCell(v)}</td>`;
            }).join("")
          }</tr>`;
        }).join("");
        document.getElementById("level-tbody").innerHTML = html;

      }catch(err){
        console.error("[LevelTracker] error", err);
        document.getElementById("lt-status").textContent = "Error loading Level Tracker.";
        document.getElementById("level-tbody").innerHTML =
          `<tr><td style="color:#f88;">${(err && err.message) || String(err)}</td></tr>`;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      PowerUp.session.requireLogin();
      PowerUp.layout.injectLayout();      // same header + sidebar as dashboard
      await PowerUp.session.initHeader();
      await loadLevelTracker();
    });
  </script>
</body>
</html>
