<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script>
  !function () {
    try {
      const s = JSON.parse(sessionStorage.getItem('pu.session') || 'null')
                 || JSON.parse(localStorage.getItem('powerup_session') || 'null');
      if (!s || !s.employeeId) {
        document.documentElement.style.visibility = 'hidden';
        location.replace('login.html');
      }
    } catch {
      document.documentElement.style.visibility = 'hidden';
      location.replace('login.html');
    }
  }();
  </script>

  <title>PowerUp — Squads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="preconnect" href="https://powerup-proxy.onrender.com" crossorigin>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">

  <style>
   /* Existing styles omitted for brevity — same as yours above */

   /* === Add Squad Modal Styling === */
   .modal {
     display: none;
     position: fixed;
     z-index: 1000;
     left: 0;
     top: 0;
     width: 100%;
     height: 100%;
     overflow: auto;
     background-color: rgba(0, 0, 0, 0.7);
     justify-content: center;
     align-items: center;
   }
   .modal.show { display: flex; }

   .modal .panel {
     background: var(--card-bg);
     border: 1px solid #2d3f3f;
     border-radius: 10px;
     width: 460px;
     max-width: 95%;
     padding: 20px 24px;
     box-shadow: 0 0 12px rgba(0,0,0,0.4);
   }

   .modal h3 {
     color: var(--accent);
     font-size: 20px;
     font-weight: 700;
     margin-bottom: 12px;
   }

   .modal .row {
     display: flex;
     flex-direction: column;
     margin-bottom: 12px;
   }

   .modal label {
     font-weight: 600;
     color: var(--text);
     font-size: 14px;
     margin-bottom: 4px;
   }

   .modal input,
   .modal select,
   .modal textarea {
     padding: 8px 10px;
     border-radius: 6px;
     border: 1px solid #2d3f3f;
     background: #122;
     color: var(--text);
     font-family: inherit;
   }

   .modal textarea { resize: vertical; min-height: 60px; }

   .modal .actions {
     display: flex;
     justify-content: flex-end;
     gap: 8px;
     margin-top: 16px;
   }

   .modal .btn {
     padding: 8px 14px;
     border-radius: 6px;
     border: 1px solid var(--accent);
     background: var(--card-bg);
     color: var(--text);
     cursor: pointer;
   }
   .modal .btn:hover { background: var(--card-bg-hover); }

   .multi-select {
     height: 90px;
     overflow-y: auto;
   }

  </style>
</head>
<body>
  <!-- layout.js injects the shell -->

  <!-- Filter Toolbar -->
  <div class="filter-toolbar">
    <div class="ft-left">
      <div class="cat-pills" id="cat-pills"></div>
      <label class="toggle"><input type="checkbox" id="myOnly" checked /> My squads</label>
      <label class="toggle"><input type="checkbox" id="activeOnly" /> Active only</label>
      <div class="ft-search">
        <input id="search" type="search" placeholder="Search name, leader, focus…" />
      </div>
    </div>
    <div class="ft-right">
      <button id="btn-add" class="btn"><i class="fa fa-plus"></i> Add New Squad</button>
      <button id="btn-manage" class="btn"><i class="fa fa-table-list"></i> Manage Squads</button>
      <button id="btn-activities" class="btn"><i class="fa fa-list-check"></i> View All Activities</button>
    </div>
  </div>

  <!-- Main Grid -->
  <main class="squads-main">
    <h2 class="section-h">Squads Overview</h2>
    <div class="squads-card">
      <div class="squads-scroll">
        <div id="cards" class="cards-grid"></div>
      </div>
    </div>
    <div id="s-msg" class="empty" style="display:none;"></div>
  </main>

  <!-- === Add New Squad Modal === -->
  <div id="modal-add-squad" class="modal">
    <div class="panel">
      <h3><i class="fa fa-users"></i> Create New Squad</h3>

      <div class="row">
        <label>Squad Name *</label>
        <input type="text" id="squad-name" placeholder="Enter squad name" />
      </div>

      <div class="row">
        <label>Category *</label>
        <select id="squad-category">
          <option value="CI">CI</option>
          <option value="Safety">Safety</option>
          <option value="Quality">Quality</option>
          <option value="Training">Training</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="row">
        <label>Objective</label>
        <textarea id="squad-objective" placeholder="Describe the squad's purpose..."></textarea>
      </div>

      <div class="row">
        <label>Leaders</label>
        <select id="squad-leaders" multiple class="multi-select"></select>
      </div>

      <div class="row">
        <label>Members</label>
        <select id="squad-members" multiple class="multi-select"></select>
      </div>

      <div class="row">
        <label><input type="checkbox" id="squad-active" checked /> Active</label>
      </div>

      <div class="actions">
        <button class="btn" onclick="closeAddSquad()">Cancel</button>
        <button class="btn" id="create-squad-btn"><i class="fa fa-check"></i> Create Squad</button>
      </div>
    </div>
  </div>

<script src="scripts/api.js"></script>
<script src="scripts/session.js"></script>
<script src="scripts/roles.js"></script>
<script src="scripts/layout.js"></script>
<script src="scripts/squads-cards.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  PowerUp.session.requireLogin();
  if (!document.getElementById('pu-header')) PowerUp.layout.injectLayout();
  PowerUp.layout.setPageTitle('PowerUp — Squads');
  await PowerUp.session.initHeader();

  // Event listener for Add New Squad button
  document.getElementById('btn-add').addEventListener('click', openAddSquad);

  // Populate leaders/members dropdowns
  const employees = await PowerUp.getEmployees?.() || [];
  const leaderSel = document.getElementById('squad-leaders');
  const memberSel = document.getElementById('squad-members');

  employees.forEach(emp => {
    const opt1 = document.createElement('option');
    opt1.value = emp.name;
    opt1.textContent = emp.name;
    leaderSel.appendChild(opt1);

    const opt2 = document.createElement('option');
    opt2.value = emp.name;
    opt2.textContent = emp.name;
    memberSel.appendChild(opt2);
  });

  document.getElementById('create-squad-btn').addEventListener('click', saveNewSquad);
});

function openAddSquad() {
  document.getElementById('modal-add-squad').classList.add('show');
}

function closeAddSquad() {
  document.getElementById('modal-add-squad').classList.remove('show');
}

async function saveNewSquad() {
  const name = document.getElementById('squad-name').value.trim();
  const category = document.getElementById('squad-category').value;
  const objective = document.getElementById('squad-objective').value.trim();
  const leaders = Array.from(document.getElementById('squad-leaders').selectedOptions).map(o => o.value);
  const members = Array.from(document.getElementById('squad-members').selectedOptions).map(o => o.value);
  const active = document.getElementById('squad-active').checked;

  if (!name) return alert('Please enter a squad name.');

  // Generate new Squad ID (e.g., SQ-013)
  const squads = await PowerUp.getSquads?.() || [];
  const ids = squads.map(s => parseInt(s.id?.replace('SQ-', '')) || 0);
  const newId = 'SQ-' + String(Math.max(...ids, 0) + 1).padStart(3, '0');
  const today = new Date().toLocaleDateString();

  // Write new Squad
  await PowerUp.addSquad({
    "Squad ID": newId,
    "Squad Name": name,
    "Category": category,
    "Objective": objective,
    "Active": active,
    "Created Date": today
  });

  // Write leaders
  for (const leader of leaders) {
    const emp = await PowerUp.findEmployeeByName?.(leader);
    await PowerUp.addSquadMember({
      "Squad ID": newId,
      "Squad Name": name,
      "Employee ID": emp?.id || '',
      "Employee Name": leader,
      "Role": "Leader",
      "Active": true
    });
  }

  // Write members
  for (const member of members) {
    const emp = await PowerUp.findEmployeeByName?.(member);
    await PowerUp.addSquadMember({
      "Squad ID": newId,
      "Squad Name": name,
      "Employee ID": emp?.id || '',
      "Employee Name": member,
      "Role": "Member",
      "Active": true
    });
  }

  closeAddSquad();
  alert(`✅ Squad "${name}" created successfully!`);
  location.reload();
}
</script>
</body>
</html>
