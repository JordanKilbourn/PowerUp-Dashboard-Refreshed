<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- EARLY AUTH GUARD — must be the first thing in <head> -->
  <script>
  !function () {
    try {
      const s = JSON.parse(sessionStorage.getItem('pu.session') || 'null')
             || JSON.parse(localStorage.getItem('powerup_session') || 'null');
      if (!s || !s.employeeId) {
        document.documentElement.style.visibility = 'hidden';
        location.replace('login.html');
      }
    } catch {
      document.documentElement.style.visibility = 'hidden';
      location.replace('login.html');
    }
  }();
  </script>

  <title>PowerUp — Dashboard</title>

  <!-- Fonts / Icons / Base styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css?v=2025-09-11-a" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="alternate icon" type="image/png" href="assets/favicon.png">

<style>
  /* View column/button */
/* View column/button — match style.css and make it visible */
.view-col, .view-cell { width: 80px; min-width: 80px; text-align: center; }

/* Style the legacy <button class="btn small">View</button> ONLY in the first cell,
   and also support .view-btn if you switch later. */
#ci-table td:first-child .btn.small,
#safety-table td:first-child .btn.small,
#quality-table td:first-child .btn.small,
.view-btn {
  display: inline-flex; align-items: center; justify-content: center;
  padding: 4px 10px; border-radius: 8px;
  border: 1.5px solid var(--accent) !important;
  color: var(--accent) !important;
  background: transparent !important;
  font-size: 12px; line-height: 1; cursor: pointer; transition: all .15s ease;
}
#ci-table td:first-child .btn.small:hover,
#safety-table td:first-child .btn.small:hover,
#quality-table td:first-child .btn.small:hover,
.view-btn:hover {
  background: var(--accent) !important;
  color: #06201a !important;                 /* readable on the accent */
  box-shadow: 0 0 0 3px rgba(0,255,198,.12);
}
#ci-table td:first-child .btn.small:focus-visible,
#safety-table td:first-child .btn.small:focus-visible,
#quality-table td:first-child .btn.small:focus-visible,
.view-btn:focus-visible {
  outline: 2px solid var(--accent); outline-offset: 2px;
}
  /* Accent & danger tokens (hook to your theme if present) */
  :root{
    --pu-accent: var(--accent, #22c55e);
    --pu-accent-05: rgba(34,197,94,.05);
    --pu-accent-08: rgba(34,197,94,.08);
    --pu-accent-12: rgba(34,197,94,.12);
    --pu-accent-24: rgba(34,197,94,.24);
    --pu-danger: #ef4444;
    --pu-danger-20: rgba(239,68,68,.20);
  }

  /* Modal shell */
  .pu-modal { position:fixed; inset:0; display:none; z-index:10050; }
  .pu-modal.is-open { display:block; }
  .pu-modal__backdrop { position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(3px); }

  .pu-modal__card{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(760px, 92vw); max-height:78vh; overflow:auto;
    background:#0d1228; color:#e5e7eb; border:1px solid #00ffc6; border-radius:16px;
    box-shadow: 0 18px 40px rgba(0,0,0,.55), 0 0 0 1px var(--pu-accent-12) inset;

    /* Themed scrollbar + stable gutter */
    scrollbar-gutter: stable both-edges;
    scrollbar-width: thin; /* Firefox */
    scrollbar-color: var(--pu-accent-24) rgba(255,255,255,.04);
  }
  /* Accent rail */
  .pu-modal__card::before{
    content:""; position:absolute; left:0; top:0; bottom:0; width:4px;
    background: linear-gradient(180deg, var(--pu-accent) 0%, var(--pu-accent-24) 100%);
    border-top-left-radius:16px; border-bottom-left-radius:16px;
  }

  /* WebKit scrollbar theme */
  .pu-modal__card::-webkit-scrollbar{ width:10px; height:10px; }
  .pu-modal__card::-webkit-scrollbar-track{ background: rgba(255,255,255,.03); border-radius:999px; }
  .pu-modal__card::-webkit-scrollbar-thumb{
    background-clip: padding-box; border:2px solid transparent; border-radius:999px; background: var(--pu-accent-24);
  }
  .pu-modal__card:hover::-webkit-scrollbar-thumb{ background: var(--pu-accent); }
  .pu-modal__card::-webkit-scrollbar-thumb:active{
    background: color-mix(in oklab, var(--pu-accent) 85%, #000 15%);
  }
  /* Firefox hover brighten */
  .pu-modal__card:hover{ scrollbar-color: var(--pu-accent) rgba(255,255,255,.06); }

  /* Auto-switch — hide scrollbars ≥1280px (still scrollable) */
  @media (min-width: 1280px){
    .pu-modal__card{ scrollbar-width: none; }                 /* Firefox */
    .pu-modal__card::-webkit-scrollbar{ width:0; height:0; }  /* Chromium/WebKit */
  }

  /* Header — accent tint + handle + meta row */
  .pu-modal__header{
    position:sticky; top:0; z-index:1;
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px 10px;
    background: linear-gradient(0deg, var(--pu-accent-08), transparent 60%), #0d1228;
    border-bottom:1px solid #1f2940; backdrop-filter: saturate(115%);
    border-top-left-radius:16px; border-top-right-radius:16px;
  }
  .pu-handle{
    position:absolute; top:6px; left:50%; transform:translateX(-50%);
    width:44px; height:4px; border-radius:999px; background:#2a354b;
    box-shadow:0 0 0 1px rgba(255,255,255,.04) inset;
  }
  .pu-modal__heading{ display:flex; flex-direction:column; gap:6px; }
  .pu-modal__title{
    margin:0; font-size:15px; font-weight:700; letter-spacing:.01em; display:flex; align-items:center; gap:10px;
  }
  .pu-modal__title::before{
    content:""; width:8px; height:8px; border-radius:999px; background:var(--pu-accent);
    box-shadow:0 0 0 4px var(--pu-accent-05);
  }

  /* Meta chips */
  .pu-modal__meta{ display:flex; flex-wrap:wrap; gap:6px 10px; }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px; border-radius:999px; border:1px solid #1f2940;
    background:rgba(255,255,255,.02); color:#b6c2cf; font-size:12px; line-height:1;
  }
  .chip .fa{ opacity:.85; }
  .chip__label{ font-size:11px; color:#9fb3c8; }
  .chip__value{ color:#e6edf5; }

  .pu-modal__close { background:transparent; border:0; color:#94a3b8; font-size:18px; cursor:pointer; padding:0 6px; }
  .pu-modal__close:hover { color:#e5e7eb; }

  .pu-modal__body { padding:12px 16px 10px; }

  /* Key/Value grid */
  .pu-kv{
    display:grid; grid-template-columns: 190px 1fr; gap:0 16px; align-items:start;
  }
  .pu-kv > * { padding:10px 0; border-bottom:1px dashed rgba(255,255,255,.06); }
  .pu-kv dt{
    color:#00FFC6; font-size:11px; text-transform:uppercase; letter-spacing:.04em;
    display:flex; align-items:center; gap:8px;
  }
  .pu-kv dt::before{
    content:""; width:6px; height:6px; border-radius:999px; background:var(--pu-accent);
    box-shadow:0 0 0 4px var(--pu-accent-05);
  }
  .pu-kv dd{ margin:0; white-space:pre-wrap; word-break:break-word; color:#e7ebf0; font-size:13px; line-height:1.45; }

  .pu-kv .pill{ font-size:12px; line-height:1; padding:2px 6px; border-radius:999px; }
  .pill--green{ background:rgba(34,197,94,.15); color:#86efac; }
  .pill--blue{  background:rgba(59,130,246,.15); color:#93c5fd; }
  .pill--red{   background:rgba(239,68,68,.15); color:#fecaca; }

  /* Footer — action bar with Prev/Next + Close */
  .pu-modal__footer{
    position:sticky; bottom:0;
    background: linear-gradient(180deg, var(--pu-accent-08), transparent 70%), #0d1228;
    padding:12px 16px; border-top:1px solid #1f2940;
    display:flex; justify-content:center; gap:12px;
    box-shadow:0 -8px 20px rgba(0,0,0,.35);
    border-bottom-left-radius:16px; border-bottom-right-radius:16px;
  }
  .pu-modal__navBtn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 12px; border-radius:999px;
    background:#0b1328; color:#e5e7eb; border:1px solid #2a354b; cursor:pointer;
  }
  .pu-modal__navBtn:hover{ background:#122046; }
  .pu-modal__navBtn:disabled{ opacity:.45; cursor:default; }
  .pu-modal__closeBig{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    min-width:220px; padding:11px 16px; border-radius:999px;
    background:var(--pu-danger); color:#fff; font-weight:700;
    border:1px solid var(--pu-danger-20); cursor:pointer;
    box-shadow:0 6px 16px rgba(239,68,68,.25);
  }
  .pu-modal__closeBig:hover{ filter:brightness(1.05); }
  .pu-modal__closeBig:active{ transform:translateY(1px); }

  @media (max-width: 700px){
    .pu-kv{ grid-template-columns: 1fr; }
    .pu-kv dt{ margin-top:6px; }
  }
</style>

</head>

<body class="dashboard">
  <!-- (unchanged content up to tables) -->

  <!-- Tabs -->
  <div class="tab-buttons">
    <button class="tab-button active" onclick="showTab(event,'ci')">Continuous Improvement</button>
    <button class="tab-button" onclick="showTab(event,'safety')">Safety Concerns</button>
    <button class="tab-button" onclick="showTab(event,'quality')">Quality Catches</button>
  </div>

  <!-- CI Tab -->
  <div class="tab-panel active" id="tab-ci">
    <div class="table-header-row">
      <h3>Continuous Improvement</h3>
      <div class="table-header-controls">
        <select id="ci-filter"><option value="All">All Status</option></select>
        <a class="add-btn" id="ci-add"
           href="https://app.smartsheet.com/b/form/e60862d9ae0b44358d6f85dcd1c81d2b"
           target="_blank" rel="noopener">+ Add Submission</a>
        <span id="ci-count" class="row-count">0 submissions</span>
      </div>
    </div>
    <div class="table-scroll">
      <table id="ci-table" class="dashboard-table">
        <thead><tr>
          <th class="view-col" aria-label="View"></th>
          <th>Submitted</th><th>ID</th><th>Problem</th><th>Improvement</th><th>Approval</th>
          <th>Assigned</th><th>Status</th><th>Action Entered</th><th>Last Action</th>
          <th>Resourced</th><th>Resourced On</th><th>Tokens</th><th>Paid</th>
        </tr></thead>
        <tbody data-hook="table.ci.tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Safety Tab -->
  <div class="tab-panel" id="tab-safety">
    <div class="table-header-row">
      <h3>Safety Concerns</h3>
      <div class="table-header-controls">
        <select id="safety-filter"><option value="All">All Areas</option></select>
        <a class="add-btn" id="safety-add"
           href="https://app.smartsheet.com/b/form/162129580c03440f88cc5f284627b52f"
           target="_blank" rel="noopener">+ Add Submission</a>
        <span id="safety-count" class="row-count">0 submissions</span>
      </div>
    </div>
    <div class="table-scroll">
      <table id="safety-table" class="dashboard-table">
        <thead><tr>
          <th class="view-col" aria-label="View"></th>
          <th>Date</th><th>Department/Area</th><th>Safety Concern</th><th>Description</th>
          <th>Recommendations</th><th>Resolution</th><th>Escalated To</th>
          <th>Leadership Update</th><th>Closed/Confirmed</th><th>Status</th>
        </tr></thead>
        <tbody data-hook="table.safety.tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Quality Tab -->
  <div class="tab-panel" id="tab-quality">
    <div class="table-header-row">
      <h3>Quality Catches</h3>
      <div class="table-header-controls">
        <select id="quality-filter"><option value="All">All Types</option></select>
        <a class="add-btn" id="quality-add"
           href="https://app.smartsheet.com/b/form/2ba4ff03861d4d068ee5a0bff46308c3"
           target="_blank" rel="noopener">+ Add Submission</a>
        <span id="quality-count" class="row-count">0 submissions</span>
      </div>
    </div>
    <div class="table-scroll">
      <table id="quality-table" class="dashboard-table">
        <thead><tr>
          <th class="view-col" aria-label="View"></th>
          <th>Catch ID</th><th>Entry Date</th><th>Submitted By</th>
          <th>Area</th><th>Quality Catch</th><th>Part Number</th><th>Description</th>
        </tr></thead>
        <tbody data-hook="table.quality.tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Basic tab switch (safe event version) -->
  <script>
    function showTab(e, tabId) {
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(`tab-${tabId}`).classList.add('active');
      if (e && e.currentTarget) e.currentTarget.classList.add('active');
    }
  </script>

  <!-- App scripts -->
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/roles.js"></script>
  <script src="scripts/layout.js"></script>
  <script src="scripts/progress.js"></script>
  <script src="scripts/tokens.js"></script>
  <script src="scripts/tables.js?v=2025-09-11-a"></script>

  <!-- Initialize -->
  <script>
    (async function () {
      try {
        PowerUp.session.requireLogin();
        PowerUp.layout.injectLayout();
        PowerUp.layout.setPageTitle(document.title || 'PowerUp — Dashboard');
        await PowerUp.session.initHeader();
        await PowerUp.renderDashboardPowerHours();
        await PowerUp.renderTokenCard();
        await PowerUp.tables.hydrateDashboardTables();
        document.dispatchEvent(new Event('data-hydrated'));
      } catch (e) { console.error(e); }
    })();
  </script>

  <!-- Pre-fill "Submitted By" on Smartsheet forms (unchanged) -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const session = (window.PowerUp?.session?.get && window.PowerUp.session.get()) || {};
    const displayName = (session.displayName || session.userName || "").trim();
    if (!displayName) return;
    const forms = {
      "ci-add":      "https://app.smartsheet.com/b/form/e60862d9ae0b44358d6f85dcd1c81d2b",
      "safety-add":  "https://app.smartsheet.com/b/form/162129580c03440f88cc5f284627b52f",
      "quality-add": "https://app.smartsheet.com/b/form/2ba4ff03861d4d068ee5a0bff46308c3"
    };
    const F = {"ci-add":"Submitted By","safety-add":"Submitted By","quality-add":"Submitted By"};
    for (const [id, base] of Object.entries(forms)) {
      const a = document.getElementById(id); if (!a) continue;
      const param = encodeURIComponent(F[id] || "Submitted By") + "=" + encodeURIComponent(displayName);
      a.href = base + (base.includes("?") ? "&" : "?") + param;
    }
  });
  </script>

<script>
/** Native title="" tooltips for table cells and sidebar icons. */
(function () {
  function titleizeTables(root=document) {
    root.querySelectorAll('.table-scroll table tbody').forEach(tbody => {
      Array.from(tbody.rows).forEach(tr => {
        Array.from(tr.cells).forEach((td, idx) => {
          // Skip the "View" column if it's a button
          if (idx === 0 && td.querySelector('button, a')) return;
          if (!td.getAttribute('title')) {
            const raw = (td.textContent || '').trim();
            if (raw) td.title = raw;
          }
        });
      });
    });
  }
  function titleizeSidebar(root=document) {
    root.querySelectorAll('.sidebar .item').forEach(item => {
      const txt = (item.querySelector('span')?.textContent || item.getAttribute('aria-label') || '').trim();
      if (!txt) return;
      if (!item.title) item.title = txt;
      const ico = item.querySelector('i'); if (ico && !ico.title) ico.title = txt;
    });
  }
  document.addEventListener('DOMContentLoaded', () => { titleizeSidebar(); });
  document.addEventListener('data-hydrated', () => { titleizeTables(); titleizeSidebar(); });
})();
</script>

<!-- Modal (single reusable) -->
<div id="pu-record-modal" class="pu-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="pu-record-title">
  <div class="pu-modal__backdrop" data-modal-close></div>
  <div class="pu-modal__card">
    <div class="pu-modal__header">
      <div class="pu-handle" aria-hidden="true"></div>
      <div class="pu-modal__heading">
        <h3 id="pu-record-title" class="pu-modal__title">Record</h3>
        <div id="pu-record-meta" class="pu-modal__meta" hidden></div>
      </div>
      <button class="pu-modal__close" data-modal-close aria-label="Close">&times;</button>
    </div>
    <div class="pu-modal__body">
      <dl id="pu-record-dl" class="pu-kv"></dl>
    </div>
    <div class="pu-modal__footer">
      <button id="pu-nav-prev" class="pu-modal__navBtn" aria-label="Previous record"><i class="fa fa-chevron-left"></i> Prev</button>
      <button class="pu-modal__closeBig" data-modal-close aria-label="Close">
        <span class="fa-solid fa-xmark"></span> Close
      </button>
      <button id="pu-nav-next" class="pu-modal__navBtn" aria-label="Next record">Next <i class="fa fa-chevron-right"></i></button>
    </div>
  </div>
</div>

</body>
</html>





