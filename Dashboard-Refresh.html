<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="splash.css">


  <!-- EARLY AUTH GUARD — must be the first thing in <head> -->
  <script>
  !function () {
    try {
      const s = JSON.parse(sessionStorage.getItem('pu.session') || 'null')
             || JSON.parse(localStorage.getItem('powerup_session') || 'null');
      if (!s || !s.employeeId) {
        document.documentElement.style.visibility = 'hidden';
        location.replace('login.html');
      }
    } catch {
      document.documentElement.style.visibility = 'hidden';
      location.replace('login.html');
    }
  }();
  </script>

  <title>PowerUp — Dashboard</title>

  <!-- Fonts / Icons / Base styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css?v=2025-09-11-a" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">

<style>
  /* View column/button */
  /* View column/button — match style.css and make it visible */
  .view-col, .view-cell { width: 80px; min-width: 80px; text-align: center; }

  /* Style the legacy <button class="btn small">View</button> ONLY in the first cell,
     and also support .view-btn if you switch later. */
  #ci-table td:first-child .btn.small,
  #safety-table td:first-child .btn.small,
  #quality-table td:first-child .btn.small,
  .view-btn {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 4px 10px; border-radius: 8px;
    border: 1.5px solid var(--accent) !important;
    color: var(--accent) !important;
    background: transparent !important;
    font-size: 12px; line-height: 1; cursor: pointer; transition: all .15s ease;
  }
  #ci-table td:first-child .btn.small:hover,
  #safety-table td:first-child .btn.small:hover,
  #quality-table td:first-child .btn.small:hover,
  .view-btn:hover {
    background: var(--accent) !important;
    color: #06201a !important;                 /* readable on the accent */
    box-shadow: 0 0 0 3px rgba(0,255,198,.12);
  }
  #ci-table td:first-child .btn.small:focus-visible,
  #safety-table td:first-child .btn.small:focus-visible,
  #quality-table td:first-child .btn.small:focus-visible,
  .view-btn:focus-visible {
    outline: 2px solid var(--accent); outline-offset: 2px;
  }

  /* Accent & danger tokens (hook to your theme if present) */
  :root{
    --pu-accent: var(--accent, #22c55e);
    --pu-accent-05: rgba(34,197,94,.05);
    --pu-accent-08: rgba(34,197,94,.08);
    --pu-accent-12: rgba(34,197,94,.12);
    --pu-accent-24: rgba(34,197,94,.24);
    --pu-danger: #ef4444;
    --pu-danger-20: rgba(239,68,68,.20);
  }

  /* Modal shell */
  .pu-modal { position:fixed; inset:0; display:none; z-index:10050; }
  .pu-modal.is-open { display:block; }
  .pu-modal__backdrop { position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(3px); }

  .pu-modal__card{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(760px, 92vw); max-height:78vh; overflow:auto;
    background:#0d1228; color:#e5e7eb; border:1px solid #00ffc6; border-radius:16px;
    box-shadow: 0 18px 40px rgba(0,0,0,.55), 0 0 0 1px var(--pu-accent-12) inset;

    /* Themed scrollbar + stable gutter */
    scrollbar-gutter: stable both-edges;
    scrollbar-width: thin; /* Firefox */
    scrollbar-color: var(--pu-accent-24) rgba(255,255,255,.04);
  }
  /* Accent rail */
  .pu-modal__card::before{
    content:""; position:absolute; left:0; top:0; bottom:0; width:4px;
    background: linear-gradient(180deg, var(--pu-accent) 0%, var(--pu-accent-24) 100%);
    border-top-left-radius:16px; border-bottom-left-radius:16px;
  }

  /* WebKit scrollbar theme */
  .pu-modal__card::-webkit-scrollbar{ width:10px; height:10px; }
  .pu-modal__card::-webkit-scrollbar-track{ background: rgba(255,255,255,.03); border-radius:999px; }
  .pu-modal__card::-webkit-scrollbar-thumb{
    background-clip: padding-box; border:2px solid transparent; border-radius:999px; background: var(--pu-accent-24);
  }
  .pu-modal__card:hover::-webkit-scrollbar-thumb{ background: var(--pu-accent); }
  .pu-modal__card::-webkit-scrollbar-thumb:active{
    background: color-mix(in oklab, var(--pu-accent) 85%, #000 15%);
  }
  /* Firefox hover brighten */
  .pu-modal__card:hover{ scrollbar-color: var(--pu-accent) rgba(255,255,255,.06); }

  /* Auto-switch — hide scrollbars ≥1280px (still scrollable) */
  @media (min-width: 1280px){
    .pu-modal__card{ scrollbar-width: none; }                 /* Firefox */
    .pu-modal__card::-webkit-scrollbar{ width:0; height:0; }  /* Chromium/WebKit */
  }

  /* Header — accent tint + handle + meta row */
  .pu-modal__header{
    position:sticky; top:0; z-index:1;
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px 10px;
    background: linear-gradient(0deg, var(--pu-accent-08), transparent 60%), #0d1228;
    border-bottom:1px solid #1f2940; backdrop-filter: saturate(115%);
    border-top-left-radius:16px; border-top-right-radius:16px;
  }
  .pu-handle{
    position:absolute; top:6px; left:50%; transform:translateX(-50%);
    width:44px; height:4px; border-radius:999px; background:#2a354b;
    box-shadow:0 0 0 1px rgba(255,255,255,.04) inset;
  }
  .pu-modal__heading{ display:flex; flex-direction:column; gap:6px; }
  .pu-modal__title{
    margin:0; font-size:15px; font-weight:700; letter-spacing:.01em; display:flex; align-items:center; gap:10px;
  }
  .pu-modal__title::before{
    content:""; width:8px; height:8px; border-radius:999px; background:var(--pu-accent);
    box-shadow:0 0 0 4px var(--pu-accent-05);
  }

  /* Meta chips */
  .pu-modal__meta{ display:flex; flex-wrap:wrap; gap:6px 10px; }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px; border-radius:999px; border:1px solid #1f2940;
    background:rgba(255,255,255,.02); color:#b6c2cf; font-size:12px; line-height:1;
  }
  .chip .fa{ opacity:.85; }
  .chip__label{ font-size:11px; color:#9fb3c8; }
  .chip__value{ color:#e6edf5; }

  .pu-modal__close { background:transparent; border:0; color:#94a3b8; font-size:18px; cursor:pointer; padding:0 6px; }
  .pu-modal__close:hover { color:#e5e7eb; }

  .pu-modal__body { padding:12px 16px 10px; }

  /* Key/Value grid */
  .pu-kv{
    display:grid; grid-template-columns: 190px 1fr; gap:0 16px; align-items:start;
  }
  .pu-kv > * { padding:10px 0; border-bottom:1px dashed rgba(255,255,255,.06); }
  .pu-kv dt{
    color:#00FFC6; font-size:11px; text-transform:uppercase; letter-spacing:.04em;
    display:flex; align-items:center; gap:8px;
  }
  .pu-kv dt::before{
    content:""; width:6px; height:6px; border-radius:999px; background:var(--pu-accent);
    box-shadow:0 0 0 4px var(--pu-accent-05);
  }
  .pu-kv dd{ margin:0; white-space:pre-wrap; word-break:break-word; color:#e7ebf0; font-size:13px; line-height:1.45; }

  .pu-kv .pill{ font-size:12px; line-height:1; padding:2px 6px; border-radius:999px; }
  .pill--green{ background:rgba(34,197,94,.15); color:#86efac; }
  .pill--blue{  background:rgba(59,130,246,.15); color:#93c5fd; }
  .pill--red{   background:rgba(239,68,68,.15); color:#fecaca; }

  /* Footer — action bar with Prev/Next + Close */
  .pu-modal__footer{
    position:sticky; bottom:0;
    background: linear-gradient(180deg, var(--pu-accent-08), transparent 70%), #0d1228;
    padding:12px 16px; border-top:1px solid #1f2940;
    display:flex; justify-content:center; gap:12px;
    box-shadow:0 -8px 20px rgba(0,0,0,.35);
    border-bottom-left-radius:16px; border-bottom-right-radius:16px;
  }
  .pu-modal__navBtn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 12px; border-radius:999px;
    background:#0b1328; color:#e5e7eb; border:1px solid #2a354b; cursor:pointer;
  }
  .pu-modal__navBtn:hover{ background:#122046; }
  .pu-modal__navBtn:disabled{ opacity:.45; cursor:default; }
  .pu-modal__closeBig{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    min-width:220px; padding:11px 16px; border-radius:999px;
    background:var(--pu-danger); color:#fff; font-weight:700;
    border:1px solid var(--pu-danger-20); cursor:pointer;
    box-shadow:0 6px 16px rgba(239,68,68,.25);
  }
  .pu-modal__closeBig:hover{ filter:brightness(1.05); }
  .pu-modal__closeBig:active{ transform:translateY(1px); }

  @media (max-width: 700px){
    .pu-kv{ grid-template-columns: 1fr; }
    .pu-kv dt{ margin-top:6px; }
  }
</style>

</head>

<body class="dashboard">
  <!-- Top cards (restored) -->
  <div class="top-cards">
    <!-- Power Hours -->
    <div class="card power-card">
      <h3>Power Hours Logged</h3>
      <p>
        <span data-hook="ph.total">0.0</span> /
        <span data-hook="ph.goalMax">8</span>
      </p>

      <!-- Simple progress bar (no bubbles/legends) -->
      <div class="phbar"
           data-hook="ph.track"
           role="progressbar"
           aria-valuemin="0"
           aria-valuemax="8"
           aria-valuenow="0">
        <div class="phbar__fill"  data-hook="ph.fill"></div>
        <div class="phbar__thumb" data-hook="ph.thumb" title="Current"></div>
      </div>

      <small data-hook="ph.message">—</small>
    </div>

    <!-- Tokens -->
    <div class="card token-card">
      <h3>Tokens</h3>
      <div class="token-tracker">
        <i class="fas fa-coins"></i>
        <span data-hook="token.total">0</span>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tab-buttons" role="tablist" aria-label="Dashboard Sections">
    <button class="tab-button active" role="tab" aria-selected="true" aria-controls="tab-ci" onclick="showTab(event,'ci')">Continuous Improvement</button>
    <button class="tab-button"        role="tab" aria-selected="false" aria-controls="tab-safety" onclick="showTab(event,'safety')">Safety Concerns</button>
    <button class="tab-button"        role="tab" aria-selected="false" aria-controls="tab-quality" onclick="showTab(event,'quality')">Quality Catches</button>
  </div>

  <!-- CI Tab -->
  <div class="tab-panel active" id="tab-ci">
    <div class="table-header-row">
      <h3>Continuous Improvement</h3>
      <div class="table-header-controls">
        <select id="ci-col"    title="Pick a column to filter"></select>
        <select id="ci-colval" title="Pick a value" disabled></select>

        <a class="add-btn" id="ci-add"
          href="https://app.smartsheet.com/b/form/e60862d9ae0b44358d6f85dcd1c81d2b"
          target="_blank" rel="noopener">+ Add Submission</a>
        <span id="ci-count" class="row-count">0 submissions</span>
      </div>
    </div>
    <div class="table-scroll">
      <table id="ci-table" class="dashboard-table">
        <thead><tr>
          <th class="view-col" aria-label="View"></th>
          <th>Submitted</th><th>ID</th><th>Problem</th><th>Improvement</th><th>Approval</th>
          <th>Assigned</th><th>Status</th><th>Action Entered</th><th>Last Action</th>
          <th>Resourced</th><th>Resourced On</th><th>Tokens</th><th>Paid</th>
        </tr></thead>
        <tbody data-hook="table.ci.tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Safety Tab -->
  <div class="tab-panel" id="tab-safety">
    <div class="table-header-row">
      <h3>Safety Concerns</h3>
      <div class="table-header-controls">
        <select id="safety-col"    title="Pick a column to filter"></select>
        <select id="safety-colval" title="Pick a value" disabled></select>

        <a class="add-btn" id="safety-add"
          href="https://app.smartsheet.com/b/form/162129580c03440f88cc5f284627b52f"
          target="_blank" rel="noopener">+ Add Submission</a>
        <span id="safety-count" class="row-count">0 submissions</span>
      </div>
    </div>
    <div class="table-scroll">
      <table id="safety-table" class="dashboard-table">
        <thead><tr>
          <th class="view-col" aria-label="View"></th>
          <th>Date</th><th>Department/Area</th><th>Safety Concern</th><th>Description</th>
          <th>Recommendations</th><th>Resolution</th><th>Escalated To</th>
          <th>Leadership Update</th><th>Closed/Confirmed</th><th>Status</th>
        </tr></thead>
        <tbody data-hook="table.safety.tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Quality Tab -->
  <div class="tab-panel" id="tab-quality">
    <div class="table-header-row">
      <h3>Quality Catches</h3>
      <div class="table-header-controls">
        <select id="quality-col"    title="Pick a column to filter"></select>
        <select id="quality-colval" title="Pick a value" disabled></select>

        <a class="add-btn" id="quality-add"
          href="https://app.smartsheet.com/b/form/2ba4ff03861d4d068ee5a0bff46308c3"
          target="_blank" rel="noopener">+ Add Submission</a>
        <span id="quality-count" class="row-count">0 submissions</span>
      </div>
    </div>
    <div class="table-scroll">
      <table id="quality-table" class="dashboard-table">
        <thead><tr>
          <th class="view-col" aria-label="View"></th>
          <th>Catch ID</th><th>Entry Date</th><th>Submitted By</th>
          <th>Area</th><th>Quality Catch</th><th>Part Number</th><th>Description</th>
        </tr></thead>
        <tbody data-hook="table.quality.tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Basic tab switch (safe event version) -->
  <script>
    function showTab(e, tabId) {
      // hide all panels
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

      // reset all tabs
      document.querySelectorAll('.tab-button').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });

      // show selected panel
      document.getElementById(`tab-${tabId}`).classList.add('active');

      // mark selected tab (by event or by aria-controls fallback)
      const btn = e && e.currentTarget ? e.currentTarget : document.querySelector(`[aria-controls="tab-${tabId}"]`);
      if (btn) {
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
        btn.focus?.();
      }

      // Recompute layout if the tab row wraps or heights changed
      requestAnimationFrame(() => window?.PowerUp?.layout?.fitDashboardBlocks?.());
    }
  </script>

  <!-- App scripts -->
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/roles.js"></script>
  <script src="scripts/layout.js"></script>
  <script src="scripts/progress.js"></script>
  <script src="scripts/tokens.js"></script>
  <script src="scripts/tables.js?v=2025-09-11-a"></script>

  <!-- Initialize -->
  <script>
    (async function () {
      try {
        PowerUp.session.requireLogin();
        PowerUp.layout.injectLayout();
        PowerUp.layout.setPageTitle(document.title || 'PowerUp — Dashboard');
        await PowerUp.session.initHeader();
        await PowerUp.renderDashboardPowerHours();
        await PowerUp.renderTokenCard();
        await PowerUp.tables.hydrateDashboardTables();
        document.dispatchEvent(new Event('data-hydrated'));
      } catch (e) { console.error(e); }
    })();
  </script>

  <!-- Pre-fill "Submitted By" on Smartsheet forms (unchanged) -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const session = (window.PowerUp?.session?.get && window.PowerUp.session.get()) || {};
    const displayName = (session.displayName || session.userName || "").trim();
    if (!displayName) return;
    const forms = {
      "ci-add":      "https://app.smartsheet.com/b/form/e60862d9ae0b44358d6f85dcd1c81d2b",
      "safety-add":  "https://app.smartsheet.com/b/form/162129580c03440f88cc5f284627b52f",
      "quality-add": "https://app.smartsheet.com/b/form/2ba4ff03861d4d068ee5a0bff46308c3"
    };
    const F = {"ci-add":"Submitted By","safety-add":"Submitted By","quality-add":"Submitted By"};
    for (const [id, base] of Object.entries(forms)) {
      const a = document.getElementById(id); if (!a) continue;
      const param = encodeURIComponent(F[id] || "Submitted By") + "=" + encodeURIComponent(displayName);
      a.href = base + (base.includes("?") ? "&" : "?") + param;
    }
  });
  </script>

  <script>
  /** Native title="" tooltips for table cells and sidebar icons. */
  (function () {
    function titleizeTables(root=document) {
      root.querySelectorAll('.table-scroll table tbody').forEach(tbody => {
        Array.from(tbody.rows).forEach(tr => {
          Array.from(tr.cells).forEach((td, idx) => {
            // Skip the "View" column if it's a button
            if (idx === 0 && td.querySelector('button, a')) return;
            if (!td.getAttribute('title')) {
              const raw = (td.textContent || '').trim();
              if (raw) td.title = raw;
            }
          });
        });
      });
    }
    document.addEventListener('data-hydrated', () => { titleizeTables(); });
  })();
  </script>

  <!-- NEW: Recompute table height after cards render or resize -->
  <script>
  (function () {
    function recalc() {
      try { window?.PowerUp?.layout?.fitDashboardBlocks?.(); } catch (e) {}
    }
    // observe top-cards height changes (progress/tokens update)
    const cards = document.querySelector('.top-cards');
    if (cards && typeof ResizeObserver !== 'undefined') {
      const ro = new ResizeObserver(() => requestAnimationFrame(recalc));
      ro.observe(cards);
    }
    // late passes after paint
    requestAnimationFrame(recalc);
    window.addEventListener('load', () => setTimeout(recalc, 0));
  })();
  </script>

<!-- Empty-state hook for CI / Safety / Quality tables -->
<script>
  (function(){
    function fallbackEmptyRow(tbody, text){
      const table = tbody.closest('table');
      const cols  = (table.tHead && table.tHead.rows[0] ? table.tHead.rows[0].cells.length : 1);
      tbody.innerHTML =
        `<tr class="pu-empty-row"><td colspan="${cols}">
           <div class="pu-empty">
             <div class="pu-empty__title">${text}</div>
           </div>
         </td></tr>`;
    }

    // Treat “No rows” placeholder as empty too
    function isEffectivelyEmpty(tbody){
      if (!tbody) return true;
      if (tbody.children.length === 0) return true;
      // If every cell is blank or only says "No rows"
      return !Array.from(tbody.rows).some(tr =>
        Array.from(tr.cells).some(td => {
          const txt = (td.textContent || '').trim().toLowerCase();
          const hasWidget = td.querySelector('button, a, .pill, .view-btn');
          return hasWidget || (txt && txt !== 'no rows');
        })
      );
    }

    function ensureEmpty(tbody, message){
      if (!tbody) return;
      if (!isEffectivelyEmpty(tbody)) return;
      // Clear SmartSheet “No rows” row and render the unified empty state
      tbody.innerHTML = '';
      if (window.PowerUp?.layout?.renderEmptyState) {
        try { PowerUp.layout.renderEmptyState(tbody, message); return; } catch(e){}
      }
      fallbackEmptyRow(tbody, message);
    }

    function applyDashboardEmptyStates(){
      ensureEmpty(document.querySelector('[data-hook="table.ci.tbody"]'),      'No CI submissions to show.');
      ensureEmpty(document.querySelector('[data-hook="table.safety.tbody"]'),  'No Safety concerns submitted.');
      ensureEmpty(document.querySelector('[data-hook="table.quality.tbody"]'), 'No Quality catches to show.');
    }

    // Run after tables finish hydrating
    document.addEventListener('data-hydrated', applyDashboardEmptyStates);
  })();
</script>


  <!-- Modal (single reusable) -->
  <div id="pu-record-modal" class="pu-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="pu-record-title">
    <div class="pu-modal__backdrop" data-modal-close></div>
    <div class="pu-modal__card" tabindex="-1">
      <div class="pu-modal__header">
        <div class="pu-handle" aria-hidden="true"></div>
        <div class="pu-modal__heading">
          <h3 id="pu-record-title" class="pu-modal__title">Record</h3>
          <div id="pu-record-meta" class="pu-modal__meta" hidden></div>
        </div>
        <button class="pu-modal__close" data-modal-close aria-label="Close">&times;</button>
      </div>
      <div class="pu-modal__body">
        <dl id="pu-record-dl" class="pu-kv"></dl>
      </div>
      <div class="pu-modal__footer">
        <button id="pu-nav-prev" class="pu-modal__navBtn" aria-label="Previous record"><i class="fa fa-chevron-left"></i> Prev</button>
        <button class="pu-modal__closeBig" data-modal-close aria-label="Close">
          <span class="fa-solid fa-xmark"></span> Close
        </button>
        <button id="pu-nav-next" class="pu-modal__navBtn" aria-label="Next record">Next <i class="fa fa-chevron-right"></i></button>
      </div>
    </div>
  </div>


<script>
/* === Curated Playworld set === */
const IMAGE_SETS = [
  { name:'playworld', base:'', files: [
    "https://playworld.com/wp-content/uploads/2024/07/ClarkV_240612__U7A0416-scaled.jpg",
    "https://playworld.com/wp-content/uploads/2024/07/ClarkV_240612__U7A9136-scaled.jpg",
    "https://playworld.com/wp-content/uploads/2023/09/tz-2325-web-image-2.png",
    "https://playworld.com/wp-content/uploads/2025/01/rs-2370-web-image-1.png",
    "https://playworld.com/wp-content/uploads/2023/09/rs-2315-web-image-1.png",
    "https://playworld.com/wp-content/uploads/2023/09/zzxx1123-web-image-1-scaled.jpg",
    "https://playworld.com/wp-content/uploads/2023/09/zzun8771-web-image-2.jpg",
    "https://playworld.com/wp-content/uploads/2023/09/500-2039-web-image-1.png",
    "https://secure.viewer.zmags.com/services/resource/pub/4aa2a8e9/pg683x856/5/6?viewerID=cdc7b5af",
    "https://secure.viewer.zmags.com/services/resource/pub/4aa2a8e9/pg683x856/5/26?viewerID=cdc7b5af",
    "https://playworld.com/wp-content/uploads/2023/10/LOC-Pirate-Ship-NJ-020_QCC-BackgroundEditforText.jpg",
    "https://playworld.com/wp-content/uploads/2025/02/PW_2025_Smith-Ranch-Eagle-Mountain-UT_241023__0011741_Edit_SM.jpg",
    "https://playworld.com/wp-content/uploads/2024/01/PW_2024_Piney-Orchard_Edit_10-940x627.jpeg",
    "https://playworld.com/wp-content/uploads/2024/07/ClarkV_240612__U7A9125-2048x1366.jpg",
    "https://playworld.com/wp-content/uploads/2023/10/PW_Rope-Web-Images_09-min-2048x1365.jpg",
    "https://playworld.com/wp-content/uploads/2024/01/PW_2024_RopeScapes_Lewisburg-PA_42-copy.jpg",
    "https://playworld.com/wp-content/uploads/2023/10/Cleveland_Elementary_Washington_D.C_201002__96A9723-min-2048x1365.jpg",
    "https://playworld.com/wp-content/uploads/2025/09/PW_2026_Cook-Family-Park_Pleasant-Grove-UT_250811__0013651.jpg",
    "https://playworld.com/wp-content/uploads/2023/10/PlayTown_Playhouse_02-2048x1152.jpg"
  ]}
];

const SHOTS_PER_RUN = 22;
const SHUFFLE_WITHIN_SET = true;
const STORAGE_KEY = 'pw_splash_set_index';

const elSplash  = document.getElementById('splash');
const elMontage = document.getElementById('montage');
const elFinal   = document.getElementById('finalCard');
const elLens    = document.querySelector('.lens');
const elCard    = document.querySelector('.cardwash');
const elDivider = document.querySelector('.divider');
const elSubbar  = document.querySelector('.subbar');
const btnSkip   = document.getElementById('skipBtn');
const elText    = document.getElementById('splash-loading');

const shotHold  = cssMs('--shot-hold', 140);
const xfade     = cssMs('--shot-xfade', 100);
const step      = shotHold + xfade;

const kenScale  = getCss('--kenburns-scale', 1.06);
const panX      = getCss('--kenburns-pan-x', '10px');
const panY      = getCss('--kenburns-pan-y', '8px');

const finalHold = cssMs('--final-hold', 1400);
const brandHold = cssMs('--brand-hold', 1200);

let timers = [];
function clearTimers(){ timers.forEach(t=>clearTimeout(t)); timers=[]; }

if (btnSkip) btnSkip.addEventListener('click', skipAll, { passive:true });

window.Splash = { play: startSequence, skip: skipAll, end: endSequence };

document.addEventListener('DOMContentLoaded', () => {
  const alreadyPlayed = sessionStorage.getItem('splashPlayed');
  if (alreadyPlayed) return;
  sessionStorage.setItem('splashPlayed', 'true');
  startSequence();
});

document.addEventListener('data-hydrated', () => endSequence());

async function startSequence(){
  if(!IMAGE_SETS.length) return;

  // Show splash and loading text immediately
  elSplash.style.display = 'block';
  document.documentElement.style.overflow = 'hidden';
  if (elText) {
    elText.style.transition = 'opacity 0.8s ease';
    elText.style.opacity = '0.8';
  }

  // Delay skip button visibility
  if (btnSkip) {
    btnSkip.style.opacity = '0';
    setTimeout(()=> {
      if (elSplash.style.display === 'block') btnSkip.style.opacity = '1';
    }, 3000);
  }

  const idx = getNextSetIndex();
  const set = IMAGE_SETS[idx];
  let urls = set.files.map(f => set.base + f);

  if(SHUFFLE_WITHIN_SET) urls = shuffle(urls);
  if(urls.length > SHOTS_PER_RUN) urls = urls.slice(0, SHOTS_PER_RUN);

  await preloadBounded(urls.slice(0,2), 2);
  buildShots(urls);
  preloadBounded(urls.slice(2), 6);

  const montageDuration = urls.length * step;
  document.documentElement.style.setProperty('--montage-duration', montageDuration + 'ms');

  elMontage.style.animation = `montageFadeOut ${montageDuration}ms linear forwards`;
  elLens.style.animation    = `montageFadeOut ${montageDuration}ms linear forwards`;
  elCard.style.animation    = `cardwashFadeIn ${montageDuration}ms linear forwards`;

  const sweepDelay = Math.max(0, Math.round(montageDuration - 350));
  document.documentElement.style.setProperty('--sweep-delay', sweepDelay + 'ms');

  const SUBBAR_DELAY_OFFSET = 180;
  elSubbar.style.animationDelay = (sweepDelay + SUBBAR_DELAY_OFFSET) + 'ms';

  const showDividerAt = sweepDelay + SUBBAR_DELAY_OFFSET + 90;
  timers.push(setTimeout(() => {
    syncDividerWidth();
    elDivider.classList.add('show');
    observeSubbar();
  }, showDividerAt));

  const elStroke = document.querySelector('.wordmark-stroke');
  const sweepDur = cssMs('--sweep-duration', 2600);
  const strokeOffset = cssMs('--stroke-offset', 140);
  timers.push(setTimeout(() => {
    if (!elStroke) return;
    elStroke.classList.add('full');
    elStroke.classList.add('glow');
    setTimeout(()=> elStroke.classList.remove('glow'), 900);
  }, sweepDelay + strokeOffset + sweepDur + 20));

  const showFinalAt = Math.max(0, montageDuration - 120);
  const endAt       = montageDuration + finalHold + brandHold;

  timers.push(setTimeout(()=> {
    elFinal.classList.add('show');
    elCard.classList.add('parallax');
  }, showFinalAt));

  timers.push(setTimeout(endSequence, endAt));
}

function endSequence(){
  elSplash.classList.add('fade-out');
  if (elText) elText.style.opacity = '0';
  setTimeout(()=>{
    elSplash.style.display = 'none';
    elSplash.classList.remove('fade-out');
    elFinal.classList.remove('show');
    elCard.classList.remove('parallax');
    document.documentElement.style.overflow = '';
    clearTimers();
    if (ro) { ro.disconnect(); ro = null; }
  }, 540);
}

function skipAll(){
  clearTimers();
  elFinal.classList.add('show');
  elCard.classList.add('parallax');
  endSequence();
}

function buildShots(images){
  elMontage.innerHTML = '';
  images.forEach((src, i)=>{
    const d = document.createElement('div');
    d.className = 'shot';
    d.style.backgroundImage = `url("${src}")`;
    d.style.setProperty('--kenburns-scale', kenScale);
    d.style.setProperty('--kenburns-pan-x', panX);
    d.style.setProperty('--kenburns-pan-y', panY);
    d.style.setProperty('--tilt-deg', '4deg');
    const animLen = step + 200;
    const delay   = i * step;
    d.style.animation = `shotLife ${animLen}ms ${delay}ms both ease-in-out`;
    elMontage.appendChild(d);
  });
}

function syncDividerWidth(){
  const w = elSubbar.getBoundingClientRect().width;
  elDivider.style.width = Math.max(0, Math.round(w)) + 'px';
}
let ro = null;
function observeSubbar(){
  if (ro) return;
  ro = new ResizeObserver(() => syncDividerWidth());
  ro.observe(elSubbar);
}

function cssMs(varName, fallback){
  const v = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  if(!v) return fallback;
  if(v.endsWith('ms')) return parseFloat(v);
  if(v.endsWith('s'))  return parseFloat(v)*1000;
  const n = parseFloat(v); return Number.isFinite(n) ? n : fallback;
}
function getCss(varName, fallback){
  const v = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  return v || fallback;
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = (Math.random()*(i+1))|0;
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function preloadBounded(urls, concurrency=6){
  if(!urls || !urls.length) return Promise.resolve();
  let i=0, inflight=0;
  return new Promise(resolve=>{
    const pump=()=>{
      if(i>=urls.length && inflight===0) return resolve();
      while(inflight<concurrency && i<urls.length){
        const img=new Image();
        img.decoding='async'; img.loading='eager';
        img.src=urls[i++]; inflight++;
        img.onload=img.onerror=()=>{ inflight--; pump(); };
      }
    };
    pump();
  });
}
function getNextSetIndex(){
  const max = IMAGE_SETS.length;
  const raw = localStorage.getItem(STORAGE_KEY);
  let idx = parseInt(raw,10); if(!Number.isFinite(idx)) idx = -1;
  idx = (idx + 1) % max;
  localStorage.setItem(STORAGE_KEY, String(idx));
  return idx;
}
</script>



  <!-- ✅ Integrated Splash Sequence for Dashboard (Option B) -->
<!-- This block should be added just before the closing </body> tag in Dashboard-Refresh.html -->

<div id="splash" class="splash" aria-hidden="true">
  <div class="montage" id="montage"></div>
  <div class="lens" aria-hidden="true"></div>
  <div class="cardwash" aria-hidden="true"></div>
  <div class="vignette" aria-hidden="true"></div>

  <div class="lockup" aria-hidden="true">
    <div class="wordmark-wrap">
      <div class="wordmark" aria-label="PLAYWORLD">
        <span class="wordmark-fill">PLAYWORLD</span>
        <span class="wordmark-stroke" aria-hidden="true">PLAYWORLD</span>
        <div class="sweep" aria-hidden="true"></div>
        <div class="sparks" aria-hidden="true">
          <span class="spark s1"></span>
          <span class="spark s2"></span>
          <span class="spark s3"></span>
          <span class="spark s4"></span>
        </div>
      </div>
      <div class="divider" aria-hidden="true"></div>
      <div class="subbar">PowerUp</div>
    </div>
  </div>

  <div id="finalCard" class="final" aria-hidden="true"></div>

  <button id="skipBtn" class="skip" type="button" aria-label="Skip Intro">Skip Intro</button>
  <div id="splash-loading" class="splash-loading">Loading your dashboard…</div>

</div>


</body>
</html>



