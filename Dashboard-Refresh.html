<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- EARLY AUTH GUARD — must be the first thing in <head> -->
<script>
!function () {
  try {
    // Prefer the real session key; fall back to legacy only if present
    const s = JSON.parse(sessionStorage.getItem('pu.session') || 'null')
           || JSON.parse(localStorage.getItem('powerup_session') || 'null');
    if (!s || !s.employeeId) {
      // block paint, then bounce to login
      document.documentElement.style.visibility = 'hidden';
      location.replace('login.html');
    }
  } catch {
    document.documentElement.style.visibility = 'hidden';
    location.replace('login.html');
  }
}();
</script>

  
  <title>PowerUp — Dashboard</title>

  <!-- Fonts / Icons / Base styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
  <!-- Favicon (SVG + PNG fallback) -->
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="alternate icon" type="image/png" href="assets/favicon.png">

</head>

<body class="dashboard">
  <!-- PAGE-SPECIFIC CONTENT ONLY (layout.js injects sidebar + header) -->

  <!-- Top cards -->
  <div class="top-cards">
    <!-- Power Hours -->
    <div class="card power-card">
      <h3>Power Hours Logged</h3>
      <p>
        <span data-hook="ph.total">0.0</span> /
        <span data-hook="ph.goalMax">8</span>
      </p>

      <!-- Simple progress bar (no bubbles/legends) -->
      <div class="phbar"
           data-hook="ph.track"
           role="progressbar"
           aria-valuemin="0"
           aria-valuemax="8"
           aria-valuenow="0">
        <div class="phbar__fill"  data-hook="ph.fill"></div>
        <div class="phbar__thumb" data-hook="ph.thumb" title="Current"></div>
      </div>

      <small data-hook="ph.message">—</small>
    </div>

    <!-- Tokens -->
    <div class="card token-card">
      <h3>Tokens</h3>
      <div class="token-tracker">
        <i class="fas fa-coins"></i>
        <span data-hook="token.total">0</span>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tab-buttons">
    <button class="tab-button active" onclick="showTab(event,'ci')">Continuous Improvement</button>
    <button class="tab-button" onclick="showTab(event,'safety')">Safety Concerns</button>
    <button class="tab-button" onclick="showTab(event,'quality')">Quality Catches</button>
  </div>

  <!-- CI Tab -->
  <div class="tab-panel active" id="tab-ci">
    <div class="table-header-row">
      <h3>Continuous Improvement</h3>
      <div class="table-header-controls">
        <select id="ci-filter">
          <!-- Options are repopulated by tables.js -->
          <option value="All">All Status</option>
        </select>
        <a class="add-btn" id="ci-add"
   href="https://app.smartsheet.com/b/form/e60862d9ae0b44358d6f85dcd1c81d2b"
   target="_blank" rel="noopener">+ Add Submission</a>
        <span id="ci-count" class="row-count">0 submissions</span>
      </div>
    </div>

    <div class="table-scroll">
      <table id="ci-table" class="dashboard-table">
        <thead>
          <tr>
            <th>Submitted</th>
            <th>ID</th>
            <th>Problem</th>
            <th>Improvement</th>
            <th>Approval</th>
            <th>Assigned</th>
            <th>Status</th>
            <th>Action Entered</th>
            <th>Last Action</th>
            <th>Resourced</th>
            <th>Resourced On</th>
            <th>Tokens</th>
            <th>Paid</th>
          </tr>
        </thead>
        <tbody data-hook="table.ci.tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Safety Tab -->
  <div class="tab-panel" id="tab-safety">
    <div class="table-header-row">
      <h3>Safety Concerns</h3>
      <div class="table-header-controls">
        <select id="safety-filter">
          <!-- Options are repopulated by tables.js -->
          <option value="All">All Areas</option>
        </select>
        <a class="add-btn" id="safety-add"
   href="https://app.smartsheet.com/b/form/162129580c03440f88cc5f284627b52f"
   target="_blank" rel="noopener">+ Add Submission</a>
        <span id="safety-count" class="row-count">0 submissions</span>
      </div>
    </div>

    <div class="table-scroll">
      <table id="safety-table" class="dashboard-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Department/Area</th>
            <th>Safety Concern</th>
            <th>Description</th>
            <th>Recommendations</th>
            <th>Resolution</th>
            <th>Escalated To</th>
            <th>Leadership Update</th>
            <th>Closed/Confirmed</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody data-hook="table.safety.tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Quality Catches Tab -->
  <div class="tab-panel" id="tab-quality">
    <div class="table-header-row">
      <h3>Quality Catches</h3>
      <div class="table-header-controls">
        <select id="quality-filter">
          <!-- Options are repopulated by tables.js -->
          <option value="All">All Types</option>
        </select>
        <a class="add-btn" id="quality-add"
   href="https://app.smartsheet.com/b/form/2ba4ff03861d4d068ee5a0bff46308c3"
   target="_blank" rel="noopener">+ Add Submission</a>
        <span id="quality-count" class="row-count">0 submissions</span>
      </div>
    </div>

    <div class="table-scroll">
      <table id="quality-table" class="dashboard-table">
        <thead>
          <tr>
            <th>Catch ID</th>
            <th>Entry Date</th>
            <th>Submitted By</th>
            <th>Area</th>
            <th>Quality Catch</th>
            <th>Part Number</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody data-hook="table.quality.tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Basic tab switch (safe event version) -->
  <script>
    function showTab(e, tabId) {
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(`tab-${tabId}`).classList.add('active');
      if (e && e.currentTarget) e.currentTarget.classList.add('active');
    }
  </script>

  <!-- App scripts -->
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/roles.js"></script>
  <script src="scripts/layout.js"></script>
  <script src="/scripts/progress.js"></script>
  <script src="/scripts/tokens.js"></script>
  <script src="/scripts/tables.js"></script>


  <!-- Initialize -->
  <script>
    (async function () {
      try {
        // 1) Ensure user is logged in (redirect away if not)
        PowerUp.session.requireLogin();

        // 2) Inject the shared shell (sidebar + header) once per page
        PowerUp.layout.injectLayout();

        // 3) Force the header H1
        PowerUp.layout.setPageTitle(document.title || 'PowerUp — Dashboard');

        // 4) Now that header elements exist, wire user name & level + logout
        await PowerUp.session.initHeader();

        // 5) Page-specific widgets/data
        await PowerUp.renderDashboardPowerHours();
        await PowerUp.renderTokenCard();
        await PowerUp.tables.hydrateDashboardTables();

        // 6) Let any listeners know data is ready
        document.dispatchEvent(new Event('data-hydrated'));
      } catch (e) {
        console.error(e);
      }
    })();
  </script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const session = (window.PowerUp?.session?.get && window.PowerUp.session.get()) || {};
  const displayName = (session.displayName || session.userName || "").trim();
  if (!displayName) return; // no change if we can't resolve a name

  // Base form URLs
  const forms = {
    "ci-add":      "https://app.smartsheet.com/b/form/e60862d9ae0b44358d6f85dcd1c81d2b",
    "safety-add":  "https://app.smartsheet.com/b/form/162129580c03440f88cc5f284627b52f",
    "quality-add": "https://app.smartsheet.com/b/form/2ba4ff03861d4d068ee5a0bff46308c3"
  };

  // If any form uses a different label, override per-id here
  const FIELD_LABEL_BY_ID = {
    "ci-add": "Submitted By",
    "safety-add": "Submitted By",
    "quality-add": "Submitted By"
  };

  for (const [id, base] of Object.entries(forms)) {
    const a = document.getElementById(id);
    if (!a) continue;

    const fieldLabel = FIELD_LABEL_BY_ID[id] || "Submitted By";
    const param = encodeURIComponent(fieldLabel) + "=" + encodeURIComponent(displayName);
    a.href = base + (base.includes("?") ? "&" : "?") + param;
  }
});
</script>

</body>
</html>









