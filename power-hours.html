<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PowerUp — Power Hours</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="page-wrap">
    <div class="header-row">
      <div>
        <div class="title">Power Hours</div>
        <div class="muted">Signed in as <span data-hook="userName">—</span> · <span data-hook="userLevel">—</span></div>
      </div>
    </div>

    <div class="filters">
      <label class="muted">Range:</label>
      <select id="range">
        <option value="this-month">This Month</option>
        <option value="last-3">Last 3 Months</option>
        <option value="all">All</option>
      </select>
      <button id="refresh">Refresh</button>
    </div>

    <div class="metrics">
      <div class="metric">Completed Hours: <strong><span id="m-hours">0</span></strong></div>
      <div class="metric">Sessions: <strong><span id="m-sessions">0</span></strong></div>
      <div class="metric">Scheduled (upcoming): <strong><span id="m-sched">0</span></strong></div>
    </div>

    <div class="table-card">
      <div class="table-scroll">
        <table id="tbl">
          <thead>
            <tr>
              <th data-k="Date">Date</th>
              <th data-k="Start">Start</th>
              <th data-k="End">End</th>
              <th class="right" data-k="Completed Hours">Completed Hours</th>
              <th data-k="Scheduled">Scheduled</th>
              <th data-k="Completed">Completed</th>
              <th data-k="Topic">Topic</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="7" class="muted" style="text-align:center;padding:20px;">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== JS ===== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" defer></script>
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/layout.js"></script>

  <script>
    // ---- column name map (adjust if your titles differ) ----
    const COLS = {
      employeeId: ['Employee ID','Position ID'],
      date: ['Date','Session Date','Power Hour Date'],
      start: ['Start Time','Start'],
      end: ['End Time','End'],
      completedHours: ['Completed Hours','Hours','Duration (h)'],
      scheduled: ['Scheduled','Is Scheduled?','Planned'],
      completed: ['Completed','Is Completed?','Done'],
      topic: ['Topic','Description','Notes']
    };

    const pick = (row, list, d='') => { for (const k of list) if (row[k]!=null && row[k]!=='') return row[k]; return d; };
    const isTrue = (v) => String(v).toLowerCase()==='true' || v===true || String(v).toLowerCase()==='yes';
    const parseDate = (v)=>{ const d=new Date(v); return isNaN(d)?null:d; };

    const state = { all: [], view: [] };

    function byCurrentUser(row, empId) {
      const rid = (pick(row, COLS.employeeId, '')+'').trim();
      return rid === (empId+'').trim();
    }

    function withinRange(row, range) {
      if (range === 'all') return true;
      const d = parseDate(pick(row, COLS.date));
      if (!d) return false;
      const now = new Date();
      const firstOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      if (range === 'this-month') return d >= firstOfThisMonth && d <= now;
      if (range === 'last-3') {
        const start = new Date(now.getFullYear(), now.getMonth()-2, 1);
        return d >= start && d <= now;
      }
      return true;
    }

    function render() {
      const tb = document.getElementById('rows');
      if (!state.view.length) {
        tb.innerHTML = `<tr><td colspan="7" class="muted" style="text-align:center;padding:20px;">No rows</td></tr>`;
      } else {
        tb.innerHTML = state.view.map(r => {
          const dt = pick(r, COLS.date);
          const st = pick(r, COLS.start);
          const en = pick(r, COLS.end);
          const hrs = PowerUp.api.toNumber(pick(r, COLS.completedHours, 0)).toFixed(2);
          const sch = isTrue(pick(r, COLS.scheduled)) ? `<span class="pill pill--blue">Scheduled</span>` : '';
          const cmp = isTrue(pick(r, COLS.completed)) ? `<span class="pill pill--green">Completed</span>` : '';
          const tp = pick(r, COLS.topic);
          return `<tr>
            <td>${dt || ''}</td>
            <td>${st || ''}</td>
            <td>${en || ''}</td>
            <td class="right">${hrs}</td>
            <td>${sch}</td>
            <td>${cmp}</td>
            <td>${tp || ''}</td>
          </tr>`;
        }).join('');
      }
      const totalHrs = state.view.reduce((a,r)=> a + PowerUp.api.toNumber(pick(r, COLS.completedHours, 0)), 0);
      const sessions = state.view.length;
      const now = new Date();
      const upcoming = state.all.filter(r=>{
        const d = parseDate(pick(r, COLS.date));
        return isTrue(pick(r, COLS.scheduled)) && d && d >= now && !isTrue(pick(r, COLS.completed));
      }).length;
      document.getElementById('m-hours').textContent = totalHrs.toFixed(2);
      document.getElementById('m-sessions').textContent = sessions;
      document.getElementById('m-sched').textContent = upcoming;
    }

    function applyRange() {
      const range = document.getElementById('range').value;
      state.view = state.all.filter(r => withinRange(r, range));
      render();
    }

    function wireSort() {
      const ths = document.querySelectorAll('th[data-k]');
      ths.forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.k;
          const asc = th.dataset.sort !== 'asc';
          ths.forEach(h => h.dataset.sort='');
          th.dataset.sort = asc ? 'asc' : 'desc';
          state.view.sort((a,b)=>{
            const av = String(a[key] ?? '');
            const bv = String(b[key] ?? '');
            if (key === 'Completed Hours') {
              return asc ? (PowerUp.api.toNumber(av)-PowerUp.api.toNumber(bv))
                         : (PowerUp.api.toNumber(bv)-PowerUp.api.toNumber(av));
            }
            return asc ? av.localeCompare(bv) : bv.localeCompare(av);
          });
          render();
        });
      });
    }

    async function load() {
      const s = PowerUp.session.get();
      const rows = await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.POWER_HOURS);
      state.all = rows.filter(r => byCurrentUser(r, s.employeeId));
      applyRange();
      wireSort();
    }

    function bindControls() {
      const rangeEl = document.getElementById('range');
      const refreshEl = document.getElementById('refresh');
      if (!rangeEl.dataset.bound) {
        rangeEl.dataset.bound = '1';
        rangeEl.addEventListener('change', applyRange);
      }
      if (!refreshEl.dataset.bound) {
        refreshEl.dataset.bound = '1';
        refreshEl.addEventListener('click', async () => {
          refreshEl.disabled = true;
          await load();
          refreshEl.disabled = false;
        });
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      PowerUp.session.requireLogin();
      PowerUp.layout.injectLayout();
      await PowerUp.session.initHeader();
      await load();
      bindControls();
    });
  </script>
</body>
</html>
