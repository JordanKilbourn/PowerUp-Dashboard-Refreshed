<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- EARLY AUTH GUARD â€” must be the first thing in <head> -->
  <script>
  !function () {
    try {
      const s = JSON.parse(sessionStorage.getItem('pu.session') || 'null')
             || JSON.parse(localStorage.getItem('powerup_session') || 'null');
      if (!s || !s.employeeId) {
        document.documentElement.style.visibility = 'hidden';
        location.replace('login.html');
      }
    } catch {
      document.documentElement.style.visibility = 'hidden';
      location.replace('login.html');
    }
  }();
  </script>

  <title>PowerUp â€” Power Hours</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="preconnect" href="https://powerup-proxy.onrender.com" crossorigin>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="alternate icon" type="image/png" href="assets/favicon.png">

  <!-- Page-local tweaks to keep this card compact -->
  <style>
    .power-card.power-mini { max-width: 560px; padding: 12px 14px; }
    .power-card.power-mini h3 { font-size: 14px; margin-bottom: 6px; }
    .power-card.power-mini p { font-size: 14px; margin-bottom: 8px; }
    .power-card.power-mini .phbar { height: 12px; }
    .power-card.power-mini .phbar__thumb { width: 12px; height: 12px; }

    .metrics { display:flex; gap:18px; flex-wrap:wrap; align-items:center; }
    .metrics .label { color: var(--info); margin-right: 6px; }
    .metrics .value { font-weight: 700; }
  </style>
</head>
<body>
  <!-- layout.js injects sidebar + header; everything below becomes .content -->
  <div class="content-inner" style="padding: 12px 14px 16px;">

    <!-- === PROGRESS CARD (same hooks used in scripts/progress.js) === -->
    <div class="card power-card power-mini" style="margin-bottom: 14px;">
      <h3>Power Hours Logged</h3>
      <p>
        <span data-hook="ph.total">0.0</span> /
        <span data-hook="ph.goalMax">8</span>
      </p>

      <div class="phbar"
           data-hook="ph.track"
           role="progressbar"
           aria-valuemin="0"
           aria-valuemax="8"
           aria-valuenow="0">
        <div class="phbar__fill"  data-hook="ph.fill"></div>
        <div class="phbar__thumb" data-hook="ph.thumb" title="Current"></div>
      </div>

      <small data-hook="ph.message">â€”</small>
    </div>

    <!-- Header row with Date Range filter -->
    <div class="table-header-row" style="margin: 8px 0 10px;">
      <h3 style="font-size:16px;">Power Hour Sessions</h3>
      <div class="table-header-controls" style="margin-left:auto; gap:8px;">
        <label class="muted" for="range">Date Range</label>
        <select id="range">
          <option value="this-month">This Month</option>
          <option value="last-month">Last Month</option>
          <option value="last-3">Last 3 Months</option>
          <option value="last-6">Last 6 Months</option>
          <option value="this-quarter">This Quarter</option>
          <option value="ytd">Year to Date</option>
          <option value="next-month">Next Month</option>
          <option value="next-90">Next 90 Days</option>
          <option value="all">All</option>
        </select>
      </div>
    </div>

    <!-- compact metrics strip -->
    <div class="card" style="margin:0 0 10px;">
      <div class="metrics">
        <div><span class="label">Sessions:</span> <span class="value" id="m-sessions">0</span></div>
        <div><span class="label">Hours:</span> <span class="value" id="m-hours">0.00</span></div>
        <div>
          <span class="label">Upcoming scheduled:</span>
          <span class="value" id="m-sched">0</span> /
          <span class="value" id="m-sched-hours">0.00</span> h
        </div>
      </div>
    </div>

    <!-- Sessions table (Employee column appears for admins) -->
    <div class="card table-card">
      <div class="table-scroll">
        <table id="ph-table" class="dashboard-table">
          <thead>
          <tr id="ph-head-row">
            <!-- headers injected by JS to support admin Employee column -->
          </tr>
          </thead>
          <tbody id="rows">
            <tr><td class="muted" style="text-align:center;padding:20px;">Loadingâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== JS ===== -->
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/roles.js"></script>
  <script src="scripts/layout.js"></script>

  <!-- Progress card logic (now supports employeeIdOverride) -->
  <script src="scripts/progress.js"></script>

 <script>
  (function(){
    const IS_ADMIN = !!(window.PowerUp?.auth?.isAdmin && PowerUp.auth.isAdmin());
    const COLS = { /* â€¦ unchanged â€¦ */ };

    const pick = (row, list, d='') => { for (const k of list) if (row[k]!=null && row[k]!=='' ) return row[k]; return d; };
    const isTrue = (v) => v === true || /^(true|yes|y|checked)$/i.test(String(v ?? "").trim());
    const toNum  = PowerUp.api.toNumber;
    const fmt    = (v) => (v==null || String(v).trim()==='') ? '-' : String(v);

    function parseDateLocal(s){ /* â€¦ unchanged â€¦ */ }

    const state = { all: [], view: [], nameById: new Map(), target: null };

    // >>> change: return null for ALL Employees (admin)
    async function resolveTargetEmployee(){
      const me = PowerUp.session.get() || {};
      if (!IS_ADMIN) return { id: String(me.employeeId||'').trim(), name: String(me.displayName||'').trim() };
      const selName = (sessionStorage.getItem('pu.adminEmployeeFilter') || '').trim();
      if (!selName || selName === '__ALL__') return null; // ALL => show everyone
      try {
        const em = await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.EMPLOYEE_MASTER);
        const norm = (s) => String(s||'').trim().toLowerCase();
        const row = em.find(r => norm(r['Display Name']||r['Employee Name']||r['Name']) === norm(selName));
        const id = row ? String(row['Position ID'] || row['Employee ID'] || '').trim() : '';
        return { id, name: selName };
      } catch {
        return { id: String(me.employeeId||'').trim(), name: String(me.displayName||'').trim() };
      }
    }

    function byTarget(row, target) {
      if (!target) return true; // <<< ALL employees
      const id = String(pick(row, COLS.employeeId, '')).trim().toLowerCase();
      const name = String(pick(row, COLS.employeeName, '')).trim().toLowerCase();
      const tgtId = String(target.id||'').trim().toLowerCase();
      const tgtName = String(target.name||'').trim().toLowerCase();
      return (tgtId && id === tgtId) || (tgtName && name === tgtName);
    }
    
      // ---------- ranges ----------
      function firstOfMonth(y, m){ return new Date(y, m, 1); }
      function lastOfMonth(y, m){ return new Date(y, m+1, 0, 23,59,59,999); }

      function getRangeBounds(kind){
        const now = new Date();
        const y = now.getFullYear(), m = now.getMonth();
        const todayEnd = new Date(y, m, now.getDate(), 23,59,59,999);

        switch (kind) {
          case 'this-month':   return { start: firstOfMonth(y, m), end: todayEnd };
          case 'last-month': { const lm=m-1, ly=lm<0?y-1:y, lmm=(lm+12)%12; return { start:firstOfMonth(ly,lmm), end:lastOfMonth(ly,lmm) }; }
          case 'last-3':       return { start: firstOfMonth(y, m-2), end: todayEnd };
          case 'last-6':       return { start: firstOfMonth(y, m-5), end: todayEnd };
          case 'this-quarter': { const q=Math.floor(m/3)*3; return { start:firstOfMonth(y,q), end:todayEnd }; }
          case 'ytd':          return { start: new Date(y, 0, 1), end: todayEnd };
          case 'next-month': { const nm=m+1, ny=nm>11?y+1:y, nmm=nm%12; return { start:firstOfMonth(ny,nmm), end:lastOfMonth(ny,nmm) }; }
          case 'next-90':    { const s=new Date(y,m,now.getDate()); const e=new Date(s); e.setDate(e.getDate()+89); e.setHours(23,59,59,999); return { start:s, end:e }; }
          case 'all':
          default:             return { start: null, end: null };
        }
      }

      function withinRange(row, range) {
        if (range === 'all') return true;
        const d = parseDateLocal(pick(row, COLS.date));
        if (!d) return false;
        const { start, end } = getRangeBounds(range);
        if (start && d < start) return false;
        if (end && d > end) return false;
        return true;
      }

      function buildHead(){
        const tr = document.getElementById('ph-head-row');
        const heads = [
          ...(IS_ADMIN ? ['Employee'] : []),
          'Date','Start','End','Completed Hours','Scheduled','Completed','Topic'
        ];
        tr.innerHTML = heads.map(h => `<th>${h}</th>`).join('');
      }

      function renderTable() {
        const tb = document.getElementById('rows');
        if (!state.view.length) {
          tb.innerHTML = `<tr><td colspan="${IS_ADMIN?8:7}" class="muted" style="text-align:center;padding:20px;">No rows</td></tr>`;
          document.getElementById('m-hours').textContent = '0.00';
          document.getElementById('m-sessions').textContent = '0';
          document.getElementById('m-sched').textContent = '0';
          document.getElementById('m-sched-hours').textContent = '0.00';
          return;
        }

        tb.innerHTML = state.view.map(r => {
          const empId  = String(pick(r, COLS.employeeId, '')).trim();
          const empNm  = state.nameById.get(empId.toLowerCase()) || pick(r, COLS.employeeName, '') || empId || '-';
          const dt  = fmt(pick(r, COLS.date));
          const st  = fmt(pick(r, COLS.start));
          const en  = fmt(pick(r, COLS.end));
          const hrs = toNum(pick(r, COLS.completedHours, 0)).toFixed(2);
          const sch = isTrue(pick(r, COLS.scheduled)) ? `<span class="pill pill--blue">Scheduled</span>` : '-';
          const cmp = isTrue(pick(r, COLS.completed)) ? `<span class="pill pill--green">Completed</span>` : '-';
          const tp  = fmt(pick(r, COLS.topic));
          return `<tr>
            ${IS_ADMIN ? `<td>${empNm}</td>` : ``}
            <td>${dt}</td>
            <td>${st}</td>
            <td>${en}</td>
            <td class="t-right mono">${hrs}</td>
            <td class="t-center">${sch}</td>
            <td class="t-center">${cmp}</td>
            <td class="wrap">${tp}</td>
          </tr>`;
        }).join('');

        // metrics
        const totalHrs = state.view.reduce((a,r)=> a + toNum(pick(r, COLS.completedHours, 0)), 0);
        const sessions = state.view.length;

        // upcoming scheduled from ALL rows (future, scheduled, not completed) â€” for the target employee only
        const now = new Date();
        const upcoming = state.all.filter(r=>{
          if (!byTarget(r, state.target)) return false;
          const d = parseDateLocal(pick(r, COLS.date));
          const scheduled = isTrue(pick(r, COLS.scheduled));
          const completed = isTrue(pick(r, COLS.completed));
          return scheduled && !completed && d && d >= now;
        });
        const upcomingCount = upcoming.length;
        const upcomingHours = upcoming.reduce((sum, r) => sum + toNum(pick(r, COLS.durationPlanned, 0)), 0);

        document.getElementById('m-hours').textContent = totalHrs.toFixed(2);
        document.getElementById('m-sessions').textContent = sessions;
        document.getElementById('m-sched').textContent = String(upcomingCount);
        document.getElementById('m-sched-hours').textContent = upcomingHours.toFixed(2);
      }

      function applyRange() {
        const range = document.getElementById('range').value;
        state.view = state.all.filter(r => byTarget(r, state.target) && withinRange(r, range));
        renderTable();
      }

      async function loadNames() {
        state.nameById.clear();
        try {
          const em = await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.EMPLOYEE_MASTER);
          em.forEach(r => {
            const id = String(r['Position ID'] || r['Employee ID'] || '').trim();
            const nm = String(r['Display Name'] || r['Employee Name'] || r['Name'] || '').trim();
            if (id) state.nameById.set(id.toLowerCase(), nm);
          });
        } catch {}
      }

      async function loadTableAndProgress() {
        state.target = await resolveTargetEmployee();
        buildHead();
        await loadNames();

        const rows = await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.POWER_HOURS);
        state.all = rows;

        applyRange();

        // ðŸ”¹ Render the progress card for the *target employee* (admin-aware)
        await PowerUp.renderDashboardPowerHours({ employeeIdOverride: state.target.id });
      }

      function bindControls() {
        const sel = document.getElementById('range');
        if (sel) sel.addEventListener('change', applyRange);

        // Re-apply instantly when the admin changes the selected employee
        document.addEventListener('powerup-admin-filter-change', async () => {
          state.target = await resolveTargetEmployee();
          applyRange();

          // ðŸ”¹ Also refresh the progress card for the new target
          await PowerUp.renderDashboardPowerHours({ employeeIdOverride: state.target.id });
        });
      }

      document.addEventListener('DOMContentLoaded', async () => {
        PowerUp.session.requireLogin();
        PowerUp.layout.injectLayout();
        PowerUp.layout.setPageTitle('Power Hours');
        await PowerUp.session.initHeader();
        await loadTableAndProgress();
        bindControls();
      });
    })();
  </script>
</body>
</html>

