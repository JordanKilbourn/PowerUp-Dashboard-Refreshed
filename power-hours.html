<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- EARLY AUTH GUARD (unchanged) -->
  <script>
  !function () {
    try {
      const s = JSON.parse(sessionStorage.getItem('pu.session') || 'null')
             || JSON.parse(localStorage.getItem('powerup_session') || 'null');
      if (!s || !s.employeeId) {
        document.documentElement.style.visibility = 'hidden';
        location.replace('login.html');
      }
    } catch {
      document.documentElement.style.visibility = 'hidden';
      location.replace('login.html');
    }
  }();
  </script>

  <title>PowerUp — Power Hours</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="preconnect" href="https://powerup-proxy.onrender.com" crossorigin>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="alternate icon" type="image/png" href="assets/favicon.png">

  <style>
    /* --- ONLY layout/look tweaks; no feature changes --- */

    /* Header filters row right under “Welcome / Level / Refresh” */
    #pu-header .header-filters-row{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:8px;         /* stay on same side of the divider */
      flex-wrap:nowrap;       /* keep single line on normal widths */
    }
    /* Group wrappers keep label + control together */
    #pu-header .header-filters-row .hgrp{
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    #pu-header .header-filters-row label{ color:var(--muted,#a7b0bf); font-size:14px; }
    #pu-header .header-filters-row select{ width:auto; }

    /* Allow admin filter to shrink instead of forcing a wrap */
    #pu-admin-filter{ flex:0 1 520px; min-width:320px; }
    #pu-date-range{ flex:0 0 auto; }
    #pu-log-wrap{ flex:0 0 auto; }

    /* Progress card: compact + accent border like dashboard */
    .power-card.power-mini{
      border:1px solid #00ffc6;
      padding: 14px 16px;
      border-radius: 14px;
      background: #0b1020;
      max-width: 560px;
    }
    .power-card.power-mini h3{
      color:#00ffc6;
      font-size:16px;
      margin:0 0 6px;
      letter-spacing:.2px;
    }

    /* Progress number format aligned to dashboard vibe */
    .phbar{height:14px; background:#101826; border-radius:10px; position:relative}
    .phbar__fill{height:100%; border-radius:10px; background:#00e0b0; width:0}
    .phbar__thumb{position:absolute; top:50%; transform:translate(-50%,-50%); width:14px; height:14px; border-radius:50%; background:#e5fff8; box-shadow:0 0 0 2px rgba(0,255,198,.35)}
    .ph-hint{margin-top:6px; font-size:12px; color:#aeb6c5}

    /* Metric tiles unchanged; keep your current look */
    .metrics-row{display:flex; gap:12px; flex-wrap:wrap; margin:10px 0 8px}
    .metric{flex:1 1 220px}

    /* Date Range + Log button area in the header (not beside refresh) */
    .header-inline-select{ min-width: 220px; }
    .btn-log{
      padding:12px 16px;
      border-radius: 14px;
      background: #0fd5a9;
      border: 0;
      color: #06121c;
      font-weight: 800;
      box-shadow: 0 12px 30px rgba(15,213,169,.25), inset 0 1px 0 rgba(255,255,255,.15);
      transition: transform .05s ease;
      cursor:pointer;
    }
    .btn-log:hover{ filter:brightness(1.05) }
    .btn-log:active{ transform:translateY(1px) }
    .btn-log .ico{ margin-right:8px }

    /* Table header row remains the same */
  </style>
</head>
<body>
  <div class="content-inner" style="padding: 12px 14px 16px;">

    <!-- compact progress card (same numbers, improved style) -->
    <div class="card power-card power-mini" style="margin-bottom: 14px;">
      <h3>Power Hours Logged</h3>
      <p>
        <span data-hook="ph.total">0.0</span> /
        <span data-hook="ph.goalMax">8</span>
      </p>

      <div class="phbar"
           data-hook="ph.track"
           role="progressbar"
           aria-valuemin="0"
           aria-valuemax="8"
           aria-valuenow="0">
        <div class="phbar__fill"  data-hook="ph.fill"></div>
        <div class="phbar__thumb" data-hook="ph.thumb" title="Current"></div>
      </div>

      <div class="ph-hint" data-hook="ph.message">—</div>
    </div>

    <!-- metrics strip -->
    <div class="metrics-row">
      <div class="card metric">
        <div class="metric__title"><i class="fa-regular fa-calendar"></i> Sessions</div>
        <div class="metric__value" id="m-sessions">0</div>
      </div>
      <div class="card metric">
        <div class="metric__title"><i class="fa-regular fa-circle-check"></i> Completed</div>
        <div class="metric__value" id="m-completed">0</div>
      </div>
      <div class="card metric">
        <div class="metric__title"><i class="fa-solid fa-stopwatch"></i> Completed hrs</div>
        <div class="metric__value" id="m-hours">0.0</div>
      </div>
      <div class="card metric">
        <div class="metric__title"><i class="fa-regular fa-clock"></i> Upcoming</div>
        <div class="metric__value" id="m-sched">0</div>
      </div>
      <div class="card metric">
        <div class="metric__title"><i class="fa-solid fa-hourglass-half"></i> Upcoming hrs</div>
        <div class="metric__value" id="m-sched-hours">0.0</div>
      </div>
    </div>

    <!-- data table -->
    <div class="card table-card">
      <div class="table-scroll">
        <table id="ph-table" class="dashboard-table">
          <thead>
            <tr id="ph-head-row"></tr>
          </thead>
          <tbody id="rows">
            <tr><td class="muted" style="text-align:center;padding:20px;">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== JS ===== -->
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/roles.js"></script>
  <script src="scripts/layout.js"></script>
  <script src="scripts/progress.js"></script>

  <script>
  (function(){
    const IS_ADMIN = !!(window.PowerUp?.auth?.isAdmin && PowerUp.auth.isAdmin());

    // ----- column aliases (unchanged) -----
    const COLS = {
      employeeId: ['Employee ID','Position ID'],
      employeeName: ['Submitted By','Employee Name','Name','Display Name'],
      date: ['Date','Session Date','Power Hour Date'],
      start: ['Start Time','Start'],
      end: ['End Time','End'],
      completedHours: ['Completed Hours','Hours','Duration (h)','Duration (hrs)'],
      durationPlanned: ['Duration (hrs)','Duration (h)','Duration','Planned Hours','Scheduled Hours'],
      scheduled: ['Scheduled','Is Scheduled?','Planned'],
      completed: ['Completed','Is Completed?','Done'],
      topic: ['Activity Description','Activity','Topic','Description','Notes'],
      squad: ['Squad']        // text/number column per your note
    };

    // ----- helpers (unchanged logic) -----
    const pick = (row, list, d='') => { for (const k of list) if (row[k]!=null && row[k]!=='' ) return row[k]; return d; };
    const isTrue = (v) => v === true || /^(true|yes|y|checked|1)$/i.test(String(v ?? "").trim());
    const toNum  = (v) => window.PowerUp?.api?.toNumber ? PowerUp.api.toNumber(v) : (Number(String(v).replace(/[^0-9.\-]/g,''))||0);
    const fmt    = (v) => (v==null || String(v).trim()==='') ? '-' : String(v);
    const clamp  = (n,min,max)=>Math.max(min,Math.min(max,n));

    function parseDateLocal(s){
      if (s==null || s==='') return null;
      const t = String(s).trim();
      let m = t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (m) return new Date(+m[1], +m[2]-1, +m[3]);
      m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
      if (m){ let y=+m[3]; if (y<100) y+=2000; return new Date(y, +m[1]-1, +m[2]); }
      const d = new Date(t);
      return isNaN(d) ? null : d;
    }

    // sortable header binding (unchanged)
    function bindHeaderSort(thead, tbody){
      let state = { col: 0, asc: true };
      const applyIndicators = () => {
        thead.querySelectorAll("th").forEach((h,i)=>{
          h.setAttribute("data-sort","none");
          h.removeAttribute("aria-sort");
          if (i===state.col){
            h.setAttribute("data-sort", state.asc ? "asc":"desc");
            h.setAttribute("aria-sort", state.asc ? "ascending":"descending");
          }
        });
      };
      thead.querySelectorAll("th").forEach((th, idx)=>{
        th.style.cursor = "pointer";
        th.onclick = () => {
          state.asc = state.col === idx ? !state.asc : true;
          state.col = idx;
          const rows = Array.from(tbody.querySelectorAll("tr"));
          rows.sort((ra, rb)=>{
            const a = ra.children[idx]?.getAttribute("data-sort") ?? "";
            const b = rb.children[idx]?.getAttribute("data-sort") ?? "";
            const na = Number(a), nb = Number(b);
            const bothNum = !isNaN(na) && !isNaN(nb);
            const cmp = bothNum ? (na - nb) : a.localeCompare(b);
            return state.asc ? cmp : -cmp;
          });
          rows.forEach(r => tbody.appendChild(r));
          applyIndicators();
        };
      });
      applyIndicators();
    }

    // ======= STATE =======
    const state = { all: [], view: [], nameById: new Map(), target: null };

    // ======= HEADER LAYOUT (fixed) =======
    function buildHeaderRow(){
      const header = document.getElementById('pu-header');
      if (!header) return;

      // clear any prior injected row(s)
      const existing = header.querySelector('.header-filters-row');
      if (existing) existing.remove();

      const row = document.createElement('div');
      row.className = 'header-filters-row';

      // --- Admin filter (only if admin) ---
      if (IS_ADMIN){
        const adminWrap = document.createElement('div');
        adminWrap.className = 'hgrp';
        adminWrap.id = 'pu-admin-filter';
        adminWrap.innerHTML = `
          <label>Admin filter:</label>
          <select id="adminEmployee" class="header-inline-select">
            <option value="__ALL__">All Employees</option>
          </select>
        `;
        row.appendChild(adminWrap);
      }

      // --- Date Range ---
      const dateWrap = document.createElement('div');
      dateWrap.className = 'hgrp';
      dateWrap.id = 'pu-date-range';
      dateWrap.innerHTML = `
        <label>Date Range</label>
        <select id="range" class="header-inline-select">
          <option value="this-month">This Month</option>
          <option value="last-month">Last Month</option>
          <option value="last-3">Last 3 Months</option>
          <option value="last-6">Last 6 Months</option>
          <option value="this-quarter">This Quarter</option>
          <option value="ytd">Year to Date</option>
          <option value="next-month">Next Month</option>
          <option value="next-90">Next 90 Days</option>
          <option value="all">All</option>
        </select>
      `;
      row.appendChild(dateWrap);

      // --- Log / Schedule button ---
      const logWrap = document.createElement('div');
      logWrap.className = 'hgrp';
      logWrap.id = 'pu-log-wrap';
      logWrap.innerHTML = `
        <button id="ph-log" type="button" class="btn-log"><span class="ico">+</span> Log / Schedule</button>
      `;
      row.appendChild(logWrap);

      // insert the whole row directly inside the header (same side of divider)
      header.appendChild(row);
    }

    // ======= RANGE + TARGET =======
    async function resolveTargetEmployee(){
      const me = PowerUp.session.get() || {};
      if (!IS_ADMIN) return { id: String(me.employeeId||'').trim(), name: String(me.displayName||'').trim() };

      const selName = (sessionStorage.getItem('pu.adminEmployeeFilter') || '').trim();
      if (!selName || selName === '__ALL__') return null;

      try {
        const em = await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.EMPLOYEE_MASTER);
        const norm = (s) => String(s||'').trim().toLowerCase();
        const row = em.find(r => norm(r['Display Name']||r['Employee Name']||r['Name']) === norm(selName));
        const id = row ? String(row['Position ID'] || row['Employee ID'] || '').trim() : '';
        return { id, name: selName };
      } catch {
        return { id: String(me.employeeId||'').trim(), name: String(me.displayName||'').trim() };
      }
    }

    function byTarget(row, target) {
      if (!target) return true;
      const id = String(pick(row, COLS.employeeId, '')).trim().toLowerCase();
      const name = String(pick(row, COLS.employeeName, '')).trim().toLowerCase();
      const tgtId = String(target.id||'').trim().toLowerCase();
      const tgtName = String(target.name||'').trim().toLowerCase();
      return (tgtId && id === tgtId) || (tgtName && name === tgtName);
    }

    function firstOfMonth(y, m){ return new Date(y, m, 1); }
    function lastOfMonth(y, m){ return new Date(y, m+1, 0, 23,59,59,999); }

    function getRangeBounds(kind){
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth();
      const todayEnd = new Date(y, m, now.getDate(), 23,59,59,999);

      switch (kind) {
        case 'this-month':   return { start: firstOfMonth(y, m), end: todayEnd };
        case 'last-month': { const lm=m-1, ly=lm<0?y-1:y, lmm=(lm+12)%12; return { start:firstOfMonth(ly,lmm), end:lastOfMonth(ly,lmm) }; }
        case 'last-3':       return { start: firstOfMonth(y, m-2), end: todayEnd };
        case 'last-6':       return { start: firstOfMonth(y, m-5), end: todayEnd };
        case 'this-quarter': { const q=Math.floor(m/3)*3; return { start:firstOfMonth(y,q), end:todayEnd }; }
        case 'ytd':          return { start: new Date(y, 0, 1), end: todayEnd };
        case 'next-month': { const nm=m+1, ny=nm>11?y+1:y, nmm=nm%12; return { start:firstOfMonth(ny,nmm), end:lastOfMonth(ny,nmm) }; }
        case 'next-90':    { const s=new Date(y,m,now.getDate()); const e=new Date(s); e.setDate(e.getDate()+89); e.setHours(23,59,59,999); return { start:s, end:e }; }
        case 'all':
        default:             return { start: null, end: null };
      }
    }

    function withinRange(row, range) {
      if (range === 'all') return true;
      const d = parseDateLocal(pick(row, COLS.date));
      if (!d) return false;
      const { start, end } = getRangeBounds(range);
      if (start && d < start) return false;
      if (end && d > end) return false;
      return true;
    }

    // ======= TABLE/RENDER =======
    function buildHead(){
      const tr = document.getElementById('ph-head-row');
      const heads = [
        ...(IS_ADMIN ? ['Employee'] : []),
        'Date','Start','End','Completed Hours','Scheduled','Completed','Topic'
      ];
      tr.innerHTML = heads.map(h => `<th>${h}</th>`).join('');
    }

    function renderTable() {
      const tb = document.getElementById('rows');

      if (!state.view.length) {
        tb.innerHTML = `<tr><td colspan="${IS_ADMIN?8:7}" class="muted" style="text-align:center;padding:20px;">No rows</td></tr>`;
      } else {
        tb.innerHTML = state.view.map(r => {
          const empId  = String(pick(r, COLS.employeeId, '')).trim();
          const empNm  = state.nameById.get(empId.toLowerCase()) || pick(r, COLS.employeeName, '') || empId || '-';

          const dStr = String(pick(r, COLS.date) ?? '');
          const d = parseDateLocal(dStr);
          const dateSort = d ? String(d.getTime()) : dStr.toLowerCase();

          const st  = String(pick(r, COLS.start) ?? '');
          const en  = String(pick(r, COLS.end) ?? '');
          const hrsNum = toNum(pick(r, COLS.completedHours, 0));
          const isSched = isTrue(pick(r, COLS.scheduled));
          const isComp  = isTrue(pick(r, COLS.completed));
          const tp  = String(pick(r, COLS.topic) ?? '');

          return `<tr>
            ${IS_ADMIN ? `<td data-sort="${empNm.toLowerCase()}">${empNm || '-'}</td>` : ``}
            <td data-sort="${dateSort}">${d ? `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}` : (dStr||'-')}</td>
            <td data-sort="${st.toLowerCase()}">${fmt(st)}</td>
            <td data-sort="${en.toLowerCase()}">${fmt(en)}</td>
            <td class="t-right mono" data-sort="${hrsNum}">${hrsNum.toFixed(2)}</td>
            <td class="t-center" data-sort="${isSched ? 1 : 0}">${isSched ? `<span class="pill pill--blue">Scheduled</span>` : '-'}</td>
            <td class="t-center" data-sort="${isComp ? 1 : 0}">${isComp ? `<span class="pill pill--green">Completed</span>` : '-'}</td>
            <td class="wrap" data-sort="${tp.toLowerCase()}">${fmt(tp)}</td>
          </tr>`;
        }).join('');
      }

      // metrics
      const totalHrs = state.view.reduce((a,r)=> a + toNum(pick(r, COLS.completedHours, 0)), 0);
      const sessions = state.view.length;

      const now = new Date();
      const upcoming = state.all.filter(r=>{
        if (!byTarget(r, state.target)) return false;
        const d = parseDateLocal(pick(r, COLS.date));
        const scheduled = isTrue(pick(r, COLS.scheduled));
        const completed = isTrue(pick(r, COLS.completed));
        return scheduled && !completed && d && d >= now;
      });
      const upcomingCount = upcoming.length;
      const upcomingHours = upcoming.reduce((sum, r) => sum + toNum(pick(r, COLS.durationPlanned, 0)), 0);

      document.getElementById('m-hours').textContent = totalHrs.toFixed(2);
      document.getElementById('m-sessions').textContent = sessions;
      document.getElementById('m-sched').textContent = String(upcomingCount);
      document.getElementById('m-sched-hours').textContent = upcomingHours.toFixed(2);

      // wire sorting after rows exist
      const thead = document.getElementById('ph-head-row');
      bindHeaderSort(thead, tb);
    }

    function applyRange() {
      const sel = document.getElementById('range');
      const range = sel ? sel.value : 'this-month';
      state.view = state.all.filter(r => byTarget(r, state.target) && withinRange(r, range));
      renderTable();

      // progress (show one decimal like dashboard)
      const total = state.view.reduce((a,r)=> a + toNum(pick(r, COLS.completedHours, 0)), 0);
      const goal = 8; // your static goal per period
      const pct = goal > 0 ? clamp(total/goal,0,1) : 0;
      const fill = document.querySelector('[data-hook="ph.fill"]');
      const thumb = document.querySelector('[data-hook="ph.thumb"]');
      const totalEl = document.querySelector('[data-hook="ph.total"]');
      const goalEl = document.querySelector('[data-hook="ph.goalMax"]');
      const msgEl = document.querySelector('[data-hook="ph.message"]');

      totalEl.textContent = (Math.round(total*10)/10).toFixed(1); // 0.0 style
      goalEl.textContent = String(goal);

      if (fill) fill.style.width = `${pct*100}%`;
      if (thumb) thumb.style.left = `${pct*100}%`;

      const left = Math.max(0, goal - total);
      const { start, end } = getRangeBounds((document.getElementById('range')||{}).value || 'this-month');
      let daysLeftText = '';
      if (end){
        const now = new Date();
        const ms = end - now;
        const days = Math.max(0, Math.ceil(ms / (24*60*60*1000)));
        daysLeftText = `${days} day${days===1?'':'s'} left`;
      }
      msgEl.textContent = `${(Math.round(left*10)/10).toFixed(1)}h left to hit minimum (${goal}h)${daysLeftText ? ` — ${daysLeftText}`:''}.`;
    }

    async function loadNames() {
      state.nameById.clear();
      try {
        const em = await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.EMPLOYEE_MASTER);
        em.forEach(r => {
          const id = String(r['Position ID'] || r['Employee ID'] || '').trim();
          const nm = String(r['Display Name'] || r['Employee Name'] || r['Name'] || '').trim();
          if (id) state.nameById.set(id.toLowerCase(), nm);
        });

        if (IS_ADMIN){
          const sel = document.getElementById('adminEmployee');
          if (sel){
            const opts = ['<option value="__ALL__">All Employees</option>'].concat(
              em
               .map(r => String(r['Display Name'] || r['Employee Name'] || r['Name'] || '').trim())
               .filter(Boolean)
               .sort((a,b)=> a.localeCompare(b))
               .map(nm => `<option value="${nm}">${nm}</option>`)
            );
            sel.innerHTML = opts.join('');
            const prev = sessionStorage.getItem('pu.adminEmployeeFilter') || '__ALL__';
            sel.value = prev;
          }
        }
      } catch {}
    }

    async function loadRowsSafe() {
      try {
        if (PowerUp.api.getRowsByTitle) {
          return await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.POWER_HOURS);
        }
        const sheet = await PowerUp.api.fetchSheet(PowerUp.api.SHEETS.POWER_HOURS);
        return PowerUp.api.rowsByTitle(sheet);
      } catch {
        return [];
      }
    }

    async function loadTableAndProgress() {
      state.target = await resolveTargetEmployee();
      buildHead();
      await loadNames();
      state.all = await loadRowsSafe();
      applyRange();
      await PowerUp.renderDashboardPowerHours(); // unchanged behavior
    }

    function bindControls() {
      const sel = document.getElementById('range');
      if (sel) sel.addEventListener('change', applyRange);

      if (IS_ADMIN) {
        const adminSel = document.getElementById('adminEmployee');
        if (adminSel){
          adminSel.addEventListener('change', async (e) => {
            sessionStorage.setItem('pu.adminEmployeeFilter', e.target.value || '__ALL__');
            state.target = await resolveTargetEmployee();
            applyRange();
            // let the rest of the app know (existing event)
            try { document.dispatchEvent(new CustomEvent('powerup-admin-filter-change')); } catch {}
          });
        }
      }

      const logBtn = document.getElementById('ph-log');
      if (logBtn && window.PowerUp?.openPowerHourModal){
        logBtn.addEventListener('click', () => PowerUp.openPowerHourModal());
      }
    }

    // ===== BOOTSTRAP =====
    document.addEventListener('DOMContentLoaded', async () => {
      PowerUp.session.requireLogin();
      PowerUp.layout.injectLayout();
      PowerUp.layout.setPageTitle('Power Hours');
      await PowerUp.session.initHeader();

      buildHeaderRow();     // <-- injects the one-row header toolbar (fixed)
      await loadTableAndProgress();
      bindControls();
    });
  })();
  </script>
</body>
</html>
