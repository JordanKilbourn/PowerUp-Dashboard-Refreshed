<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- EARLY AUTH GUARD -->
  <script>
  !function () {
    try {
      const s = JSON.parse(sessionStorage.getItem('pu.session') || 'null')
             || JSON.parse(localStorage.getItem('powerup_session') || 'null');
      if (!s || !s.employeeId) {
        document.documentElement.style.visibility = 'hidden';
        location.replace('login.html');
      }
    } catch {
      document.documentElement.style.visibility = 'hidden';
      location.replace('login.html');
    }
  }();
  </script>

  <title>PowerUp — Power Hours</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="preconnect" href="https://powerup-proxy.onrender.com" crossorigin>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="alternate icon" type="image/png" href="assets/favicon.png">

  <style>
    /* Compact inline controls injected beside the Admin filter */
    .inline-controls {
      display:inline-flex; align-items:center; gap:10px; margin-left:10px;
      vertical-align: middle;
    }
    .inline-controls .range-inline {
      display:inline-flex; align-items:center; gap:8px;
    }
    .inline-controls label { color:#9fb0c3; font-size:13px; }
    .inline-controls select {
      padding: 8px 10px; border-radius: 8px;
      background:#0b1328; border:1px solid #293449; color:#e5e7eb;
    }
    .inline-controls .btn-cta {
      padding:8px 10px; border-radius:10px; font-weight:700; cursor:pointer;
      background:#10b981; border:1px solid #0e9f73; color:#04241d;
    }
    .inline-controls .btn-cta:hover { filter:brightness(1.03); }

    /* Fallback if we must place controls ourselves (rare) */
    .inline-controls.standalone {
      display:flex; align-items:center; gap:10px;
      margin: 8px 0 4px;
    }

    /* Progress card */
    .power-card.power-mini { max-width: 560px; padding: 12px 14px; }
    .power-card.power-mini h3 { font-size: 14px; margin-bottom: 6px; }
    .power-card.power-mini p { font-size: 14px; margin-bottom: 8px; }
    .power-card.power-mini .phbar { height: 12px; }
    .power-card.power-mini .phbar__thumb { width: 12px; height: 12px; }

    /* Metrics rail */
    .stats-rail {
      display: grid;
      grid-template-columns: repeat(12, minmax(0,1fr));
      gap: 8px;
      margin: 10px 0 12px;
    }
    .stat {
      grid-column: span 2 / span 2;
      display:flex; align-items:center; gap:10px;
      background: rgba(18,24,38,.55);
      border:1px solid #233046;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,.15) inset, 0 1px 0 rgba(255,255,255,.03);
      min-width: 180px;
    }
    @media (max-width: 1200px) { .stat { grid-column: span 3 / span 3; } }
    @media (max-width: 920px)  { .stat { grid-column: span 4 / span 4; } }
    @media (max-width: 640px)  { .stat { grid-column: span 6 / span 6; } }
    .stat .ico {
      width:28px; height:28px; display:grid; place-items:center;
      border-radius: 8px; background:#0c1a2d; border:1px solid #1f2b41;
      box-shadow: 0 0 0 2px rgba(0,255,198,.06);
      color:#9cc9ff; flex: 0 0 auto;
    }
    .stat .meta { line-height:1.15 }
    .stat .label { font-size:12px; color:#9fb0c3 }
    .stat .value { font-weight:700; font-variant-numeric: tabular-nums; }
    .stat--sessions  .ico { color:#a8e0ff; }
    .stat--completed .ico { color:#67e8f9; }
    .stat--comp-hrs  .ico { color:#34d399; }
    .stat--upcoming  .ico { color:#93c5fd; }
    .stat--up-hrs    .ico { color:#fbbf24; }

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9998}
    .modal[aria-hidden="false"]{display:flex}
    .modal-card{background:#0b1020;border:1px solid #294957;border-radius:14px;padding:16px 16px 14px;min-width:320px;max-width:640px;width:94%}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .modal-head h3{margin:0;color:#00ffc6;font-size:18px}
    .modal-body{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:13px;color:#cbd5e1}
    .field input,.field select,.field textarea{padding:10px;border-radius:10px;background:#0b1328;border:1px solid #293449;color:#e5e7eb;outline:none}
    .field textarea{min-height:72px;resize:vertical}
    .span-6{grid-column:span 6 / span 6}
    .span-3{grid-column:span 3 / span 3}
    .span-12{grid-column:span 12 / span 12}
    .row{display:flex;gap:8px;align-items:center}
    .hint{font-size:12px;color:#9ca3af}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #2a354b;background:#111a2f;color:#e5e7eb;cursor:pointer}
    .btn.primary{background:#10b981;border-color:#0e9f73;color:#04241d;font-weight:700}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .error{margin-top:8px;color:#fecaca;background:#450a0a;border:1px solid #7f1d1d;padding:8px 10px;border-radius:10px;display:none}
    .ok{margin-top:8px;color:#bbf7d0;background:#052e22;border:1px solid #0f5132;padding:8px 10px;border-radius:10px;display:none}
    .switch{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:#9fb0c3;cursor:pointer}
  </style>
</head>
<body>
  <div class="content-inner" style="padding: 12px 14px 16px;">

    <!-- Progress -->
    <div class="card power-card power-mini" style="margin-bottom: 10px;">
      <h3>Power Hours Logged</h3>
      <p>
        <span data-hook="ph.total">0.0</span> /
        <span data-hook="ph.goalMax">8</span>
      </p>

      <div class="phbar"
           data-hook="ph.track"
           role="progressbar"
           aria-valuemin="0"
           aria-valuemax="8"
           aria-valuenow="0">
        <div class="phbar__fill"  data-hook="ph.fill"></div>
        <div class="phbar__thumb" data-hook="ph.thumb" title="Current"></div>
      </div>

      <small data-hook="ph.message">—</small>
    </div>

    <!-- Metrics -->
    <div class="stats-rail">
      <div class="stat stat--sessions" role="status" aria-live="polite">
        <div class="ico"><i class="fa-regular fa-calendar-check" aria-hidden="true"></i></div>
        <div class="meta"><div class="label">Sessions</div><div class="value" id="m-sessions">0</div></div>
      </div>
      <div class="stat stat--completed">
        <div class="ico"><i class="fa-solid fa-circle-check" aria-hidden="true"></i></div>
        <div class="meta"><div class="label">Completed</div><div class="value" id="m-comp">0</div></div>
      </div>
      <div class="stat stat--comp-hrs">
        <div class="ico"><i class="fa-solid fa-stopwatch" aria-hidden="true"></i></div>
        <div class="meta"><div class="label">Completed hrs</div><div class="value" id="m-comp-hrs">0.00</div></div>
      </div>
      <div class="stat stat--upcoming">
        <div class="ico"><i class="fa-regular fa-clock" aria-hidden="true"></i></div>
        <div class="meta"><div class="label">Upcoming</div><div class="value" id="m-up">0</div></div>
      </div>
      <div class="stat stat--up-hrs">
        <div class="ico"><i class="fa-solid fa-hourglass-half" aria-hidden="true"></i></div>
        <div class="meta"><div class="label">Upcoming hrs</div><div class="value" id="m-up-hrs">0.00</div></div>
      </div>
    </div>

    <!-- Table -->
    <div class="card table-card">
      <div class="table-scroll">
        <table id="ph-table" class="dashboard-table">
          <thead><tr id="ph-head-row"></tr></thead>
          <tbody id="rows"><tr><td class="muted" style="text-align:center;padding:20px;">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="phModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="phTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="phTitle">Log / Schedule Power Hour</h3>
        <button class="btn" id="phClose">Close</button>
      </div>

      <div id="phError" class="error"></div>
      <div id="phOk" class="ok"></div>

      <div class="modal-body">
        <div class="field span-6">
          <label for="phDate">Date</label>
          <input type="date" id="phDate">
        </div>
        <div class="field span-3">
          <label for="phStart">Start Time</label>
          <select id="phStart"></select>
        </div>
        <div class="field span-3">
          <label for="phEnd">End Time</label>
          <select id="phEnd"></select>
        </div>

        <div class="field span-12">
          <label>Status</label>
          <div class="row">
            <label class="row"><input type="radio" name="phStatus" value="scheduled" id="phStatusScheduled"> <span>Scheduled</span></label>
            <label class="row" style="margin-left:16px"><input type="radio" name="phStatus" value="completed" id="phStatusCompleted"> <span>Completed</span></label>
            <span class="hint" id="phStatusHint" style="margin-left:10px"></span>
          </div>
        </div>

        <div class="field span-12">
          <label for="phTopic">Activity / Description</label>
          <textarea id="phTopic" placeholder="What will you work on (or what did you complete)?"></textarea>
        </div>

        <div class="field span-12">
          <div class="row" style="justify-content:space-between; width:100%">
            <label for="phSquad">Squad (optional)</label>
            <label class="switch"><input type="checkbox" id="phShowAllSquads"> Show all squads</label>
          </div>
          <select id="phSquad"><option value="">None</option></select>
          <div class="hint">Default shows squads you lead or belong to. Toggle to see all active squads.</div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" id="phReset">Reset</button>
        <button class="btn primary" id="phSave">Save</button>
      </div>
    </div>
  </div>

  <!-- ===== JS ===== -->
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/roles.js"></script>
  <script src="scripts/layout.js"></script>
  <script src="scripts/progress.js"></script>

  <script>
    (function(){
      const IS_ADMIN = !!(window.PowerUp?.auth?.isAdmin && PowerUp.auth.isAdmin());

      /* ----- column aliases ----- */
      const COLS = {
        employeeId: ['Employee ID','Position ID'],
        employeeName: ['Submitted By','Employee Name','Name','Display Name'],
        date: ['Date','Session Date','Power Hour Date'],
        start: ['Start Time','Start'],
        end: ['End Time','End'],
        completedHours: ['Completed Hours','Hours','Duration (h)','Duration (hrs)'],
        durationPlanned: ['Duration (hrs)','Duration (h)','Duration','Planned Hours','Scheduled Hours'],
        scheduled: ['Scheduled','Is Scheduled?','Planned'],
        completed: ['Completed','Is Completed?','Done'],
        topic: ['Activity Description','Activity','Topic','Description','Notes'],
        squad: ['Squad']
      };

      const pick = (row, list, d='') => { for (const k of list) if (row[k]!=null && row[k]!=='' ) return row[k]; return d; };
      const isTrue = (v) => v === true || /^(true|yes|y|checked|1)$/i.test(String(v ?? "").trim());
      const toNum  = (v) => window.PowerUp?.api?.toNumber ? PowerUp.api.toNumber(v) : (Number(String(v).replace(/[^0-9.\-]/g,''))||0);
      const fmt    = (v) => (v==null || String(v).trim()==='') ? '-' : String(v);

      function parseDateLocal(s){
        if (s==null || s==='') return null;
        const t = String(s).trim();
        let m = t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if (m) return new Date(+m[1], +m[2]-1, +m[3]);
        m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
        if (m){ let y=+m[3]; if (y<100) y+=2000; return new Date(y, +m[1]-1, +m[2]); }
        const d = new Date(t);
        return isNaN(d) ? null : d;
      }

      /* ===== Sorting, metrics, render ===== */
      function bindHeaderSort(thead, tbody){
        let state = { col: 0, asc: true };
        const applyIndicators = () => {
          thead.querySelectorAll("th").forEach((h,i)=>{
            h.setAttribute("data-sort","none");
            h.removeAttribute("aria-sort");
            if (i===state.col){
              h.setAttribute("data-sort", state.asc ? "asc":"desc");
              h.setAttribute("aria-sort", state.asc ? "ascending":"descending");
            }
          });
        };
        thead.querySelectorAll("th").forEach((th, idx)=>{
          th.style.cursor = "pointer";
          th.onclick = () => {
            state.asc = state.col === idx ? !state.asc : true;
            state.col = idx;
            const rows = Array.from(tbody.querySelectorAll("tr"));
            rows.sort((ra, rb)=>{
              const a = ra.children[idx]?.getAttribute("data-sort") ?? "";
              const b = rb.children[idx]?.getAttribute("data-sort") ?? "";
              const na = Number(a), nb = Number(b);
              const bothNum = !isNaN(na) && !isNaN(nb);
              const cmp = bothNum ? (na - nb) : a.localeCompare(b);
              return state.asc ? cmp : -cmp;
            });
            rows.forEach(r => tbody.appendChild(r));
            applyIndicators();
          };
        });
        applyIndicators();
      }

      const state = { all: [], view: [], nameById: new Map(), target: null, squads: [], mySquadIds: new Set() };

      const RANGE_KEY = 'pu.ph.range';
      const getSavedRange = () => sessionStorage.getItem(RANGE_KEY) || 'this-month';
      const saveRange = (v) => { try { sessionStorage.setItem(RANGE_KEY, v); } catch {} };

      async function resolveTargetEmployee(){
        const me = PowerUp.session.get() || {};
        if (!IS_ADMIN) return { id: String(me.employeeId||'').trim(), name: String(me.displayName||'').trim() };
        const selName = (sessionStorage.getItem('pu.adminEmployeeFilter') || '').trim();
        if (!selName || selName === '__ALL__') return null;
        try {
          const em = await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.EMPLOYEE_MASTER);
          const norm = (s) => String(s||'').trim().toLowerCase();
          const row = em.find(r => norm(r['Display Name']||r['Employee Name']||r['Name']) === norm(selName));
          const id = row ? String(row['Position ID'] || row['Employee ID'] || '').trim() : '';
          return { id, name: selName };
        } catch {
          return { id: String(me.employeeId||'').trim(), name: String(me.displayName||'').trim() };
        }
      }

      function byTarget(row, target) {
        if (!target) return true;
        const id = String(pick(row, COLS.employeeId, '')).trim().toLowerCase();
        const name = String(pick(row, COLS.employeeName, '')).trim().toLowerCase();
        const tgtId = String(target.id||'').trim().toLowerCase();
        const tgtName = String(target.name||'').trim().toLowerCase();
        return (tgtId && id === tgtId) || (tgtName && name === tgtName);
      }

      function firstOfMonth(y, m){ return new Date(y, m, 1); }
      function lastOfMonth(y, m){ return new Date(y, m+1, 0, 23,59,59,999); }

      function getRangeBounds(kind){
        const now = new Date();
        const y = now.getFullYear(), m = now.getMonth();
        const todayEnd = new Date(y, m, now.getDate(), 23,59,59,999);

        switch (kind) {
          case 'this-month':   return { start: firstOfMonth(y, m), end: todayEnd };
          case 'last-month': { const lm=m-1, ly=lm<0?y-1:y, lmm=(lm+12)%12; return { start:firstOfMonth(ly,lmm), end:lastOfMonth(ly,lmm) }; }
          case 'last-3':       return { start: firstOfMonth(y, m-2), end: todayEnd };
          case 'last-6':       return { start: firstOfMonth(y, m-5), end: todayEnd };
          case 'this-quarter': { const q=Math.floor(m/3)*3; return { start:firstOfMonth(y,q), end:todayEnd }; }
          case 'ytd':          return { start: new Date(y, 0, 1), end: todayEnd };
          case 'next-month': { const nm=m+1, ny=nm>11?y+1:y, nmm=nm%12; return { start:firstOfMonth(ny,nmm), end:lastOfMonth(ny,nmm) }; }
          case 'next-90':    { const s=new Date(y,m,now.getDate()); const e=new Date(s); e.setDate(e.getDate()+89); e.setHours(23,59,59,999); return { start:s, end:e }; }
          case 'all':
          default:             return { start: null, end: null };
        }
      }

      function withinRange(row, range) {
        if (range === 'all') return true;
        const d = parseDateLocal(pick(row, COLS.date));
        if (!d) return false;
        const { start, end } = getRangeBounds(range);
        if (start && d < start) return false;
        if (end && d > end) return false;
        return true;
      }

      function buildHead(){
        const tr = document.getElementById('ph-head-row');
        const heads = [
          ...(IS_ADMIN ? ['Employee'] : []),
          'Date','Start','End','Completed Hours','Scheduled','Completed','Topic'
        ];
        tr.innerHTML = heads.map(h => `<th>${h}</th>`).join('');
      }

      function updateProgressFromView() {
        const totalCompleted = state.view.reduce((a,r)=> a + toNum(pick(r, COLS.completedHours, 0)), 0);
        const goalMax = toNum(document.querySelector('[data-hook="ph.goalMax"]')?.textContent || 8) || 8;
        const pct = Math.max(0, Math.min(1, goalMax ? (totalCompleted/goalMax) : 0));

        const track = document.querySelector('[data-hook="ph.track"]');
        const fill  = document.querySelector('[data-hook="ph.fill"]');
        const thumb = document.querySelector('[data-hook="ph.thumb"]');
        const totalEl = document.querySelector('[data-hook="ph.total"]');
        const msg   = document.querySelector('[data-hook="ph.message"]');

        if (totalEl) totalEl.textContent = totalCompleted.toFixed(2);
        if (track) {
          track.setAttribute('aria-valuenow', String(Math.round(pct*goalMax)));
          track.setAttribute('aria-valuemax', String(goalMax));
        }
        if (fill)  fill.style.width = `${pct*100}%`;
        if (thumb) thumb.style.left  = `${pct*100}%`;

        if (msg) {
          const remain = Math.max(0, goalMax - totalCompleted);
          msg.textContent = `${remain.toFixed(1)}h left to hit minimum (${goalMax}h) in the selected range.`;
        }
      }

      function renderTable() {
        const tb = document.getElementById('rows');

        if (!state.view.length) {
          const who = state.target ? (state.target.name || state.target.id || 'Employee') : 'All Employees';
          const sel = document.getElementById('range');
          const label = sel?.selectedOptions?.[0]?.text || 'Current Range';
          tb.innerHTML = `<tr><td colspan="${IS_ADMIN?8:7}" class="muted" style="text-align:center;padding:20px;">No sessions for <b>${who}</b> in <b>${label}</b>.</td></tr>`;
        } else {
          tb.innerHTML = state.view.map(r => {
            const empId  = String(pick(r, COLS.employeeId, '')).trim();
            const empNm  = state.nameById.get(empId.toLowerCase()) || pick(r, COLS.employeeName, '') || empId || '-';

            const dStr = String(pick(r, COLS.date) ?? '');
            const d = parseDateLocal(dStr);
            const dateSort = d ? String(d.getTime()) : dStr.toLowerCase();

            const st  = String(pick(r, COLS.start) ?? '');
            const en  = String(pick(r, COLS.end) ?? '');
            const hrsNum = toNum(pick(r, COLS.completedHours, 0));
            const isSched = isTrue(pick(r, COLS.scheduled));
            const isComp  = isTrue(pick(r, COLS.completed));
            const tp  = String(pick(r, COLS.topic) ?? '');

            return `<tr>
              ${IS_ADMIN ? `<td data-sort="${empNm.toLowerCase()}">${empNm || '-'}</td>` : ``}
              <td data-sort="${dateSort}">${d ? `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}` : (dStr||'-')}</td>
              <td data-sort="${st.toLowerCase()}">${fmt(st)}</td>
              <td data-sort="${en.toLowerCase()}">${fmt(en)}</td>
              <td class="t-right mono" data-sort="${hrsNum}">${isFinite(hrsNum)? hrsNum.toFixed(2): '0.00'}</td>
              <td class="t-center" data-sort="${isSched ? 1 : 0}">${isSched ? `<span class="pill pill--blue">Scheduled</span>` : '-'}</td>
              <td class="t-center" data-sort="${isComp ? 1 : 0}">${isComp ? `<span class="pill pill--green">Completed</span>` : '-'}</td>
              <td class="wrap" data-sort="${tp.toLowerCase()}">${fmt(tp)}</td>
            </tr>`;
          }).join('');
        }

        const sessions = state.view.length;
        const completedRows = state.view.filter(r => isTrue(pick(r, COLS.completed)));
        const completedHrs  = completedRows.reduce((a,r)=> a + toNum(pick(r, COLS.completedHours, 0)), 0);

        const today = new Date(); today.setHours(0,0,0,0);
        const upcomingRows = state.view.filter(r => {
          const d = parseDateLocal(pick(r, COLS.date));
          return isTrue(pick(r, COLS.scheduled)) && !isTrue(pick(r, COLS.completed)) && d && d >= today;
        });
        const upcomingHrs  = upcomingRows.reduce((sum, r) => sum + toNum(pick(r, COLS.durationPlanned, 0)), 0);

        document.getElementById('m-sessions').textContent   = String(sessions);
        document.getElementById('m-comp').textContent       = String(completedRows.length);
        document.getElementById('m-comp-hrs').textContent   = completedHrs.toFixed(2);
        document.getElementById('m-up').textContent         = String(upcomingRows.length);
        document.getElementById('m-up-hrs').textContent     = upcomingHrs.toFixed(2);

        bindHeaderSort(document.getElementById('ph-head-row'), tb);
        updateProgressFromView();
      }

      function applyRange() {
        const sel = document.getElementById('range');
        const range = sel ? sel.value : 'this-month';
        saveRange(range);
        state.view = state.all.filter(r => byTarget(r, state.target) && withinRange(r, range));
        renderTable();
      }

      async function loadNames() {
        state.nameById.clear();
        try {
          const em = await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.EMPLOYEE_MASTER);
          em.forEach(r => {
            const id = String(r['Position ID'] || r['Employee ID'] || '').trim();
            const nm = String(r['Display Name'] || r['Employee Name'] || r['Name'] || '').trim();
            if (id) state.nameById.set(id.toLowerCase(), nm);
          });
        } catch {}
      }

      async function loadRowsSafe() {
        try {
          if (PowerUp.api.getRowsByTitle) {
            return await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.POWER_HOURS);
          }
          const sheet = await PowerUp.api.fetchSheet(PowerUp.api.SHEETS.POWER_HOURS);
          return PowerUp.api.rowsByTitle(sheet);
        } catch {
          return [];
        }
      }

      /* ===== Control mounting: inject beside Admin filter (or header row), not under divider ===== */
      function findAdminFilterSelect() {
        let sel = document.querySelector('[data-hook="adminFilter"]')
               || document.querySelector('#adminFilter')
               || document.querySelector('select[name="adminFilter"]');
        if (sel) return sel;

        const labels = Array.from(document.querySelectorAll('label'));
        const adminLbl = labels.find(l => /admin\s*filter/i.test((l.textContent||'').trim()));
        if (adminLbl) {
          if (adminLbl.htmlFor) {
            const byFor = document.getElementById(adminLbl.htmlFor);
            if (byFor && byFor.tagName === 'SELECT') return byFor;
          }
          const sibSel = adminLbl.parentElement && adminLbl.parentElement.querySelector('select');
          if (sibSel) return sibSel;
          const nextSel = adminLbl.nextElementSibling && adminLbl.nextElementSibling.tagName === 'SELECT'
                        ? adminLbl.nextElementSibling : null;
          if (nextSel) return nextSel;
        }
        return null;
      }

      function findHeaderControlsContainer() {
        // Try a few likely containers created by layout.js
        return (
          (document.querySelector('.table-header-controls') && document.querySelector('.table-header-controls').parentElement) ||
          document.querySelector('.page-controls') ||
          document.querySelector('.page-block .card') || // last resort (but still above divider)
          null
        );
      }

      function createInlineControls() {
        const wrap = document.createElement('span');
        wrap.className = 'inline-controls';
        wrap.innerHTML = `
          <span class="range-inline">
            <label for="range">Date Range</label>
            <select id="range" aria-label="Date Range">
              <option value="this-month">This Month</option>
              <option value="last-month">Last Month</option>
              <option value="last-3">Last 3 Months</option>
              <option value="last-6">Last 6 Months</option>
              <option value="this-quarter">This Quarter</option>
              <option value="ytd">Year to Date</option>
              <option value="next-month">Next Month</option>
              <option value="next-90">Next 90 Days</option>
              <option value="all">All</option>
            </select>
          </span>
          <button class="btn-cta" id="openPHModal"><i class="fa-solid fa-plus" aria-hidden="true"></i> Log / Schedule Power Hour</button>
        `;
        return wrap;
      }

      function mountControls(savedRange) {
        const existing = document.querySelector('.inline-controls');
        if (existing) existing.remove();

        const controls = createInlineControls();
        const adminSel = findAdminFilterSelect();

        if (adminSel && adminSel.parentElement) {
          adminSel.insertAdjacentElement('afterend', controls);
        } else {
          // Insert into header controls row (not below divider). If not found, fallback just before progress card.
          const host = findHeaderControlsContainer();
          if (host) {
            host.appendChild(controls);
          } else {
            const progressCard = document.querySelector('.power-card.power-mini');
            const container = progressCard && progressCard.parentElement ? progressCard.parentElement : document.querySelector('.content-inner');
            controls.classList.add('standalone');
            container.insertBefore(controls, progressCard || container.firstChild);
          }
        }

        const rng = document.getElementById('range');
        if (rng) {
          const v = savedRange || getSavedRange();
          if ([...rng.options].some(o => o.value === v)) rng.value = v;
          rng.onchange = applyRange;
        }

        // Wire the CTA after mount
        const btnOpen = document.getElementById('openPHModal');
        if (btnOpen) btnOpen.addEventListener('click', openModal);
      }

      function observeForAdminFilter(savedRange) {
        const obs = new MutationObserver(() => {
          const adminSel = findAdminFilterSelect();
          if (adminSel) {
            mountControls(savedRange);
            obs.disconnect();
          }
        });
        obs.observe(document.body, { childList: true, subtree: true });
      }

      /* ===== Modal logic (unchanged) ===== */
      const $ = s => document.querySelector(s);

      const modal   = $('#phModal');
      const btnClose= $('#phClose');
      const btnSave = $('#phSave');
      const btnReset= $('#phReset');

      const inpDate = $('#phDate');
      const selStart= $('#phStart');
      const selEnd  = $('#phEnd');
      const radioSched = $('#phStatusScheduled');
      const radioComp  = $('#phStatusCompleted');
      const statusHint = $('#phStatusHint');
      const txtTopic = $('#phTopic');
      const selSquad = $('#phSquad');
      const chkShowAll = $('#phShowAllSquads');

      const errBox = $('#phError');
      const okBox  = $('#phOk');

      function openModal(){
        errBox.style.display = 'none';
        okBox.style.display = 'none';
        modal.setAttribute('aria-hidden','false');
        modal.style.display = 'flex';
        if (!inpDate.value) inpDate.valueAsDate = new Date();
        recommendStatus();
      }
      function closeModal(){
        modal.setAttribute('aria-hidden','true');
        modal.style.display = 'none';
      }
      btnClose.addEventListener('click', closeModal);
      modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

      btnReset.addEventListener('click', ()=>{
        inpDate.value = '';
        selStart.selectedIndex = 16; // 8:00 AM
        selEnd.selectedIndex = 20;   // 10:00 AM
        txtTopic.value = '';
        radioSched.checked = false;
        radioComp.checked = false;
        recommendStatus();
        errBox.style.display='none'; okBox.style.display='none';
      });

      function halfHourOptions(){
        const opts = [];
        for (let h=5; h<=22; h++){
          for (let m of [0,30]) {
            const dt = new Date(2000,0,1,h,m);
            opts.push({
              value: dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
              sort: h*60 + m,
              label: dt.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })
            });
          }
        }
        return opts;
      }
      function populateTimeSelects(){
        const opts = halfHourOptions();
        selStart.innerHTML = opts.map(o => `<option value="${o.value}" data-min="${o.sort}">${o.label}</option>`).join('');
        selEnd.innerHTML   = opts.map(o => `<option value="${o.value}" data-min="${o.sort}">${o.label}</option>`).join('');
        selStart.selectedIndex = 16;
        selEnd.selectedIndex   = 20;
      }

      function minutesFromOption(val){
        const el = [...selStart.options, ...selEnd.options].find(o => o.value === val);
        return el ? parseInt(el.getAttribute('data-min')||'0',10) : 0;
      }

      function computeHours(){
        const sMin = minutesFromOption(selStart.value);
        const eMin = minutesFromOption(selEnd.value);
        const diff = Math.max(0, eMin - sMin);
        return diff / 60;
      }

      function recommendStatus(){
        const d = inpDate.value ? new Date(inpDate.value) : null;
        const today = new Date(); today.setHours(0,0,0,0);
        if (d && d >= today) {
          radioSched.checked = true; radioComp.checked = false;
          statusHint.textContent = 'Future dates default to Scheduled.';
        } else {
          radioSched.checked = false; radioComp.checked = true;
          statusHint.textContent = 'Past/today default to Completed.';
        }
      }

      inpDate.addEventListener('change', recommendStatus);

      async function loadSquadsAndMine() {
        try {
          const sqRows = await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.SQUADS);
          const onlyActive = (r) => {
            const raw = r['Active'] ?? r['Is Active'] ?? r['Status'];
            if (raw == null || raw === '') return true;
            const t = String(raw).trim().toLowerCase();
            return (raw === true) || ['true','yes','y','active','1'].includes(t);
          };
          state.squads = sqRows.filter(onlyActive).map(r => ({
            id: String(r['Squad ID'] || r['ID'] || r['Row ID'] || r['Name'] || '').trim() || (r['Name']||'').trim(),
            name: String(r['Name'] || r['Squad Name'] || r['Title'] || '').trim() || '(Untitled)'
          }));

          state.mySquadIds = new Set();
          try {
            const me = PowerUp.session.get() || {};
            const myId = String(me.employeeId||'').trim().toLowerCase();
            const memRows = await PowerUp.api.getRowsByTitle(PowerUp.api.SHEETS.SQUAD_MEMBERS);
            memRows.forEach(r => {
              const eid = String(r['Employee ID'] || r['Position ID'] || '').trim().toLowerCase();
              const sid = String(r['Squad ID'] || r['Squad'] || r['Squad Name'] || '').trim();
              if (eid && sid && eid === myId) state.mySquadIds.add(sid);
            });
          } catch {}

          renderSquadSelect();
        } catch (e) {
          console.error('loadSquads failed', e);
          renderSquadSelect(true);
        }
      }

      function renderSquadSelect(fallbackAll=false) {
        const showAll = document.getElementById('phShowAllSquads').checked || fallbackAll;
        const list = showAll ? state.squads
                             : state.squads.filter(s => state.mySquadIds.has(s.id) || state.mySquadIds.has(s.name));
        const opts = ['<option value="">None</option>']
          .concat(list.sort((a,b)=>a.name.localeCompare(b.name)).map(s => `<option value="${s.name}">${s.name}</option>`));
        document.getElementById('phSquad').innerHTML = opts.join('');
      }
      document.getElementById('phShowAllSquads').addEventListener('change', ()=> renderSquadSelect());

      async function createPHRow(payloadObj){
        const sheetId = PowerUp.api.SHEETS.POWER_HOURS;
        const url = `${PowerUp.api.API_BASE}/sheet/${sheetId}/rows`;
        const body = [ Object.assign({ toTop: true }, payloadObj) ];
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
          credentials: 'omit',
          cache: 'no-store'
        });
        if (!res.ok) {
          let detail = ''; try { detail = await res.text(); } catch {}
          throw new Error(`Save failed (${res.status}) ${detail || ''}`.trim());
        }
        return res.json();
      }

      function showError(msg){ const e=document.getElementById('phError'); e.textContent=msg; e.style.display='block'; document.getElementById('phOk').style.display='none'; }
      function showOk(msg){ const e=document.getElementById('phOk'); e.textContent=msg; e.style.display='block'; document.getElementById('phError').style.display='none'; }

      document.getElementById('phSave').addEventListener('click', async () => {
        try {
          document.getElementById('phError').style.display='none';
          document.getElementById('phOk').style.display='none';

          const me = PowerUp.session.get() || {};
          const date = document.getElementById('phDate').value;
          const start = document.getElementById('phStart').value;
          const end   = document.getElementById('phEnd').value;
          if (!date) throw new Error('Please choose a date.');
          if (!start || !end) throw new Error('Please choose start and end times.');
          const hrs = computeHours();
          if (hrs <= 0) throw new Error('End time must be after start time.');

          const isFuture = (d => { const t=new Date(); t.setHours(0,0,0,0); const dd=new Date(d); dd.setHours(0,0,0,0); return dd >= t; })(date);
          const mark = document.getElementById('phStatusCompleted').checked ? 'completed'
                       : document.getElementById('phStatusScheduled').checked ? 'scheduled'
                       : (isFuture ? 'scheduled':'completed');

          const desc = (document.getElementById('phTopic').value || '').trim();
          const squad = document.getElementById('phSquad').value || '';

          const row = {};
          row['Date'] = date;
          row['Start Time'] = start;
          row['End Time'] = end;
          row['Employee ID'] = String(me.employeeId||'');
          row['Employee Name'] = String(me.displayName||'');
          row['Submitted By'] = String(me.displayName||'');

          if (mark === 'completed') {
            row['Completed'] = true;
            row['Scheduled'] = false;
            row['Completed Hours'] = hrs;
            row['Duration (hrs)'] = hrs;
          } else {
            row['Completed'] = false;
            row['Scheduled'] = true;
            row['Completed Hours'] = 0;
            row['Duration (hrs)'] = hrs;
          }

          if (desc) { row['Activity Description'] = desc; row['Topic'] = desc; row['Description'] = desc; }
          if (squad) row['Squad'] = squad;

          document.getElementById('phSave').disabled = true;
          await createPHRow(row);
          showOk('Saved! Updating table…');

          state.all = await loadRowsSafe();
          applyRange();
          setTimeout(()=>{ closeModal(); }, 500);
        } catch (e) {
          showError(e.message || 'Save failed.');
        } finally {
          document.getElementById('phSave').disabled = false;
        }
      });

      /* ===== Boot ===== */
      async function loadTableAndProgress() {
        const saved = getSavedRange();
        mountControls(saved);        // mount beside Admin filter or header row
        observeForAdminFilter(saved);// if Admin filter appears later, re-mount beside it

        state.target = await resolveTargetEmployee();
        buildHead();
        await loadNames();
        state.all = await loadRowsSafe();
        applyRange();
      }

      document.addEventListener('powerup-admin-filter-change', async () => {
        state.target = await resolveTargetEmployee();
        applyRange();
      });
      document.addEventListener('pu-admin-filter-change', async () => {
        state.target = await resolveTargetEmployee();
        applyRange();
      });

      document.addEventListener('DOMContentLoaded', async () => {
        PowerUp.session.requireLogin();
        PowerUp.layout.injectLayout();
        PowerUp.layout.setPageTitle('Power Hours');

        await PowerUp.session.initHeader();
        await loadTableAndProgress();

        populateTimeSelects();
        await loadSquadsAndMine();
      });
    })();
  </script>
</body>
</html>
