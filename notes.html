<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- EARLY AUTH GUARD â€” must be first in <head> -->
  <script>
  !function () {
    try {
      const s = JSON.parse(sessionStorage.getItem('pu.session') || 'null')
             || JSON.parse(localStorage.getItem('powerup_session') || 'null');
      if (!s || !s.employeeId) {
        document.documentElement.style.visibility = 'hidden';
        location.replace('login.html');
      }
    } catch {
      document.documentElement.style.visibility = 'hidden';
      location.replace('login.html');
    }
  }();
  </script>

  <title>PowerUp â€” Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
</head>

<body class="notes">
  <!-- Only page-specific content goes here; layout.js injects the shared shell -->
  <div class="content-inner notes-layout">
    <!-- Left: list -->
    <aside class="notes-sidebar">
      <div class="note-sidebar-header">
        <h2>My Notes</h2>
        <button class="add-btn" onclick="createNote()">âž• Add</button>
      </div>
      <ul id="notesList"></ul>
    </aside>

    <!-- Right: editor -->
    <main class="notes-editor">
      <header class="notes-toolbar">
        <div class="toolbar">
          <button onclick="format('bold')"><i class="fas fa-bold"></i></button>
          <button onclick="format('underline')"><i class="fas fa-underline"></i></button>
          <button onclick="format('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
          <button onclick="format('insertOrderedList')"><i class="fas fa-list-ol"></i></button>
          <button onclick="format('undo')"><i class="fas fa-undo"></i></button>
          <button onclick="format('redo')"><i class="fas fa-redo"></i></button>
          <button onclick="format('removeFormat')"><i class="fas fa-eraser"></i></button>
        </div>

        <div class="controls">
          <button class="save-btn" onclick="saveCurrentNote()">ðŸ’¾ Save</button>
          <button class="delete-btn" onclick="deleteCurrentNote()">ðŸ—‘ Delete</button>
        </div>
      </header>

      <div id="editor" class="note-editor" contenteditable="true" data-placeholder="Start writing your note..."></div>
    </main>
  </div>

  <!-- PowerUp core (must load before we call PowerUp.*) -->
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/roles.js"></script>
  <script src="scripts/layout.js"></script>

  <!-- Page boot: inject shell + title, then init header -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      PowerUp.session.requireLogin();
      if (!document.getElementById('pu-header')) {
        PowerUp.layout.injectLayout();
      }
      PowerUp.layout.setPageTitle('Notes');
      await PowerUp.session.initHeader();
    });
  </script>

  <!-- Notes logic (unchanged) -->
  <script>
    let notes = JSON.parse(localStorage.getItem("notes") || "[]");
    let currentNoteId = null;

    function renderNotes() {
      const list = document.getElementById('notesList');
      list.innerHTML = '';
      notes.forEach(note => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="note-card">
            <div class="note-info">
              <strong>${note.title || 'Untitled'}</strong>
              <div class="note-meta">${new Date(note.updated).toLocaleString()}</div>
            </div>
            <button class="delete-icon" onclick="deleteNoteById(${note.id}, event)">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        `;
        li.classList.toggle('active', note.id === currentNoteId);
        li.onclick = () => loadNote(note.id);
        list.appendChild(li);
      });
    }

    function createNote() {
      const newNote = {
        id: Date.now(),
        title: 'Untitled Note',
        content: '',
        updated: new Date().toISOString()
      };
      notes.unshift(newNote);
      currentNoteId = newNote.id;
      renderNotes();
      loadNote(currentNoteId);
      saveNotes();
    }

    function loadNote(id) {
      const note = notes.find(n => n.id === id);
      if (note) {
        currentNoteId = id;
        document.getElementById('editor').innerHTML = note.content;
        renderNotes();
      }
    }

    function saveCurrentNote() {
      const index = notes.findIndex(n => n.id === currentNoteId);
      if (index !== -1) {
        notes[index].content = document.getElementById('editor').innerHTML;
        notes[index].title = document.getElementById('editor').innerText.split('\n')[0].slice(0, 30) || 'Untitled';
        notes[index].updated = new Date().toISOString();
        saveNotes();
        renderNotes();
      }
    }

    function deleteCurrentNote() {
      if (!confirm("Delete this note?")) return;
      notes = notes.filter(n => n.id !== currentNoteId);
      currentNoteId = notes.length ? notes[0].id : null;
      if (currentNoteId) loadNote(currentNoteId);
      else document.getElementById('editor').innerHTML = '';
      saveNotes();
      renderNotes();
    }

    function deleteNoteById(id, e) {
      e.stopPropagation();
      if (!confirm("Delete this note?")) return;
      notes = notes.filter(n => n.id !== id);
      currentNoteId = notes.length ? notes[0].id : null;
      if (currentNoteId) loadNote(currentNoteId);
      else document.getElementById('editor').innerHTML = '';
      saveNotes();
      renderNotes();
    }

    function saveNotes() {
      localStorage.setItem("notes", JSON.stringify(notes));
    }

    function format(command) {
      document.execCommand(command, false, null);
    }

    // Init local data
    renderNotes();
    if (notes.length) loadNote(notes[0].id);
  </script>
</body>
</html>
