<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PowerUp ‚Äî Sign In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="style.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    /* ---- Card + form ---- */
    .auth-wrap { min-height: 100vh; display: grid; place-items: center; background: linear-gradient(180deg,#0f172a,#111827);}
    .auth-card { width: 100%; max-width: 460px; background:#0b1020; border:1px solid #00ffc6; border-radius:16px; padding:28px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .brand { display:flex; align-items:center; gap:10px; margin-bottom:18px;}
    .brand .dot { width:12px; height:12px; border-radius:50%; background:#00ffc6; box-shadow:0 0 16px #00ffc6;}
    .brand h1 { font-size:20px; font-weight:700; letter-spacing:.2px;color:#00ffc6;}
    .muted { color:#94a3b8; font-size:13px; margin-top:2px;}
    .field { margin-top:16px;}
    .field label { display:block; font-size:13px; color:#cbd5e1; margin-bottom:6px;}
    .field input, .modal select, .modal input[type="date"] { width:100%; padding:12px 14px; border-radius:10px; background:#0b1328; border:1px solid #293449; color:#e5e7eb; outline:none;}
    .field input:focus { border-color:#00ffc6; box-shadow:0 0 0 3px rgba(0,255,198,.15);}
    .actions { margin-top:18px; display:flex; gap:10px; align-items:center;}
    .btn { padding:12px 14px; border-radius:10px; border:1px solid #2a354b; background:#111a2f; color:#e5e7eb; cursor:pointer;}
    .btn.primary { background:#FF6600; border-color:#FF6600; color:#111827; font-weight:700;}
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .error { margin-top:14px; color:#fecaca; background:#450a0a; border:1px solid #7f1d1d; padding:10px 12px; border-radius:10px; display:none;}
    .hint { margin-top:10px; font-size:12px; color:#9ca3af;}

    /* ---- Busy overlay (restored ‚Äúsmart narration‚Äù) ---- */
    .busy-overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(7,10,20,.6);z-index:9999;}
    .busy-card{background:#0b1020;border:1px solid rgba(0,255,198,.4);border-radius:14px;padding:18px 20px;min-width:280px;max-width:420px;box-shadow: 0 10px 30px rgba(0,0,0,.35);text-align:center}
    .spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:#00ffc6;border-radius:50%;margin:0 auto 10px;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .busy-title{color:#e5e7eb;font-weight:700;margin-bottom:4px}
    .busy-sub{color:#9ca3af;font-size:12px;min-height:32px;display:flex;align-items:center;justify-content:center;text-align:center;padding:0 6px}

    /* ---- ID Lookup modal ---- */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9998}
    .modal[aria-hidden="false"]{display:flex}
    .modal-card{background:#0b1020;border:1px solid #294957;border-radius:14px;padding:18px;min-width:320px;max-width:560px;width:92%}
    .modal-card h3{margin:0 0 10px;color:#00ffc6;font-size:18px}
    .modal-row{display:flex;gap:10px;flex-wrap:wrap}
    .modal-row .field{flex:1;margin-top:10px}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:14px}
    .small{font-size:12px;color:#9ca3af}
    .result{margin-top:10px;padding:10px;border-radius:10px;background:#0b1328;border:1px dashed #2a354b;color:#e5e7eb;display:none}
    .result.ok{border-color:#10b981}
    .result.err{border-color:#b91c1c}

  </style>

<link rel="stylesheet" href="splash.css">
  
</head>
<body>

    <!-- ‚úÖ Integrated Splash Sequence for Dashboard (Option B) -->
<div id="splash" class="splash" aria-hidden="true">
  <div class="montage" id="montage"></div>
  <div class="lens" aria-hidden="true"></div>
  <div class="cardwash" aria-hidden="true"></div>
  <div class="vignette" aria-hidden="true"></div>

  <div class="lockup" aria-hidden="true">
    <div class="wordmark-wrap">
      <div class="wordmark" aria-label="PLAYWORLD">
        <span class="wordmark-fill">PLAYWORLD</span>
        <span class="wordmark-stroke" aria-hidden="true">PLAYWORLD</span>
        <div class="sweep" aria-hidden="true"></div>
        <div class="sparks" aria-hidden="true">
          <span class="spark s1"></span>
          <span class="spark s2"></span>
          <span class="spark s3"></span>
          <span class="spark s4"></span>
        </div>
      </div>
      <div class="divider" aria-hidden="true"></div>
      <div class="subbar">PowerUp</div>
    </div>
  </div>

  <div id="finalCard" class="final" aria-hidden="true"></div>

  <button id="skipBtn" class="skip" type="button" aria-label="Skip Intro">Skip Intro</button>
  <div id="splash-loading" class="splash-loading">Loading your dashboard‚Ä¶</div>

</div>

  <div class="auth-wrap">
    <div class="auth-card" role="form" aria-labelledby="loginTitle">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <h1 id="loginTitle">PowerUp</h1>
      </div>
      <div class="muted">Sign in with your <strong>Employee ID</strong></div>

      <div class="field">
        <label for="empId">Employee ID</label>
        <input id="empId" type="text" placeholder="e.g., IX12345" autocomplete="off" />
      </div>

      <div class="actions">
        <button class="btn primary" id="signin">Sign In</button>
        <button class="btn" id="help">Retrieve my Employee ID</button>
      </div>

      <div id="error" class="error" role="alert" aria-live="polite"></div>
      <div class="hint">We‚Äôll match your ID in Employee Master and personalize your dashboard.</div>
    </div>
  </div>

  <!-- Busy overlay (restored) -->
  <div id="busy" class="busy-overlay" aria-hidden="true" aria-live="polite">
    <div class="busy-card">
      <div class="spinner" aria-hidden="true"></div>
      <div class="busy-title">Signing you in‚Ä¶</div>
      <div class="busy-sub" id="busySub">Authorizing and loading your data.</div>
    </div>
  </div>

  <!-- ID Lookup modal -->
  <div id="idLookupModal" class="modal" aria-hidden="true" aria-labelledby="idLookupTitle" role="dialog">
    <div class="modal-card">
      <h3 id="idLookupTitle">Find your Employee ID</h3>

      <div id="lookupLoading" class="small" style="display:none;align-items:center;gap:8px">
        <div class="spinner" style="width:18px;height:18px;border-width:2px"></div>
        <span>Loading employees‚Ä¶</span>
      </div>

      <p class="small">Choose your name, then confirm your hire date. If it matches our records, we‚Äôll reveal your Employee ID.</p>
      <div class="modal-row">
        <div class="field" style="flex:1.6">
          <label for="lookupName">Name</label>
          <select id="lookupName">
            <option value="">Loading‚Ä¶</option>
          </select>
        </div>
        <div class="field" style="flex:1">
          <label for="lookupHire">Hire Date</label>
          <input id="lookupHire" type="date" />
        </div>
      </div>
      <div id="lookupResult" class="result"></div>
      <div class="modal-actions">
        <button class="btn" id="lookupCancel">Close</button>
        <button class="btn primary" id="lookupCheck">Reveal ID</button>
      </div>
    </div>
  </div>


  <!-- Core libs -->
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/splash.bundle.js"></script>

  <script>
  (function () {
    const $ = (s) => document.querySelector(s);

    /* ---- Clean state on login page ---- */
    try { window.P && P.api && P.api.clearCache && P.api.clearCache(); } catch {}
    try { sessionStorage.removeItem('pu.sheetCache.v1'); } catch {}
    try { localStorage.removeItem('powerup_session'); } catch {}

    /* ---- Warm-up + prefetch employee cache (non-blocking) ---- */
    (async function warmup() {
      try { await PowerUp.api.warmProxy(); } catch {}
      try {
        const rows = await PowerUp.api.getRowsByTitle('EMPLOYEE_MASTER');
        try { sessionStorage.setItem('pu.cache.EMPLOYEE_MASTER.rows', JSON.stringify(rows)); } catch {}
      } catch {}
    })();

    const empInput      = $('#empId');
    const btnSignIn     = $('#signin');
    const btnHelp       = $('#help');
    const errBox        = $('#error');

    /* Force uppercase in Employee ID field */
empInput.addEventListener('input', (e) => {
  e.target.value = e.target.value.toUpperCase();
});


    const busy          = $('#busy');
    const busySub       = $('#busySub');

    const modal         = $('#idLookupModal');
    const selName       = $('#lookupName');
    const inpHire       = $('#lookupHire');
    const resBox        = $('#lookupResult');
    const btnCheck      = $('#lookupCheck');
    const btnClose      = $('#lookupCancel');
    const lookupLoading = document.getElementById('lookupLoading');

    let EMP_ROWS = [];

    /* ---------- Busy overlay helpers + narration ---------- */
    let narratorTimer = null;
    let narratorStart = 0;
    let narratorDots  = 0;
    let narratorData  = { attempt: 1 };

    function setBusy(on) {
      if (on) {
        busy.style.display = 'grid';
        busy.setAttribute('aria-hidden', 'false');
        btnSignIn.disabled = true;
        empInput.disabled  = true;
        errBox.style.display = 'none';
      } else {
        busy.style.display = 'none';
        busy.setAttribute('aria-hidden', 'true');
        btnSignIn.disabled = false;
        empInput.disabled  = false;
      }
    }
    function formatElapsed(ms) {
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const r = s % 60;
      return (m ? (m + 'm ') : '') + r + 's';
    }
    function narratorLine() {
      const now = Date.now();
      const elapsed = now - narratorStart;
      const dots = '.'.repeat((narratorDots % 3) + 1);
      narratorDots++;
      let hint = 'Contacting server';
      if (elapsed > 10_000)  hint = 'Warming the proxy';
      if (elapsed > 30_000)  hint = 'Priming data sources';
      if (elapsed > 60_000)  hint = 'Smartsheet may still be waking';
      if (elapsed > 90_000)  hint = 'Almost there‚Äîstill negotiating';
      busySub.textContent =
        `${hint}${dots} ‚Ä¢ Attempt ${narratorData.attempt} ‚Ä¢ ${formatElapsed(elapsed)} elapsed`;
    }
    function startNarrator(attempt) {
      narratorData.attempt = attempt || 1;
      narratorStart = Date.now();
      narratorDots  = 0;
      if (narratorTimer) clearInterval(narratorTimer);
      narratorTimer = setInterval(narratorLine, 420);
      narratorLine();
    }
    function bumpNarratorAttempt(a){ narratorData.attempt = a; narratorLine(); }
    function stopNarrator(){ if (narratorTimer) { clearInterval(narratorTimer); narratorTimer = null; } }

    /* ---------- ID Lookup helpers ---------- */
    function showError(msg) { errBox.textContent = msg; errBox.style.display = 'block'; }
    function showLookupLoading(on) {
      if (lookupLoading) lookupLoading.style.display = on ? 'flex' : 'none';
      selName.disabled = !!on;
    }
    const EMP_CACHE_KEY = 'pu.cache.EMPLOYEE_MASTER.rows';
    function getCachedEmployeeRows() {
      const raw = sessionStorage.getItem(EMP_CACHE_KEY);
      if (!raw) return null;
      try { const parsed = JSON.parse(raw); return Array.isArray(parsed) ? parsed : null; }
      catch { try { sessionStorage.removeItem(EMP_CACHE_KEY); } catch {} return null; }
    }
    async function fetchEmployeeRowsFresh() {
      try { return await PowerUp.api.getRowsByTitle('EMPLOYEE_MASTER'); }
      catch { try { await PowerUp.api.warmProxy(); } catch {} return await PowerUp.api.getRowsByTitle('EMPLOYEE_MASTER'); }
    }
    async function ensureEmployeeRows() {
      if (EMP_ROWS.length) return;
      showLookupLoading(true);
      try {
        let rows = getCachedEmployeeRows();
        if (!rows) {
          rows = await fetchEmployeeRowsFresh();
          try { sessionStorage.setItem(EMP_CACHE_KEY, JSON.stringify(rows)); } catch {}
        }
        EMP_ROWS = rows.filter(r =>
          (r['Display Name'] || r['Employee Name'] || r['Name']) &&
          (r['Position ID'] || r['Employee ID'])
        );
        const opts = ['<option value="">Select your name‚Ä¶</option>'].concat(
          EMP_ROWS
            .map(r => ({
              id: (r['Position ID'] || r['Employee ID']).toString().trim(),
              name: (r['Display Name'] || r['Employee Name'] || r['Name']).toString().trim(),
            }))
            .sort((a,b) => a.name.localeCompare(b.name))
            .map(o => `<option value="${o.id}">${o.name}</option>`)
        );
        selName.innerHTML = opts.join('');
      } finally { showLookupLoading(false); }
    }
    function toISODateOnly(v) {
      if (!v) return '';
      const d = new Date(v);
      return isNaN(d) ? '' : d.toISOString().slice(0,10);
    }
    function openLookup({ loading = false } = {}) {
      resBox.style.display = 'none';
      resBox.className = 'result';
      inpHire.value = '';
      modal.setAttribute('aria-hidden','false');
      modal.style.display = 'flex';
      showLookupLoading(loading);
    }
    function closeLookup() {
      modal.setAttribute('aria-hidden','true');
      modal.style.display = 'none';
    }
    function showLookupResult(ok, html) {
      resBox.className = 'result ' + (ok ? 'ok' : 'err');
      resBox.innerHTML = html;
      resBox.style.display = 'block';
    }
    function findRowById(id) {
      const idLC = String(id || '').trim().toLowerCase();
      return EMP_ROWS.find(r => String(r['Position ID'] || r['Employee ID']).trim().toLowerCase() === idLC);
    }


    /* ---------- Lookup wiring ---------- */
    btnHelp.addEventListener('click', async () => {
      openLookup({ loading: true });
      btnHelp.disabled = true;
      try {
        await ensureEmployeeRows();
        if (!EMP_ROWS.length) {
          showLookupResult(false, 'We couldn‚Äôt load the employee list. Please try again in a moment.');
        }
      } catch {
        showLookupResult(false, 'We couldn‚Äôt load the employee list. Please try again in a moment.');
      } finally {
        btnHelp.disabled = false;
        showLookupLoading(false);
      }
    });

    btnCheck.addEventListener('click', () => {
      const id = selName.value;
      const row = findRowById(id);
      const picked = inpHire.value;
      if (!row || !picked) {
        showLookupResult(false, 'Please choose your name and enter your hire date.');
        return;
      }
      const hireRaw = row['Hire Date'] || row['HireDate'] || row['Start Date'];
      const hireISO = toISODateOnly(hireRaw);
      if (hireISO && hireISO === picked) {
        const safeName = (row['Display Name'] || row['Employee Name'] || row['Name'] || '').toString();
        const empId = (row['Position ID'] || row['Employee ID']).toString();
        showLookupResult(true, `
          <div><b>${safeName}</b></div>
          <div class="small" style="margin-top:4px">Your Employee ID is:</div>
          <div style="font-size:18px;margin-top:4px"><code>${empId}</code></div>
          <div style="margin-top:10px">
            <button class="btn primary" id="useFoundId">Use this ID</button>
          </div>
        `);
        setTimeout(() => {
          const useBtn = document.getElementById('useFoundId');
          if (useBtn) useBtn.onclick = () => {
            document.getElementById('empId').value = empId;
            closeLookup();
            document.getElementById('empId').focus();
          };
        }, 0);
      } else {
        showLookupResult(false, 'That hire date doesn‚Äôt match our records for the selected name.');
      }
    });

    btnClose.addEventListener('click', (e) => { e.preventDefault(); closeLookup(); });
    modal.addEventListener('click', (e) => { if (e.target === modal) closeLookup(); });

    })();
  </script>




  
  
  
<script>
/* === Curated Playworld set === */
const IMAGE_SETS = [
  { name:'playworld', base:'', files: [
    "https://playworld.com/wp-content/uploads/2024/07/ClarkV_240612__U7A0416-scaled.jpg",
    "https://playworld.com/wp-content/uploads/2024/07/ClarkV_240612__U7A9136-scaled.jpg",
    "https://playworld.com/wp-content/uploads/2023/09/tz-2325-web-image-2.png",
    "https://playworld.com/wp-content/uploads/2025/01/rs-2370-web-image-1.png",
    "https://playworld.com/wp-content/uploads/2023/09/rs-2315-web-image-1.png",
    "https://playworld.com/wp-content/uploads/2023/09/zzxx1123-web-image-1-scaled.jpg",
    "https://playworld.com/wp-content/uploads/2023/09/zzun8771-web-image-2.jpg",
    "https://playworld.com/wp-content/uploads/2023/09/500-2039-web-image-1.png",
    "https://secure.viewer.zmags.com/services/resource/pub/4aa2a8e9/pg683x856/5/6?viewerID=cdc7b5af",
    "https://secure.viewer.zmags.com/services/resource/pub/4aa2a8e9/pg683x856/5/26?viewerID=cdc7b5af",
    "https://playworld.com/wp-content/uploads/2023/10/LOC-Pirate-Ship-NJ-020_QCC-BackgroundEditforText.jpg",
    "https://playworld.com/wp-content/uploads/2025/02/PW_2025_Smith-Ranch-Eagle-Mountain-UT_241023__0011741_Edit_SM.jpg",
    "https://playworld.com/wp-content/uploads/2024/01/PW_2024_Piney-Orchard_Edit_10-940x627.jpeg",
    "https://playworld.com/wp-content/uploads/2024/07/ClarkV_240612__U7A9125-2048x1366.jpg",
    "https://playworld.com/wp-content/uploads/2023/10/PW_Rope-Web-Images_09-min-2048x1365.jpg",
    "https://playworld.com/wp-content/uploads/2024/01/PW_2024_RopeScapes_Lewisburg-PA_42-copy.jpg",
    "https://playworld.com/wp-content/uploads/2023/10/Cleveland_Elementary_Washington_D.C_201002__96A9723-min-2048x1365.jpg",
    "https://playworld.com/wp-content/uploads/2025/09/PW_2026_Cook-Family-Park_Pleasant-Grove-UT_250811__0013651.jpg",
    "https://playworld.com/wp-content/uploads/2023/10/PlayTown_Playhouse_02-2048x1152.jpg"
  ]}
];

const SHOTS_PER_RUN = 22;
const SHUFFLE_WITHIN_SET = true;
const STORAGE_KEY = 'pw_splash_set_index';

const elSplash  = document.getElementById('splash');
const elMontage = document.getElementById('montage');
const elFinal   = document.getElementById('finalCard');
const elLens    = document.querySelector('.lens');
const elCard    = document.querySelector('.cardwash');
const elDivider = document.querySelector('.divider');
const elSubbar  = document.querySelector('.subbar');
const btnSkip   = document.getElementById('skipBtn');
const elText    = document.getElementById('splash-loading');

// Match original cinematic pacing
const shotHold  = cssMs('--shot-hold', 140);
const xfade     = cssMs('--shot-xfade', 100);
const step      = shotHold + xfade;

// Restore slower, smoother motion
document.documentElement.style.setProperty('--kenburns-scale', '1.06');
document.documentElement.style.setProperty('--kenburns-pan-x', '10px');
document.documentElement.style.setProperty('--kenburns-pan-y', '8px');
document.documentElement.style.setProperty('--tilt-deg', '4deg');

// Timing constants
document.documentElement.style.setProperty('--sweep-duration', '2600ms');
document.documentElement.style.setProperty('--sweep-delay', '2400ms');
document.documentElement.style.setProperty('--stroke-offset', '140ms');
document.documentElement.style.setProperty('--final-hold', '1400ms');
document.documentElement.style.setProperty('--brand-hold', '1200ms');

const kenScale  = getCss('--kenburns-scale', 1.06);
const panX      = getCss('--kenburns-pan-x', '10px');
const panY      = getCss('--kenburns-pan-y', '8px');

const finalHold = cssMs('--final-hold', 1400);
const brandHold = cssMs('--brand-hold', 1200);

let timers = [];
let currentSplashRunId = 0; // üîπ Tracks active splash instance

function clearTimers(){ timers.forEach(t=>clearTimeout(t)); timers=[]; }

if (btnSkip) btnSkip.addEventListener('click', skipAll, { passive:true });

window.Splash = { play: startSequence, skip: skipAll, end: endSequence };

document.addEventListener('DOMContentLoaded', () => {
  const alreadyPlayed = sessionStorage.getItem('splashPlayed');
  if (alreadyPlayed) return;
  sessionStorage.setItem('splashPlayed', 'true');
  startSequence();
});

document.addEventListener('data-hydrated', () => endSequence());

function resetSplashState() {
  clearTimers();
  elSplash.classList.remove('fade-out');
  elFinal.classList.remove('show');
  elCard.classList.remove('parallax');
  elDivider.classList.remove('show');

  const elStroke = document.querySelector('.wordmark-stroke');
  const elWordmark = document.querySelector('.wordmark');
  if (elStroke) elStroke.classList.remove('full', 'glow');
  if (elWordmark) elWordmark.classList.remove('show');

  elMontage.innerHTML = '';
  document.documentElement.style.overflow = '';

  elSplash.style.display = 'none';
  if (elText) {
    elText.style.opacity = '0';
    elText.textContent = 'Loading your dashboard‚Ä¶';
  }
}
  
async function startSequence(){
  resetSplashState();
  if(!IMAGE_SETS.length) return;

  const runId = ++currentSplashRunId; // üîπ New splash instance ID

    // üî∏ Fire an event whenever a new splash cycle starts
  document.dispatchEvent(new CustomEvent('splash:cycleStart', { detail: { runId } }));


  // Show splash
  elSplash.style.display = 'block';
  document.documentElement.style.overflow = 'hidden';
  if (elText) {
    elText.style.transition = 'opacity 0.8s ease';
    elText.style.opacity = '0.8';
  }

  // Delay skip visibility
  if (btnSkip) {
    btnSkip.style.opacity = '0';
    setTimeout(()=> {
      if (elSplash.style.display === 'block') btnSkip.style.opacity = '1';
    }, 3000);
  }

  const idx = getNextSetIndex();
  const set = IMAGE_SETS[idx];
  let urls = set.files.map(f => set.base + f);

  if(SHUFFLE_WITHIN_SET) urls = shuffle(urls);
  if(urls.length > SHOTS_PER_RUN) urls = urls.slice(0, SHOTS_PER_RUN);

  await preloadBounded(urls.slice(0,2), 2);
  buildShots(urls);
  preloadBounded(urls.slice(2), 6);

  const montageDuration = urls.length * step;
  document.documentElement.style.setProperty('--montage-duration', montageDuration + 'ms');

  elMontage.style.animation = `montageFadeOut ${montageDuration}ms linear forwards`;
  elLens.style.animation    = `montageFadeOut ${montageDuration}ms linear forwards`;
  elCard.style.animation    = `cardwashFadeIn ${montageDuration}ms linear forwards`;

  const sweepDelay = Math.max(0, Math.round(montageDuration - 350));
  document.documentElement.style.setProperty('--sweep-delay', sweepDelay + 'ms');

  const SUBBAR_DELAY_OFFSET = 180;
  elSubbar.style.animationDelay = (sweepDelay + SUBBAR_DELAY_OFFSET) + 'ms';

  const showDividerAt = sweepDelay + SUBBAR_DELAY_OFFSET + 90;
  timers.push(setTimeout(() => {
    if (runId !== currentSplashRunId) return; // üîπ ignore stale timers
    syncDividerWidth();
    elDivider.classList.add('show');
    observeSubbar();
  }, showDividerAt));

  const elStroke = document.querySelector('.wordmark-stroke');
  const sweepDur = cssMs('--sweep-duration', 2600);
  const strokeOffset = cssMs('--stroke-offset', 140);
  timers.push(setTimeout(() => {
    if (runId !== currentSplashRunId) return; // üîπ ignore stale timers
    if (!elStroke) return;
    elStroke.classList.add('full');
    elStroke.classList.add('glow');
    setTimeout(()=> elStroke.classList.remove('glow'), 900);
  }, sweepDelay + strokeOffset + sweepDur + 20));

  const showFinalAt = Math.max(0, montageDuration - 120);
  const endAt       = montageDuration + finalHold + brandHold;

  timers.push(setTimeout(()=> {
    if (runId !== currentSplashRunId) return; // üîπ ignore stale timers
    elFinal.classList.add('show');
    elCard.classList.add('parallax');
  }, showFinalAt));

  // üî∏ Fire an event when one full visible cycle finishes (just before fade-out)
  timers.push(setTimeout(() => {
    if (runId === currentSplashRunId) {
      document.dispatchEvent(new CustomEvent('splash:cycleComplete', { detail: { runId } }));
    }
  }, endAt - 100));
}


function endSequence(){
  elSplash.classList.add('fade-out');
  if (elText) elText.style.opacity = '0';
  setTimeout(()=>{
    elSplash.style.display = 'none';
    elSplash.classList.remove('fade-out');
    elFinal.classList.remove('show');
    elCard.classList.remove('parallax');
    document.documentElement.style.overflow = '';
    clearTimers();
    if (ro) { ro.disconnect(); ro = null; }
  }, 540);
}

function skipAll(){
  clearTimers();
  elFinal.classList.add('show');
  elCard.classList.add('parallax');
  endSequence();
}

function buildShots(images){
  elMontage.innerHTML = '';
  images.forEach((src, i)=>{
    const d = document.createElement('div');
    d.className = 'shot';
    d.style.backgroundImage = `url("${src}")`;
    d.style.setProperty('--kenburns-scale', kenScale);
    d.style.setProperty('--kenburns-pan-x', panX);
    d.style.setProperty('--kenburns-pan-y', panY);
    d.style.setProperty('--tilt-deg', '4deg');
    const animLen = step + 200;
    const delay   = i * step;
    d.style.animation = `shotLife ${animLen}ms ${delay}ms both ease-in-out`;
    elMontage.appendChild(d);
  });
}

function syncDividerWidth(){
  const w = elSubbar.getBoundingClientRect().width;
  elDivider.style.width = Math.max(0, Math.round(w)) + 'px';
}
let ro = null;
function observeSubbar(){
  if (ro) return;
  ro = new ResizeObserver(() => syncDividerWidth());
  ro.observe(elSubbar);
}

function cssMs(varName, fallback){
  const v = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  if(!v) return fallback;
  if(v.endsWith('ms')) return parseFloat(v);
  if(v.endsWith('s'))  return parseFloat(v)*1000;
  const n = parseFloat(v); return Number.isFinite(n) ? n : fallback;
}
function getCss(varName, fallback){
  const v = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  return v || fallback;
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = (Math.random()*(i+1))|0;
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function preloadBounded(urls, concurrency=6){
  if(!urls || !urls.length) return Promise.resolve();
  let i=0, inflight=0;
  return new Promise(resolve=>{
    const pump=()=>{
      if(i>=urls.length && inflight===0) return resolve();
      while(inflight<concurrency && i<urls.length){
        const img=new Image();
        img.decoding='async'; img.loading='eager';
        img.src=urls[i++]; inflight++;
        img.onload=img.onerror=()=>{ inflight--; pump(); };
      }
    };
    pump();
  });
}
function getNextSetIndex(){
  const max = IMAGE_SETS.length;
  const raw = localStorage.getItem(STORAGE_KEY);
  let idx = parseInt(raw,10); if(!Number.isFinite(idx)) idx = -1;
  idx = (idx + 1) % max;
  localStorage.setItem(STORAGE_KEY, String(idx));
  return idx;
}
</script>


<script>
/**
 * PowerUp Login + Splash Controller (Event-driven edition)
 * Works with session.js (loginWithRetry)
 */
(function () {
  const empInput  = document.getElementById('empId');
  const loginBtn  = document.getElementById('signin');
  const errBox    = document.getElementById('error');
  const elSplash  = document.getElementById('splash');
  const elText    = document.getElementById('splash-loading');
  const btnSkip   = document.getElementById('skipBtn');

  let loginReady = false;
  let splashCycleDone = false;

  /* ---- Splash control ---- */
  function showSplash() {
    elSplash.style.display = 'block';
    document.documentElement.style.overflow = 'hidden';
    if (window.Splash && Splash.play) Splash.play();
    if (elText) elText.style.opacity = '1';
  }

  function hideSplashAndRedirect() {
    elSplash.classList.add('fade-out');
    setTimeout(() => {
      elSplash.style.display = 'none';
      elSplash.classList.remove('fade-out');
      document.documentElement.style.overflow = '';
      window.location.href = 'Dashboard-Refresh.html';
    }, 800);
  }

  function hideSplashAndReturn(msg) {
    elSplash.classList.add('fade-out');
    setTimeout(() => {
      elSplash.style.display = 'none';
      elSplash.classList.remove('fade-out');
      document.documentElement.style.overflow = '';
      errBox.textContent = msg;
      errBox.style.display = 'block';
      loginBtn.disabled = false;
      empInput.disabled = false;
    }, 800);
  }

  /* ---- Splash event hooks ---- */
  window.addEventListener('splash:cycleStart', () => {
    splashCycleDone = false;
  });

window.addEventListener('splash:cycleComplete', () => {
  splashCycleDone = true;

  if (loginReady) {
    console.log('‚úÖ Splash finished and login ready ‚Äî redirecting to dashboard');
    hideSplashAndRedirect();
  } else {
    console.log('‚è≥ Splash finished but login still in progress ‚Äî starting another cycle');
    splashCycleDone = false; // reset flag for next cycle
if (window.Splash && typeof Splash.play === 'function') {
  console.log('üîÅ Restarting splash sequence for another cycle');
  if (typeof resetSplashState === 'function') resetSplashState();
  Splash.play(); // restart the animation loop
}
  }
});


  /* ---- Login flow events ---- */
  document.addEventListener('login:start', () => {
    errBox.style.display = 'none';
    loginBtn.disabled = true;
    empInput.disabled = true;
    showSplash();
    if (elText) elText.textContent = 'Contacting server‚Ä¶';
  });

  document.addEventListener('login:progress', (e) => {
    const { attempt, elapsed, note } = e.detail;
    if (!elText) return;
    const seconds = Math.floor(elapsed / 1000);
    let msg = 'Connecting';
    if (note === 'offline') msg = 'You appear offline';
    else if (note === 'retrying') msg = 'Server waking up';
    else if (seconds > 60) msg = 'Almost there';
    elText.textContent = `${msg} ‚Ä¢ Attempt ${attempt} ‚Ä¢ ${seconds}s`;
  });

  document.addEventListener('login:success', (e) => {
    const { displayName } = e.detail;
    if (elText) elText.textContent = `Welcome back, ${displayName}! Loading dashboard‚Ä¶`;
    loginReady = true;
    setTimeout(() => { btnSkip.style.display = 'block'; }, 800);
    if (splashCycleDone) hideSplashAndRedirect();
  });

  document.addEventListener('login:error', (e) => {
    const { message, fatal } = e.detail;
    if (fatal) {
      hideSplashAndReturn(message || 'Login failed. Please try again.');
    } else if (elText) {
      elText.textContent = message || 'Retrying login‚Ä¶';
    }
  });

  /* ---- Skip button ---- */
  btnSkip.style.display = 'none';
  btnSkip.addEventListener('click', () => {
    if (loginReady) hideSplashAndRedirect();
  });

  /* ---- Form handlers ---- */
  function handleLogin() {
    const id = (empInput.value || '').trim();
    if (!id) {
      errBox.textContent = 'Please enter your Employee ID.';
      errBox.style.display = 'block';
      return;
    }
    PowerUp.session.loginWithRetry(id);
  }

  loginBtn.addEventListener('click', handleLogin);
  empInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handleLogin();
  });
})();
</script>


</body>
</html>
