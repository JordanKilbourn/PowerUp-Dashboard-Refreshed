<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PowerUp — Sign In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="style.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    .auth-wrap { min-height: 100vh; display: grid; place-items: center; background: linear-gradient(180deg,#0f172a,#111827);}
    .auth-card { width: 100%; max-width: 460px; background:#0b1020; border:1px solid #00ffc6; border-radius:16px; padding:28px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .brand { display:flex; align-items:center; gap:10px; margin-bottom:18px;}
    .brand .dot { width:12px; height:12px; border-radius:50%; background:#00ffc6; box-shadow:0 0 16px #00ffc6;}
    .brand h1 { font-size:20px; font-weight:700; letter-spacing:.2px;color:#00ffc6;}
    .muted { color:#94a3b8; font-size:13px; margin-top:2px;}
    .field { margin-top:16px;}
    .field label { display:block; font-size:13px; color:#cbd5e1; margin-bottom:6px;}
    .field input { width:100%; padding:12px 14px; border-radius:10px; background:#0b1328; border:1px solid #293449; color:#e5e7eb; outline:none;}
    .field input:focus { border-color:#00ffc6; box-shadow:0 0 0 3px rgba(0,255,198,.15);}
    .actions { margin-top:18px; display:flex; gap:10px; align-items:center;}
    .btn { padding:12px 14px; border-radius:10px; border:1px solid #2a354b; background:#111a2f; color:#e5e7eb; cursor:pointer;}
    .btn.primary { background:#FF6600; border-color:#FF6600; color:#111827; font-weight:700;}
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .error { margin-top:14px; color:#fecaca; background:#450a0a; border:1px solid #7f1d1d; padding:10px 12px; border-radius:10px; display:none;}

    /* Busy overlay */
    .busy-overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(7,10,20,.6);z-index:9999;}
    .busy-card{background:#0b1020;border:1px solid rgba(0,255,198,.4);border-radius:14px;padding:18px 20px;min-width:300px;box-shadow:0 10px 30px rgba(0,0,0,.35);text-align:center}
    .spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:#00ffc6;border-radius:50%;margin:0 auto 10px;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .busy-title{color:#e5e7eb;font-weight:700;margin-bottom:4px}
    .busy-sub{color:#9ca3af;font-size:12px}
  </style>
</head>
<body>
  <div class="auth-wrap">
    <div class="auth-card" role="form" aria-labelledby="loginTitle">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <h1 id="loginTitle">PowerUp</h1>
      </div>
      <div class="muted">Sign in with your <strong>Employee ID</strong></div>

      <div class="field">
        <label for="empId">Employee ID</label>
        <input id="empId" type="text" placeholder="e.g., IX12345" autocomplete="off" />
      </div>

      <div class="actions">
        <button class="btn primary" id="signin">Sign In</button>
        <button class="btn" id="help">Where do I find this?</button>
      </div>

      <div id="error" class="error" role="alert" aria-live="polite"></div>
      <div class="muted" style="margin-top:10px;">We’ll match your ID in Employee Master and preload your dashboard.</div>
    </div>
  </div>

  <!-- Busy overlay -->
  <div id="busy" class="busy-overlay" aria-hidden="true" aria-live="polite">
    <div class="busy-card">
      <div class="spinner" aria-hidden="true"></div>
      <div class="busy-title" id="busyTitle">Signing you in…</div>
      <div class="busy-sub" id="busySub">Authorizing and warming up your data.</div>
    </div>
  </div>

  <!-- Core libs (no version query strings) -->
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>

  <script>
  (function () {
    const $ = (s) => document.querySelector(s);
    const errBox   = $('#error');
    const empInput = $('#empId');
    const btnSign  = $('#signin');

    const busy     = $('#busy');
    const busyTitle= $('#busyTitle');
    const busySub  = $('#busySub');

    // Clear any stray cached session on the login page itself (belt & suspenders)
    try { sessionStorage.removeItem('pu.sheetCache.v1'); } catch {}
    try { localStorage.removeItem('powerup_session'); } catch {}

    $('#help').addEventListener('click', () => {
      alert("If you don't know your Employee ID number, ask your supervisor or manager and they can provide it to you.");
    });

    function setBusy(on, title, sub) {
      if (title) busyTitle.textContent = title;
      if (sub)   busySub.textContent = sub;
      busy.style.display = on ? 'grid' : 'none';
      busy.setAttribute('aria-hidden', on ? 'false' : 'true');
      btnSign.disabled = !!on;
      empInput.disabled = !!on;
    }

    function showError(msg) {
      errBox.textContent = msg;
      errBox.style.display = 'block';
    }

    // Small helper to prefetch critical sheets so dashboard is hot on first paint
    async function prefetchCriticalSheets() {
      const A = PowerUp.api;
      const keys = [
        A.SHEETS.EMPLOYEE_MASTER,
        A.SHEETS.POWER_HOUR_GOALS,
        A.SHEETS.POWER_HOURS,
        A.SHEETS.CI,
        A.SHEETS.SAFETY,
        A.SHEETS.QUALITY,
        A.SHEETS.LEVEL_TRACKER,
        A.SHEETS.SQUADS,
        A.SHEETS.SQUAD_MEMBERS,
      ];

      // Fetch in 2 waves to show progress (avoids hammering the proxy)
      const wave1 = keys.slice(0, 4);
      const wave2 = keys.slice(4);

      busySub.textContent = 'Loading employee records and core tables…';
      await Promise.all(wave1.map(k => A.getRowsByTitle(k, { force: true }).catch(e => e)));

      busySub.textContent = 'Loading remaining datasets…';
      await Promise.all(wave2.map(k => A.getRowsByTitle(k, { force: true }).catch(e => e)));
    }

    async function doLogin() {
      errBox.style.display = 'none';
      const id = (empInput.value || '').trim();
      if (!id) { showError('Please enter your Employee ID.'); return; }

      setBusy(true, 'Signing you in…', 'Authorizing and warming up your data.');

      try {
        // 1) Create session (no redirect)
        await PowerUp.session.loginWithId(id);

        // 2) Warm the proxy (best effort)
        try {
          const ctrl = new AbortController();
          const t = setTimeout(() => ctrl.abort(), 6000);
          await fetch(PowerUp.api.API_BASE + '/health', { signal: ctrl.signal });
          clearTimeout(t);
        } catch {}

        // 3) Prefetch the sheets so dashboard is hot
        await prefetchCriticalSheets();

        // 4) Navigate only after everything above is done (or best-effort)
        const dest = sessionStorage.getItem('pu.postLoginRedirect') || 'Dashboard-Refresh.html';
        sessionStorage.removeItem('pu.postLoginRedirect');
        setBusy(true, 'Almost there…', 'Opening your dashboard.');
        window.location.assign(dest);
      } catch (e) {
        setBusy(false);
        showError(e?.message || 'Sign-in failed. Please try again.');
      }
    }

    document.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });
    btnSign.addEventListener('click', doLogin);

    // If a session already exists, keep the old UX (go straight in)
    try {
      const s = PowerUp.session.get();
      if (s && s.employeeId) {
        setBusy(true, 'Welcome back…', 'Loading your dashboard.');
        window.location.assign('Dashboard-Refresh.html');
      }
    } catch {}
  }());
  </script>
</body>
</html>
