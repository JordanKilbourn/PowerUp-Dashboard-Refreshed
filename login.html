<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PowerUp — Sign In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="style.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    .auth-wrap { min-height: 100vh; display: grid; place-items: center; background: linear-gradient(180deg,#0f172a,#111827);}
    .auth-card { width: 100%; max-width: 460px; background:#0b1020; border:1px solid #00ffc6; border-radius:16px; padding:28px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .brand { display:flex; align-items:center; gap:10px; margin-bottom:18px;}
    .brand .dot { width:12px; height:12px; border-radius:50%; background:#00ffc6; box-shadow:0 0 16px #00ffc6;}
    .brand h1 { font-size:20px; font-weight:700; letter-spacing:.2px;color:#00ffc6;}
    .muted { color:#94a3b8; font-size:13px; margin-top:2px;}
    .field { margin-top:16px;}
    .field label { display:block; font-size:13px; color:#cbd5e1; margin-bottom:6px;}
    .field input, .modal select, .modal input[type="date"] { width:100%; padding:12px 14px; border-radius:10px; background:#0b1328; border:1px solid #293449; color:#e5e7eb; outline:none;}
    .field input:focus { border-color:#00ffc6; box-shadow:0 0 0 3px rgba(0,255,198,.15);}
    .actions { margin-top:18px; display:flex; gap:10px; align-items:center;}
    .btn { padding:12px 14px; border-radius:10px; border:1px solid #2a354b; background:#111a2f; color:#e5e7eb; cursor:pointer;}
    .btn.primary { background:#FF6600; border-color:#FF6600; color:#111827; font-weight:700;}
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .error { margin-top:14px; color:#fecaca; background:#450a0a; border:1px solid #7f1d1d; padding:10px 12px; border-radius:10px; display:none;}
    .hint { margin-top:10px; font-size:12px; color:#9ca3af;}

    /* Busy overlay (spinner + dynamic status) */
    .busy-overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(7,10,20,.6);z-index:9999;}
    .busy-card{background:#0b1020;border:1px solid rgba(0,255,198,.4);border-radius:14px;padding:18px 20px;min-width:280px;max-width:420px;box-shadow: 0 10px 30px rgba(0,0,0,.35);text-align:center}
    .spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:#00ffc6;border-radius:50%;margin:0 auto 10px;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .busy-title{color:#e5e7eb;font-weight:700;margin-bottom:4px}
    .busy-sub{color:#9ca3af;font-size:12px;min-height:32px;display:flex;align-items:center;justify-content:center;text-align:center;padding:0 6px}

    /* ID Lookup modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9998}
    .modal[aria-hidden="false"]{display:flex}
    .modal-card{background:#0b1020;border:1px solid #294957;border-radius:14px;padding:18px;min-width:320px;max-width:560px;width:92%}
    .modal-card h3{margin:0 0 10px;color:#00ffc6;font-size:18px}
    .modal-row{display:flex;gap:10px;flex-wrap:wrap}
    .modal-row .field{flex:1;margin-top:10px}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:14px}
    .small{font-size:12px;color:#9ca3af}
    .result{margin-top:10px;padding:10px;border-radius:10px;background:#0b1328;border:1px dashed #2a354b;color:#e5e7eb;display:none}
    .result.ok{border-color:#10b981}
    .result.err{border-color:#b91c1c}
  </style>
</head>
<body>
  <div class="auth-wrap">
    <div class="auth-card" role="form" aria-labelledby="loginTitle">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <h1 id="loginTitle">PowerUp</h1>
      </div>
      <div class="muted">Sign in with your <strong>Employee ID</strong></div>

      <div class="field">
        <label for="empId">Employee ID</label>
        <input id="empId" type="text" placeholder="e.g., IX12345" autocomplete="off" />
      </div>

      <div class="actions">
        <button class="btn primary" id="signin">Sign In</button>
        <button class="btn" id="help">Retrieve my Employee ID</button>
      </div>

      <div id="error" class="error" role="alert" aria-live="polite"></div>
      <div class="hint">We’ll match your ID in Employee Master and personalize your dashboard.</div>
    </div>
  </div>

  <!-- Busy overlay -->
  <div id="busy" class="busy-overlay" aria-hidden="true" aria-live="polite">
    <div class="busy-card">
      <div class="spinner" aria-hidden="true"></div>
      <div class="busy-title">Signing you in…</div>
      <div class="busy-sub" id="busySub">Authorizing and loading your data.</div>
    </div>
  </div>

  <!-- ID Lookup modal -->
  <div id="idLookupModal" class="modal" aria-hidden="true" aria-labelledby="idLookupTitle" role="dialog">
    <div class="modal-card">
      <h3 id="idLookupTitle">Find your Employee ID</h3>

      <!-- Inline loading indicator while names load -->
      <div id="lookupLoading" class="small" style="display:none;align-items:center;gap:8px">
        <div class="spinner" style="width:18px;height:18px;border-width:2px"></div>
        <span>Loading employees…</span>
      </div>

      <p class="small">Choose your name, then confirm your hire date. If it matches our records, we’ll reveal your Employee ID.</p>
      <div class="modal-row">
        <div class="field" style="flex:1.6">
          <label for="lookupName">Name</label>
          <select id="lookupName">
            <option value="">Loading…</option>
          </select>
        </div>
        <div class="field" style="flex:1">
          <label for="lookupHire">Hire Date</label>
          <input id="lookupHire" type="date" />
        </div>
      </div>
      <div id="lookupResult" class="result"></div>
      <div class="modal-actions">
        <button class="btn" id="lookupCancel">Close</button>
        <button class="btn primary" id="lookupCheck">Reveal ID</button>
      </div>
    </div>
  </div>

  <!-- Core libs -->
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>

  <script>
  (function () {
    const $ = (s) => document.querySelector(s);

    // ---- Start clean on the login page (belt + suspenders)
    try { window.P && P.api && P.api.clearCache && P.api.clearCache(); } catch {}
    try { sessionStorage.removeItem('pu.sheetCache.v1'); } catch {}
    try { localStorage.removeItem('powerup_session'); } catch {}

    // Non-blocking proxy warm-up + silent prefetch of Employee Master
    (async function warmup() {
      try { await PowerUp.api.warmProxy(); } catch {}
      try {
        const rows = await PowerUp.api.getRowsByTitle('EMPLOYEE_MASTER');
        try { sessionStorage.setItem('pu.cache.EMPLOYEE_MASTER.rows', JSON.stringify(rows)); } catch {}
      } catch {}
    })();

    const empInput      = $('#empId');
    const btnSignIn     = $('#signin');
    const btnHelp       = $('#help');
    const errBox        = $('#error');

    const busy          = $('#busy');
    const busySub       = $('#busySub');

    const modal         = $('#idLookupModal');
    const selName       = $('#lookupName');
    const inpHire       = $('#lookupHire');
    const resBox        = $('#lookupResult');
    const btnCheck      = $('#lookupCheck');
    const btnClose      = $('#lookupCancel');
    const lookupLoading = document.getElementById('lookupLoading');

    let EMP_ROWS = [];

    /* ---------------- Busy overlay helpers + dynamic narration ---------------- */
    let narratorTimer = null;
    let narratorStart = 0;
    let narratorDots  = 0;
    let narratorData  = { attempt: 1 };

    function setBusy(on) {
      if (on) {
        busy.style.display = 'grid';
        busy.setAttribute('aria-hidden', 'false');
        btnSignIn.disabled = true;
        empInput.disabled  = true;
        errBox.style.display = 'none';
      } else {
        busy.style.display = 'none';
        busy.setAttribute('aria-hidden', 'true');
        btnSignIn.disabled = false;
        empInput.disabled  = false;
      }
    }

    function formatElapsed(ms) {
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const r = s % 60;
      return (m ? (m + 'm ') : '') + r + 's';
    }

    function narratorLine() {
      const now = Date.now();
      const elapsed = now - narratorStart;
      const dots = '.'.repeat((narratorDots % 3) + 1);
      narratorDots++;

      // Milestone hints to keep it feeling "alive"
      let hint = 'Contacting server';
      if (elapsed > 10_000)  hint = 'Warming the proxy';
      if (elapsed > 30_000)  hint = 'Priming data sources';
      if (elapsed > 60_000)  hint = 'Smartsheet may still be waking';
      if (elapsed > 90_000)  hint = 'Almost there—still negotiating';

      busySub.textContent =
        `${hint}${dots} • Attempt ${narratorData.attempt} • ${formatElapsed(elapsed)} elapsed`;
    }

    function startNarrator(attempt) {
      narratorData.attempt = attempt || 1;
      narratorStart = Date.now();
      narratorDots  = 0;
      if (narratorTimer) clearInterval(narratorTimer);
      narratorTimer = setInterval(narratorLine, 420); // ~2 updates/sec with dot animation
      narratorLine();
    }
    function bumpNarratorAttempt(attempt) {
      narratorData.attempt = attempt;
      narratorLine();
    }
    function stopNarrator() {
      if (narratorTimer) { clearInterval(narratorTimer); narratorTimer = null; }
    }

    /* ---------------- ID Lookup small helpers ---------------- */
    function showError(msg) { errBox.textContent = msg; errBox.style.display = 'block'; }

    function showLookupLoading(on) {
      if (lookupLoading) lookupLoading.style.display = on ? 'flex' : 'none';
      selName.disabled = !!on;
    }
    const EMP_CACHE_KEY = 'pu.cache.EMPLOYEE_MASTER.rows';

    function getCachedEmployeeRows() {
      const raw = sessionStorage.getItem(EMP_CACHE_KEY);
      if (!raw) return null;
      try { const parsed = JSON.parse(raw); return Array.isArray(parsed) ? parsed : null; }
      catch { try { sessionStorage.removeItem(EMP_CACHE_KEY); } catch {} return null; }
    }
    async function fetchEmployeeRowsFresh() {
      try { return await PowerUp.api.getRowsByTitle('EMPLOYEE_MASTER'); }
      catch { try { await PowerUp.api.warmProxy(); } catch {} return await PowerUp.api.getRowsByTitle('EMPLOYEE_MASTER'); }
    }
    async function ensureEmployeeRows() {
      if (EMP_ROWS.length) return;
      showLookupLoading(true);
      try {
        let rows = getCachedEmployeeRows();
        if (!rows) {
          rows = await fetchEmployeeRowsFresh();
          try { sessionStorage.setItem(EMP_CACHE_KEY, JSON.stringify(rows)); } catch {}
        }
        EMP_ROWS = rows.filter(r =>
          (r['Display Name'] || r['Employee Name'] || r['Name']) &&
          (r['Position ID'] || r['Employee ID'])
        );
        const opts = ['<option value="">Select your name…</option>'].concat(
          EMP_ROWS
            .map(r => ({
              id: (r['Position ID'] || r['Employee ID']).toString().trim(),
              name: (r['Display Name'] || r['Employee Name'] || r['Name']).toString().trim(),
            }))
            .sort((a,b) => a.name.localeCompare(b.name))
            .map(o => `<option value="${o.id}">${o.name}</option>`)
        );
        selName.innerHTML = opts.join('');
      } finally {
        showLookupLoading(false);
      }
    }

    function toISODateOnly(v) {
      if (!v) return '';
      const d = new Date(v);
      return isNaN(d) ? '' : d.toISOString().slice(0,10);
    }
    function openLookup({ loading = false } = {}) {
      resBox.style.display = 'none';
      resBox.className = 'result';
      inpHire.value = '';
      modal.setAttribute('aria-hidden','false');
      modal.style.display = 'flex';
      showLookupLoading(loading);
    }
    function closeLookup() {
      modal.setAttribute('aria-hidden','true');
      modal.style.display = 'none';
    }
    function showLookupResult(ok, html) {
      resBox.className = 'result ' + (ok ? 'ok' : 'err');
      resBox.innerHTML = html;
      resBox.style.display = 'block';
    }
    function findRowById(id) {
      const idLC = String(id || '').trim().toLowerCase();
      return EMP_ROWS.find(r => String(r['Position ID'] || r['Employee ID']).trim().toLowerCase() === idLC);
    }

    /* ---------------- Login with resilient loop + dynamic status ---------------- */
    async function doLoginLoop(id, overallMs) {
      setBusy(true);
      startNarrator(1);

      const deadline = Date.now() + (overallMs || 120000); // default 2 minutes
      let attempt = 0;

      while (Date.now() < deadline) {
        attempt++;
        bumpNarratorAttempt(attempt);

        // Try to warm the proxy occasionally in the loop (cheap GETs)
        if (attempt === 1 || attempt % 3 === 0) {
          try { await PowerUp.api.warmProxy(); } catch {}
        }

        try {
          await PowerUp.session.loginWithId(id, { primeBeforeRedirect: true });
          // If successful, loginWithId will redirect; just return in case it doesn't
          stopNarrator();
          return;
        } catch (e) {
          // compute a small backoff with jitter (caps at ~5s)
          const base = Math.min(5000, 600 * attempt);
          const jitter = Math.floor(Math.random() * 600);
          const wait = Math.max(800, base + jitter);

          // keep the narrator “alive” during wait
          const until = Math.min(Date.now() + wait, deadline);
          while (Date.now() < until) {
            await new Promise(r => setTimeout(r, 350));
            // narratorLine() is already ticking; we just let it update
          }
        }
      }

      // If we fall through, we hit the cap; show a single friendly message
      stopNarrator();
      busySub.textContent = 'The server is still waking up. Please try again in a moment.';
      setBusy(false);
      showError('The server is still waking up. Please try again in a moment.');
    }

    async function doLogin() {
      errBox.style.display = 'none';
      const id = (empInput.value || '').trim();
      if (!id) { showError('Please enter your Employee ID.'); return; }

      // Kick off the loop with a 2-minute cap
      doLoginLoop(id, 120000);
    }

    /* ---------------- ID Lookup modal wiring ---------------- */
    btnHelp.addEventListener('click', async () => {
      openLookup({ loading: true });
      btnHelp.disabled = true;
      try {
        await ensureEmployeeRows();
        if (!EMP_ROWS.length) {
          showLookupResult(false, 'We couldn’t load the employee list. Please try again in a moment.');
        }
      } catch {
        showLookupResult(false, 'We couldn’t load the employee list. Please try again in a moment.');
      } finally {
        btnHelp.disabled = false;
        showLookupLoading(false);
      }
    });

    btnCheck.addEventListener('click', () => {
      const id = selName.value;
      const row = findRowById(id);
      const picked = inpHire.value; // yyyy-mm-dd
      if (!row || !picked) {
        showLookupResult(false, 'Please choose your name and enter your hire date.');
        return;
      }
      const hireRaw = row['Hire Date'] || row['HireDate'] || row['Start Date'];
      const hireISO = toISODateOnly(hireRaw);
      if (hireISO && hireISO === picked) {
        const safeName = (row['Display Name'] || row['Employee Name'] || row['Name'] || '').toString();
        const empId = (row['Position ID'] || row['Employee ID']).toString();
        showLookupResult(true, `
          <div><b>${safeName}</b></div>
          <div class="small" style="margin-top:4px">Your Employee ID is:</div>
          <div style="font-size:18px;margin-top:4px"><code>${empId}</code></div>
          <div style="margin-top:10px">
            <button class="btn primary" id="useFoundId">Use this ID</button>
          </div>
        `);
        setTimeout(() => {
          const useBtn = document.getElementById('useFoundId');
          if (useBtn) useBtn.onclick = () => {
            document.getElementById('empId').value = empId;
            closeLookup();
            document.getElementById('empId').focus();
          };
        }, 0);
      } else {
        showLookupResult(false, 'That hire date doesn’t match our records for the selected name.');
      }
    });

    btnClose.addEventListener('click', (e) => { e.preventDefault(); closeLookup(); });
    modal.addEventListener('click', (e) => { if (e.target === modal) closeLookup(); });

    /* ---------------- Login wiring ---------------- */
    document.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });
    btnSignIn.addEventListener('click', doLogin);
  }());
  </script>
</body>
</html>
