<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Squad</title>
  <link rel="stylesheet" href="style.css" />
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/squad-member-form.js"></script>
</head>

<body>
  <div id="addSquadModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h2>Create New Squad</h2>

      <form id="addSquadForm">
        <label for="squadName">Squad Name</label>
        <input type="text" id="squadName" name="squadName" placeholder="e.g., Power Innovators" required />

        <label for="category">Category</label>
        <input type="text" id="category" name="category" placeholder="e.g., Engineering" required />

        <label for="objective">Objective</label>
        <textarea id="objective" name="objective" placeholder="Squad mission or focus" required></textarea>

        <label for="squadLeader">Squad Leader</label>
        <select id="squadLeader" name="squadLeader" required>
          <option value="">Loading employees...</option>
        </select>

        <label for="activeStatus">Active Status</label>
        <select id="activeStatus" name="activeStatus" required>
          <option value="true" selected>Active</option>
          <option value="false">Inactive</option>
        </select>

        <button type="submit" id="createSquadBtn">Create Squad</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const modal = document.getElementById("addSquadModal");
      const closeBtn = document.getElementById("closeModal");
      const form = document.getElementById("addSquadForm");
      const leaderSelect = document.getElementById("squadLeader");
      let employees = [];

      // --- open modal helper (for future integration with button click)
      window.openAddSquadModal = async function() {
        modal.style.display = "block";
        await populateLeaderDropdown();
      };

      closeBtn.onclick = () => (modal.style.display = "none");

      async function populateLeaderDropdown() {
        try {
          const rows = await PowerUp.api.getRowsByTitle("EMPLOYEE_MASTER");
          employees = rows
            .map(r => ({
              id: r["Employee ID"] || r["Position ID"] || "",
              name: r["Display Name"] || r["Employee Name"] || ""
            }))
            .filter(e => e.id && e.name)
            .sort((a, b) => a.name.localeCompare(b.name));

          leaderSelect.innerHTML =
            '<option value="">Select a leader...</option>' +
            employees.map(e => `<option value="${e.id}">${e.name}</option>`).join("");
        } catch (err) {
          console.error("Error loading employees:", err);
          leaderSelect.innerHTML = '<option value="">Error loading list</option>';
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = {
          squadName: form.squadName.value.trim(),
          category: form.category.value.trim(),
          objective: form.objective.value.trim(),
          leaderId: form.squadLeader.value,
          active: form.activeStatus.value === "true"
        };

        if (!formData.leaderId) {
          alert("Please select a squad leader before creating the squad.");
          return;
        }

        const leader = employees.find(e => e.id === formData.leaderId);
        const session = JSON.parse(sessionStorage.getItem("pu.session") || "{}");

        try {
          // --- 1️⃣ Add the Squad row
          const squadRow = {
            "Squad Name": formData.squadName,
            "Category": formData.category,
            "Objective": formData.objective,
            "Active": formData.active,
            "Created Date": new Date().toISOString(),
            "Created By": session.name || "Preview User"
          };
          const squadRes = await PowerUp.api.addRows(PowerUp.api.SHEETS.SQUADS, [squadRow]);
          const newSquadId =
            squadRes?.[0]?.id || squadRes?.[0]?.rowNumber || squadRes?.result?.[0]?.id || "Unknown";

          // --- 2️⃣ Add the Leader as a Squad Member
          const leaderRow = {
            "Squad ID": newSquadId,
            "Employee ID": leader.id,
            "Role": "Leader",
            "Active": true,
            "Start Date": new Date().toISOString(),
            "Created By": session.name || "Preview User"
          };
          await PowerUp.api.addRows(PowerUp.api.SHEETS.SQUAD_MEMBERS, [leaderRow]);

          alert("✅ Squad and leader successfully created!");
          modal.style.display = "none";
          form.reset();
        } catch (err) {
          console.error("Error creating squad:", err);
          alert("❌ Error creating squad. Check console for details.");
        }
      });

      // preload once on page load for smoother UX
      await populateLeaderDropdown();
    });
  </script>
</body>
</html>
