<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Squad</title>
  <link rel="stylesheet" href="style.css" />
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/squad-member-form.js"></script>
</head>

<body>
  <div id="addSquadModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h2>Create New Squad</h2>

      <form id="addSquadForm">
        <label for="squadName">Squad Name</label>
        <input type="text" id="squadName" name="squadName" placeholder="e.g., Power Innovators" required />

        <label for="category">Category</label>
        <input type="text" id="category" name="category" placeholder="e.g., Engineering" required />

        <label for="objective">Objective</label>
        <textarea id="objective" name="objective" placeholder="Squad mission or focus" required></textarea>

        <label for="squadLeader">Squad Leader</label>
        <select id="squadLeader" name="squadLeader" required>
          <option value="">Loading employees...</option>
        </select>

        <label for="activeStatus">Active Status</label>
        <select id="activeStatus" name="activeStatus" required>
          <option value="true" selected>Active</option>
          <option value="false">Inactive</option>
        </select>

        <button type="submit" id="createSquadBtn">Create Squad</button>
      </form>
    </div>
  </div>

 <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const modal = document.getElementById("addSquadModal");
    const closeBtn = document.getElementById("closeModal");
    const form = document.getElementById("addSquadForm");
    const leaderSelect = document.getElementById("squadLeader");

    const P = window.PowerUp || {};
    const { api, squadForm } = P;

    async function ensureEmployeesForSquad() {
      // Use the same ensureEmployees from squad-member-form.js if available
      if (P.squadForm && typeof P.squadForm.open === "function") {
        // Extract its internal state if already loaded
        try {
          const rows = await api.getRowsByTitle('EMPLOYEE_MASTER');
          const employees = rows.map(r => ({
            id: r["Employee ID"] || r["Position ID"] || r["ID"] || "",
            name: r["Display Name"] || r["Employee Name"] || r["Name"] || ""
          })).filter(e => e.id && e.name)
            .sort((a, b) => a.name.localeCompare(b.name));

          leaderSelect.innerHTML =
            '<option value="">Select a leader...</option>' +
            employees.map(e => `<option value="${e.id}">${e.name}</option>`).join("");
          return employees;
        } catch (err) {
          console.error("Failed to load employees:", err);
          leaderSelect.innerHTML = '<option value="">Error loading employees</option>';
          return [];
        }
      }
    }

    // Wait until PowerUp API is ready
    try {
      await P.api.ready();
    } catch {
      console.warn("PowerUp API not ready yet, continuing anyway");
    }

    let employees = await ensureEmployeesForSquad();

    closeBtn.onclick = () => (modal.style.display = "none");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = {
        squadName: form.squadName.value.trim(),
        category: form.category.value.trim(),
        objective: form.objective.value.trim(),
        leaderId: form.squadLeader.value,
        active: form.activeStatus.value === "true"
      };

      if (!formData.leaderId) {
        alert("Please select a squad leader before creating the squad.");
        return;
      }

      const leader = employees.find(e => e.id === formData.leaderId);
      const session = JSON.parse(sessionStorage.getItem("pu.session") || "{}");

      try {
        const squadRow = {
          "Squad Name": formData.squadName,
          "Category": formData.category,
          "Objective": formData.objective,
          "Active": formData.active,
          "Created Date": new Date().toISOString(),
          "Created By": session.name || "Preview User"
        };
        const squadRes = await P.addSquad(squadRow);
        const newSquadId = squadRes?.[0]?.id || squadRes?.[0]?.rowNumber || "Unknown";

        const leaderRow = {
          "Squad ID": newSquadId,
          "Employee ID": leader.id,
          "Employee Name": leader.name,
          "Role": "Leader",
          "Active": true,
          "Start Date": new Date().toISOString(),
          "Created By": session.name || "Preview User"
        };
        await P.addSquadMember(leaderRow);

        alert("✅ Squad and leader successfully created!");
        modal.style.display = "none";
        form.reset();
      } catch (err) {
        console.error("Error creating squad:", err);
        alert("❌ Error creating squad. Check console for details.");
      }
    });
  });
</script>

</body>
</html>

