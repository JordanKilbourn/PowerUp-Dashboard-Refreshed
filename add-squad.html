<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PowerUp - Add New Squad</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="style.css">
  <script src="scripts/api.js"></script>
  <script src="scripts/session.js"></script>
  <script src="scripts/squad-member-form.js"></script>

  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #1a1a2e;
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .main-content {
      padding: 30px;
      box-sizing: border-box;
      max-width: 800px;
      margin: 0 auto;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      padding-bottom: 15px;
    }
    .page-header h1 {
      color: #00f08e;
      font-size: 28px;
      font-weight: 700;
      margin: 0;
    }
    .form-panel {
      background-color: #16213e;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #b0b0b0;
      font-size: 15px;
      font-weight: 600;
    }
    .form-group input[type="text"],
    .form-group select,
    .form-group textarea {
      width: calc(100% - 20px);
      padding: 10px;
      background-color: #2a3b5b;
      border: 1px solid #0f4c75;
      border-radius: 5px;
      color: #e0e0e0;
      font-size: 16px;
      box-sizing: border-box;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #00f08e;
      box-shadow: 0 0 0 3px rgba(0,240,142,0.2);
    }
    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 30px;
    }
    .submit-button, .cancel-button {
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    .submit-button {
      background-color: #00f08e;
      color: #1a1a2e;
    }
    .submit-button:hover { background-color: #99ffcc; }
    .cancel-button {
      background-color: #555;
      color: white;
    }
    .cancel-button:hover { background-color: #777; }
  </style>
</head>

<body>
  <div class="main-content">
    <div class="page-header">
      <h1>Add New Squad</h1>
      <a href="squads.html" class="cancel-button">Back to Squads</a>
    </div>

    <div class="form-panel">
      <form id="addSquadForm">
        <div class="form-group">
          <label for="squadName">Squad Name</label>
          <input type="text" id="squadName" name="squadName" placeholder="e.g., CI Automation Team" required>
        </div>

        <div class="form-group">
          <label for="squadCategory">Category</label>
          <select id="squadCategory" name="squadCategory" required>
            <option value="">-- Select Category --</option>
            <option value="ci">Continuous Improvement (CI)</option>
            <option value="quality">Quality</option>
            <option value="safety">Safety</option>
          </select>
        </div>

        <div class="form-group">
          <label for="squadLeader">Squad Leader</label>
          <select id="squadLeader" name="squadLeader" required>
            <option value="">Loading employees...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="squadObjective">Objective / Focus</label>
          <textarea id="squadObjective" name="squadObjective" placeholder="Briefly describe the squad's purpose" required></textarea>
        </div>

        <div class="form-group">
          <label for="activeStatus">Active Status</label>
          <select id="activeStatus" name="activeStatus" required>
            <option value="true" selected>Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>

        <div class="button-group">
          <button type="button" class="cancel-button" onclick="location.href='squads.html'">Cancel</button>
          <button type="submit" class="submit-button">Create Squad</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const form = document.getElementById("addSquadForm");
      const leaderSelect = document.getElementById("squadLeader");

      await PowerUp.session.requireLogin();

      // Wait for PowerUp API to be ready before doing anything
      try {
        await PowerUp.api.ready();
      } catch (err) {
        console.warn("PowerUp API not ready, retrying anyway:", err);
      }

      async function populateLeaderDropdown() {
        try {
          const rows = await PowerUp.api.getRowsByTitle("EMPLOYEE_MASTER");
          const employees = rows.map(r => ({
            id: r["Employee ID"] || r["Position ID"] || "",
            name: r["Display Name"] || r["Employee Name"] || ""
          })).filter(e => e.id && e.name)
            .sort((a, b) => a.name.localeCompare(b.name));

          leaderSelect.innerHTML =
            '<option value="">Select a leader...</option>' +
            employees.map(e => `<option value="${e.id}">${e.name}</option>`).join("");

          return employees;
        } catch (err) {
          console.error("Error loading employees:", err);
          leaderSelect.innerHTML = '<option value="">Error loading employees</option>';
          return [];
        }
      }

      const employees = await populateLeaderDropdown();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const data = {
          name: form.squadName.value.trim(),
          category: form.squadCategory.value,
          leaderId: form.squadLeader.value,
          objective: form.squadObjective.value.trim(),
          active: form.activeStatus.value === "true"
        };

        if (!data.leaderId) {
          alert("Please select a Squad Leader before continuing.");
          return;
        }

        const leader = employees.find(e => e.id === data.leaderId);
        const session = JSON.parse(sessionStorage.getItem("pu.session") || "{}");

        try {
          // 1️⃣ Add squad to PowerUp Squads Smartsheet
          const squadRow = {
            "Squad Name": data.name,
            "Category": data.category,
            "Objective": data.objective,
            "Active": data.active,
            "Created Date": new Date().toISOString(),
            "Created By": session.name || "Preview User"
          };
          const squadRes = await PowerUp.api.addRows(PowerUp.api.SHEETS.SQUADS, [squadRow]);
          const newSquadId = squadRes?.[0]?.id || squadRes?.[0]?.rowNumber || "Unknown";

          // 2️⃣ Add leader to PowerUp Squad Members Smartsheet
          const leaderRow = {
            "Squad ID": newSquadId,
            "Employee ID": leader.id,
            "Employee Name": leader.name,
            "Role": "Leader",
            "Active": true,
            "Start Date": new Date().toISOString(),
            "Created By": session.name || "Preview User"
          };
          await PowerUp.api.addRows(PowerUp.api.SHEETS.SQUAD_MEMBERS, [leaderRow]);

          alert("✅ Squad created successfully!");
          form.reset();
          window.location.href = "squads.html";
        } catch (err) {
          console.error("Error creating squad:", err);
          alert("❌ Error creating squad. Check console for details.");
        }
      });
    });
  </script>
</body>
</html>
